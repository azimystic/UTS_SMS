@using UTS_SMS.Models
@model UTS_SMS.ViewModels.ClassWiseReportsViewModel
@{
    Layout = null;
    ViewData["Title"] = "Class Report - " + Model.SelectedClass?.Name + " " + Model.SelectedSection?.Name;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" /> 
    <style>
        @@media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .no-print {
                display: none;
            }

            .print-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-white p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    @if (!string.IsNullOrEmpty(Model.Campus?.Logo))
                    {
                        <img src="@Url.Content($"~/{Model.Campus.Logo}")"
                             alt="@Model.Campus.Name Logo"
                             class="h-16 w-16 rounded-full object-cover" />
                    }
                    <div>
                        <h1 class="text-3xl font-bold text-primary-800">@Model.Campus?.Name</h1>
                        <p class="text-neutral-600">Class-wise Exam Reports</p>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.StudentReports?.Any() == true)
        {
            <!-- Report Title -->
            <div class="bg-white p-4 mb-6 border border-primary-200">
                <h2 class="text-xl font-bold text-center text-primary-800">
                    Class @Model.SelectedClass?.Name - Section @Model.SelectedSection?.Name
                </h2>
                <p class="text-center text-neutral-600 mt-1">
                    @Model.SelectedExam?.ExamCategory?.Name - @Model.SelectedExam?.Name
                </p>
                <p class="text-center text-sm text-neutral-500">
                    Academic Session @DateTime.Now.Year
                </p>
            </div>

            <!-- Results Table -->
            <div class="bg-white overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-neutral-100">
                            <tr>
                                <th rowspan="2" class="border px-3 py-3 text-left font-semibold text-neutral-700">Pos.</th>
                                <th rowspan="2" class="border px-3 py-3 text-left font-semibold text-neutral-700">Student Name</th>
                                <th rowspan="2" class="border px-3 py-3 text-left font-semibold text-neutral-700">Father Name</th>
                                @foreach (var subject in Model.AllSubjects)
                                {
                                    <th class="border px-2 py-1 text-center font-semibold text-neutral-700 text-xs">@subject.Name</th>
                                }
                                <th rowspan="2" class="border px-3 py-3 text-center font-semibold text-neutral-700">Total</th>
                                <th rowspan="2" class="border px-3 py-3 text-center font-semibold text-neutral-700">Obtained</th>
                                <th rowspan="2" class="border px-3 py-3 text-center font-semibold text-neutral-700">%</th>
                                <th rowspan="2" class="border px-3 py-3 text-center font-semibold text-neutral-700">Grade</th>
                                <th rowspan="2" class="border px-3 py-3 text-center font-semibold text-neutral-700">Status</th>
                            </tr>
                            <tr class="bg-neutral-50">
                                @foreach (var subject in Model.AllSubjects)
                                {
                                    <th class="border px-2 py-1 text-center font-semibold text-neutral-600 text-xs">Marks</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int position = 1;
                            }
                            @foreach (var student in Model.StudentReports.OrderBy(s => s.Position ?? int.MaxValue))
                            {
                                <tr class="@(position % 2 == 0 ? "bg-neutral-50" : "bg-white")">
                                    <td class="border px-3 py-3 text-center font-bold">
                                        @if (student.Position.HasValue)
                                        {
                                            <span>@student.Position</span>
                                        }
                                        else
                                        {
                                            <span class="text-neutral-400">-</span>
                                        }
                                    </td>
                                    <td class="border px-3 py-3 font-medium text-primary-800">@student.StudentName</td>
                                    <td class="border px-3 py-3 text-neutral-700">@student.FatherName</td>
                                    @foreach (var subject in Model.AllSubjects)
                                    {
                                        var subjectMark = student.SubjectMarks.FirstOrDefault(sm => sm.SubjectName == subject.Name);
                                        <td class="border px-2 py-3 text-center text-xs">
                                            @if (subjectMark != null)
                                            {
                                                @if (!subjectMark.IsEnrolled)
                                                {
                                                    <span class="text-neutral-500 font-semibold">NE</span>
                                                }
                                                else if (subjectMark.HasEntry)
                                                {
                                                    <span class="@(subjectMark.ObtainedMarks >= (subjectMark.TotalMarks * 0.33m) ? "text-success" : "text-error") font-semibold">
                                                        @subjectMark.ObtainedMarks
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-error font-semibold">0</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-neutral-400">-</span>
                                            }
                                        </td>
                                    }
                                    <td class="border px-3 py-3 text-center font-semibold">@student.TotalMarks</td>
                                    <td class="border px-3 py-3 text-center font-semibold text-primary-600">@student.TotalObtained</td>
                                    <td class="border px-3 py-3 text-center font-bold @(student.Percentage >= 33 ? "text-success" : "text-error")">
                                        @student.Percentage%
                                    </td>
                                    <td class="border px-3 py-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-semibold @GetGradeColorClass(student.Grade)">
                                            @student.Grade
                                        </span>
                                    </td>
                                    <td class="border px-3 py-3 text-center">
                                        <span class="px-2 py-1 rounded text-xs font-semibold @GetStatusColorClass(student.Status)">
                                            @student.Status
                                        </span>
                                    </td>
                                </tr>
                                position++;
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Class Statistics Summary -->
                <div class="p-6 bg-neutral-50 border-t">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-sm text-neutral-600">Highest Percentage</p>
                            <p class="text-xl font-bold text-success">@Math.Round(Model.HighestPercentage, 1)%</p>
                        </div>
                        <div>
                            <p class="text-sm text-neutral-600">Lowest Percentage</p>
                            <p class="text-xl font-bold text-error">@Math.Round(Model.LowestPercentage, 1)%</p>
                        </div>
                        <div>
                            <p class="text-sm text-neutral-600">Class Average</p>
                            <p class="text-xl font-bold text-primary-600">@Math.Round(Model.ClassAverage, 1)%</p>
                        </div>
                        <div>
                            <p class="text-sm text-neutral-600">Pass Percentage</p>
                            <p class="text-xl font-bold text-primary-600">@Math.Round(Model.PassPercentage, 1)%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Print Footer -->
            <div class="mt-8 pt-4 border-t border-primary-200">
                <div class="flex justify-between items-end">
                    <div class="text-left">
                        <div class="border-t border-gray-400 w-48 mb-2"></div>
                        <p class="text-sm text-neutral-600">Class Teacher</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-neutral-600">Report Generated: @DateTime.Now.ToString("dd MMMM yyyy hh:mm tt")</p>
                        <p class="text-xs text-neutral-500 mt-1">Total Students: @Model.StudentReports.Count</p>
                    </div>
                    <div class="text-right">
                        <div class="border-t border-gray-400 w-48 mb-2"></div>
                        <p class="text-sm text-neutral-600">Principal</p>
                    </div>
                </div>
            </div>
        }
    </div>

    <script>
        window.onload = function() {
            setTimeout(() => { window.print(); }, 500);
        };
    </script>
</body>
</html>

@functions {
    public string GetGradeColorClass(string grade)
    {
        return grade switch
        {
            "A+" => "bg-success-light text-success",
            "A" => "bg-success-light text-success",
            "B+" => "bg-primary-100 text-primary-800",
            "B" => "bg-primary-100 text-blue-700",
            "C" => "bg-warning-light text-yellow-800",
            "D" => "bg-orange-100 text-orange-800",
            "E" => "bg-purple-100 text-purple-800",
            "F" => "bg-error-light text-error",
            _ => "bg-neutral-100 text-primary-800"
        };
    }

    public string GetStatusColorClass(string status)
    {
        return status switch
        {
            "Pass" => "bg-success-light text-success",
            "Fail" => "bg-error-light text-error",
            _ => "bg-neutral-100 text-primary-800"
        };
    }
}

@using UTS_SMS.Models
@model IEnumerable<UTS_SMS.Models.Asset>

@{
    ViewData["Title"] = "Assets";
    var campusList = ViewBag.Campuses as IEnumerable<dynamic>;
}

<div class="min-h-screen bg-neutral-50 p-3 md:p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-primary-800 mb-3 md:mb-0">School Assets</h1>
        <a asp-action="Create" class="bg-gradient-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-sms-md text-sm md:text-base">
            Add New Asset
        </a>
    </div>

    <!-- Mobile Filter Button -->
    <div class="md:hidden mb-4">
        <button id="mobile-filter-toggle" class="w-full bg-gradient-primary text-white py-2 px-4 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            Filter Assets
        </button>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="bg-white p-4 md:p-6 rounded-lg shadow-sm mb-6 hidden md:block">
        <form id="filter-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
            @if (campusList?.Count() > 1)
            {
                <div>
                    <label for="campus-filter" class="block text-sm font-medium text-neutral-700 mb-1">Campus</label>
                    <select id="campus-filter" name="campusFilter" class="w-full px-3 py-2 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400 text-sm">
                        <option value="">All Campuses</option>
                        @foreach (var campus in campusList)
                        {
                            <option value="@campus.Id">@campus.Name</option>
                        }
                    </select>
                </div>
            }
            <div>
                <label for="name-filter" class="block text-sm font-medium text-neutral-700 mb-1">Asset Name</label>
                <input type="text" id="name-filter" name="nameFilter" 
                       class="w-full px-3 py-2 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400 text-sm" 
                       placeholder="Search by name">
            </div>
            <div>
                <label for="category-filter" class="block text-sm font-medium text-neutral-700 mb-1">Category</label>
                <input type="text" id="category-filter" name="categoryFilter" 
                       class="w-full px-3 py-2 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400 text-sm" 
                       placeholder="Search by category">
            </div>
            <div class="flex items-end">
                <button type="button" onclick="filterAssets()" 
                        class="w-full bg-gradient-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                    Search
                </button>
            </div>
            <div class="flex items-end">
                <button type="button" onclick="clearFilters()" 
                        class="w-full bg-neutral-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                    Clear
                </button>
            </div>
        </form>
    </div>

    <!-- Assets Cards/Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full">
                <thead class="bg-neutral-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Asset Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Category</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Purchase Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Account</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Campus</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-primary-100" id="asset-table-body">
                    @foreach (var asset in Model)
                    {
                        <tr class="hover:bg-neutral-50 asset-row" 
                            data-campus-id="@asset.CampusId" 
                            data-name="@asset.Name.ToLower()"
                            data-category="@(asset.Category?.ToLower() ?? "")">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-primary-800">@asset.Name</div>
                                @if (!string.IsNullOrEmpty(asset.SerialNumber))
                                {
                                    <div class="text-sm text-neutral-500">SN: @asset.SerialNumber</div>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (!string.IsNullOrEmpty(asset.Category))
                                {
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                        @asset.Category
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-800">@asset.Price.ToString("C")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@asset.PurchaseDate.ToString("MMM dd, yyyy")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@(asset.Account?.AccountTitle ?? "N/A")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@asset.Campus?.Name</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a asp-action="Details" asp-route-id="@asset.Id" 
                                       class="text-primary-600 hover:text-primary-800 transition-colors duration-300">Details</a>
                                    <a asp-action="Edit" asp-route-id="@asset.Id" 
                                       class="text-info hover:text-indigo-900 transition-colors duration-300">Edit</a>
                                    <button type="button" onclick="deleteAsset(@asset.Id, '@asset.Name')" 
                                            class="text-error hover:text-error transition-colors duration-300">Delete</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden space-y-4 p-4" id="asset-cards">
            @foreach (var asset in Model)
            {
                <div class="asset-card bg-white border border-primary-100 rounded-lg p-4 shadow-sm" 
                     data-campus-id="@asset.CampusId" 
                     data-name="@asset.Name.ToLower()"
                     data-category="@(asset.Category?.ToLower() ?? "")">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-primary-800">@asset.Name</h3>
                            @if (!string.IsNullOrEmpty(asset.SerialNumber))
                            {
                                <p class="text-sm text-neutral-500">SN: @asset.SerialNumber</p>
                            }
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-semibold text-success">@asset.Price.ToString("C")</div>
                            @if (!string.IsNullOrEmpty(asset.Category))
                            {
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                    @asset.Category
                                </span>
                            }
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="text-sm text-neutral-600">
                            <span class="font-medium">Purchase Date:</span> @asset.PurchaseDate.ToString("MMM dd, yyyy")
                        </div>
                        <div class="text-sm text-neutral-600">
                            <span class="font-medium">Account:</span> @(asset.Account?.AccountTitle ?? "N/A")
                        </div>
                        <div class="text-sm text-neutral-600">
                            <span class="font-medium">Campus:</span> @asset.Campus?.Name
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <a asp-action="Details" asp-route-id="@asset.Id" 
                           class="flex-1 bg-gradient-primary hover:bg-primary-700 text-white text-center py-2 px-4 rounded-lg text-sm transition-all duration-300">
                            Details
                        </a>
                        <a asp-action="Edit" asp-route-id="@asset.Id" 
                           class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-center py-2 px-4 rounded-lg text-sm transition-all duration-300">
                            Edit
                        </a>
                        <button type="button" onclick="deleteAsset(@asset.Id, '@asset.Name')" 
                                class="flex-1 bg-error hover:bg-red-700 text-white text-center py-2 px-4 rounded-lg text-sm transition-all duration-300">
                            Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-sms-lg max-w-sm mx-4">
        <h3 class="text-lg font-medium text-primary-800 mb-4">Confirm Delete</h3>
        <p class="text-sm text-neutral-500 mb-4">Are you sure you want to delete "<span id="assetNameToDelete"></span>"? This action cannot be undone.</p>
        <div class="flex space-x-3">
            <button type="button" onclick="hideDeleteModal()" 
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-primary-800 py-2 px-4 rounded-lg transition-all duration-300">
                Cancel
            </button>
            <form id="deleteForm" method="post" class="flex-1">
                @Html.AntiForgeryToken()
                <button type="submit" 
                        class="w-full bg-error hover:bg-red-700 text-white py-2 px-4 rounded-lg transition-all duration-300">
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Mobile filter toggle
    document.getElementById('mobile-filter-toggle').addEventListener('click', function() {
        const filterPanel = document.getElementById('filter-panel');
        filterPanel.classList.toggle('hidden');
    });

    function filterAssets() {
        const campusFilter = document.getElementById('campus-filter')?.value.toLowerCase() || '';
        const nameFilter = document.getElementById('name-filter').value.toLowerCase();
        const categoryFilter = document.getElementById('category-filter').value.toLowerCase();

        // Filter desktop table rows
        const tableRows = document.querySelectorAll('.asset-row');
        tableRows.forEach(row => {
            const campusId = row.getAttribute('data-campus-id') || '';
            const name = row.getAttribute('data-name') || '';
            const category = row.getAttribute('data-category') || '';
            
            const campusMatch = !campusFilter || campusId === campusFilter;
            const nameMatch = !nameFilter || name.includes(nameFilter);
            const categoryMatch = !categoryFilter || category.includes(categoryFilter);
            
            if (campusMatch && nameMatch && categoryMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter mobile cards
        const cards = document.querySelectorAll('.asset-card');
        cards.forEach(card => {
            const campusId = card.getAttribute('data-campus-id') || '';
            const name = card.getAttribute('data-name') || '';
            const category = card.getAttribute('data-category') || '';
            
            const campusMatch = !campusFilter || campusId === campusFilter;
            const nameMatch = !nameFilter || name.includes(nameFilter);
            const categoryMatch = !categoryFilter || category.includes(categoryFilter);
            
            if (campusMatch && nameMatch && categoryMatch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function clearFilters() {
        if (document.getElementById('campus-filter')) {
            document.getElementById('campus-filter').value = '';
        }
        document.getElementById('name-filter').value = '';
        document.getElementById('category-filter').value = '';
        filterAssets();
    }

    function deleteAsset(id, name) {
        document.getElementById('assetNameToDelete').textContent = name;
        document.getElementById('deleteForm').action = '/Asset/Delete/' + id;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function hideDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideDeleteModal();
        }
    });
</script>

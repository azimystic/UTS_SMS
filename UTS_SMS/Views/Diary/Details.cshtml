@using UTS_SMS.Models
@model Diary

@{
    ViewData["Title"] = "Diary Details";
    var isAdmin = (bool?)ViewBag.IsAdmin ?? false;
    var isTeacher = (bool?)ViewBag.IsTeacher ?? false;
    var isOwner = (bool?)ViewBag.IsOwner ?? false;
}

<div class="min-h-screen bg-gradient-subtle p-2 md:p-4">
    <div class="w-full max-w-[1600px] mx-auto px-1 md:px-2">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-primary-800">Diary Entry</h1>
                <p class="text-neutral-600 mt-2">@Model.Date.ToString("dddd, MMMM dd, yyyy")</p>
            </div>
            <div class="flex space-x-2 mt-4 md:mt-0">
                @if (isAdmin || isOwner)
                {
                    <a asp-action="Edit" asp-route-id="@Model.Id" 
                       class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Edit
                    </a>
                }
                <a asp-action="Index" asp-route-date="@Model.Date.ToString("yyyy-MM-dd")" 
                   class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to List
                </a>
            </div>
        </div>

        <!-- Missing Diary Alert -->
        @{
            var campusOffTime = new TimeOnly(16, 0); // 4:00 PM - Campus off time (can be made configurable later)
            var currentTime = TimeOnly.FromDateTime(DateTime.Now);
            var today = DateTime.Today;
            var isTodayAfterOffTime = DateTime.Now.Date == today && currentTime > campusOffTime;
            
            // Check if there's a diary entry for today for this teacher
            var hasTodayDiary = ViewBag.HasTodayDiary as bool? ?? true; // Default to true if not set
            var teacherId = ViewBag.TeacherId as int? ?? 0;
        }
        
        @if (isTodayAfterOffTime && !hasTodayDiary && (isAdmin || (isTeacher && teacherId > 0)))
        {
            <div class="mb-6 bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-sm font-semibold text-red-800">Missing Diary Entry</h3>
                        <div class="mt-2 text-sm text-red-700">
                            @if (isTeacher)
                            {
                                <p>âš ï¸ You have not entered your diary for today. Please create a diary entry as soon as possible.</p>
                                <a asp-action="Create" asp-route-date="@today.ToString("yyyy-MM-dd")" 
                                   class="mt-3 inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Create Diary Entry
                                </a>
                            }
                            @if (isAdmin)
                            {
                                <p>âš ï¸ The teacher <strong>@Model.TeacherAssignment.Teacher.FullName</strong> has not entered a diary today (after campus off-time at @campusOffTime.ToString("hh:mm tt")).</p>
                                <p class="mt-1 text-xs">Please follow up with the teacher to ensure all diary entries are completed.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Main Content Card -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Content -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sms-xl overflow-hidden">
                    <!-- Subject Header -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <h2 class="text-2xl font-bold mb-2 text-white">@Model.TeacherAssignment.Subject.Name</h2>
                                <div class="flex items-center space-x-4 text-blue-100">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                        <span>Class: @Model.TeacherAssignment.Class.Name - @Model.TeacherAssignment.Section.Name</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span>Teacher: @Model.TeacherAssignment.Teacher.FullName</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-6">
                        <!-- Chapter Info (if linked) -->
                        @if (Model.ChapterId.HasValue && Model.Chapter != null)
                        {
                            <div class="mb-6 p-4 bg-purple-50 border-l-4 border-purple-500 rounded-lg">
                                <div class="flex items-center text-purple-800">
                                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <div>
                                        <span class="font-semibold">Chapter @Model.Chapter.ChapterNumber: @Model.Chapter.Name</span>
                                        @if (Model.ChapterSectionId.HasValue && Model.ChapterSection != null)
                                        {
                                            <span class="ml-2 text-purple-600">â†’ @Model.ChapterSection.Name</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Lesson Summary -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-primary-800 mb-3 flex items-center">
                                <svg class="w-6 h-6 text-success mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                Lesson Summary
                            </h3>
                            <div class="bg-neutral-50 rounded-xl p-4">
                                <p class="text-neutral-700 leading-relaxed">@Model.LessonSummary</p>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.HomeworkGiven))
                        {
                            <!-- Homework -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-primary-800 mb-3 flex items-center">
                                    <svg class="w-6 h-6 text-warning mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                    Homework Assignment
                                </h3>
                                <div class="bg-orange-50 border-l-4 border-orange-400 rounded-xl p-4">
                                    <p class="text-neutral-700 leading-relaxed">@Model.HomeworkGiven</p>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(Model.Notes))
                        {
                            <!-- Additional Notes -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-primary-800 mb-3 flex items-center">
                                    <svg class="w-6 h-6 text-primary-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                    </svg>
                                    Teacher's Notes
                                </h3>
                                <div class="bg-primary-50 rounded-xl p-4">
                                    <p class="text-neutral-700 leading-relaxed">@Model.Notes</p>
                                </div>
                            </div>
                        }

                        <!-- Metadata -->
                        <div class="border-t pt-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-neutral-500">
                                <div>
                                    <span class="font-medium">Created by:</span> @Model.CreatedBy
                                </div>
                                <div>
                                    <span class="font-medium">Created:</span> @Model.CreatedAt.ToString("MMM dd, yyyy at hh:mm tt")
                                </div>
                                @if (Model.ModifiedAt.HasValue)
                                {
                                    <div>
                                        <span class="font-medium">Last modified by:</span> @Model.ModifiedBy
                                    </div>
                                    <div>
                                        <span class="font-medium">Last modified:</span> @Model.ModifiedAt?.ToString("MMM dd, yyyy at hh:mm tt")
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Sidebar for Images and Materials -->
            <div class="lg:col-span-1 space-y-6">
                @if (Model.DiaryImages != null && Model.DiaryImages.Any())
                {
                    <!-- Diary Images -->
                    <div class="bg-white rounded-2xl shadow-sms-xl p-6">
                        <h3 class="text-lg font-semibold text-primary-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 text-info mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2z"></path>
                            </svg>
                            Attached Images (@Model.DiaryImages.Count)
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            @foreach (var image in Model.DiaryImages)
                            {
                                <div class="relative group bg-neutral-100 rounded-lg overflow-hidden">
                                    <!-- Image Preview -->
                                    <div class="aspect-square cursor-pointer" onclick="openImageModal('/@image.ImagePath', '@(image.Description ?? "Diary Image")')">
                                        <img src="/@image.ImagePath" 
                                             alt="@image.Description" 
                                             class="w-full h-full object-cover hover:opacity-90 transition-opacity" 
                                             loading="lazy" />
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center">
                                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Download Button -->
                                    <a href="/@image.ImagePath" 
                                       download="@image.OriginalFileName"
                                       class="absolute bottom-2 right-2 bg-white hover:bg-blue-500 text-gray-700 hover:text-white p-2 rounded-full shadow-lg transition-all duration-200 opacity-0 group-hover:opacity-100"
                                       title="Download Image"
                                       onclick="event.stopPropagation()">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <!-- Material Button -->
                @if (Model.ChapterId.HasValue && Model.Chapter != null)
                {
                    <div class="bg-white rounded-2xl shadow-sms-xl p-6">
                        <h3 class="text-lg font-semibold text-primary-800 mb-4 flex items-center">
                            <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            Academic Material
                        </h3>
                        @if (isAdmin || isTeacher)
                        {
                            <a href="/AcademicMaterial/Chapters/@Model.Chapter.SubjectId?classId=@Model.TeacherAssignment.ClassId" 
                               class="block w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg text-center transition-colors">
                                View Chapter Materials
                            </a>
                        }
                        else
                        {
                            <a href="/AcademicMaterialStudent/ViewChapter/@Model.ChapterId" 
                               class="block w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 px-4 rounded-lg text-center transition-colors">
                                View Chapter Materials
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Image Modal with Enhanced Controls -->
<div id="imageModal" 
     class="fixed inset-0 bg-black bg-opacity-75 hidden z-[9999] flex items-center justify-center p-4" 
     onclick="closeImageModal()">
    <div class="relative w-full h-full max-w-6xl max-h-[80vh] flex items-center justify-center" onclick="event.stopPropagation()">
        <!-- Close Button -->
        <button onclick="closeImageModal()" 
                class="absolute top-2 right-2 text-white hover:text-gray-300 transition-colors z-10 bg-black bg-opacity-70 rounded-full p-3">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- Image Container -->
        <div class="bg-white rounded-lg overflow-hidden shadow-2xl w-full h-full flex flex-col">
            <div class="flex items-center justify-between p-4 border-b bg-gray-50 flex-shrink-0">
                <h3 id="modalImageTitle" class="text-lg font-semibold text-primary-800 truncate flex-1">Image</h3>
                <div class="flex gap-2 ml-4">
                    <a id="modalOpenNewTabBtn" 
                       target="_blank"
                       class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors flex-shrink-0">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Open in New Tab
                    </a>
                    <a id="modalDownloadBtn" 
                       download 
                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition-colors flex-shrink-0">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download
                    </a>
                </div>
            </div>
            <div class="overflow-auto bg-black flex items-center justify-center flex-1">
                <img id="modalImage" 
                     src="" 
                     alt="" 
                     class="max-w-full max-h-full object-contain" 
                     style="image-rendering: auto;" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openImageModal(imagePath, description) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('modalImageTitle');
            const downloadBtn = document.getElementById('modalDownloadBtn');
            const openNewTabBtn = document.getElementById('modalOpenNewTabBtn');
            
            modalImage.src = imagePath;
            modalTitle.textContent = description || 'Diary Image';
            downloadBtn.href = imagePath;
            downloadBtn.download = description || 'diary-image';
            openNewTabBtn.href = imagePath;
            modal.classList.remove('hidden');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
}

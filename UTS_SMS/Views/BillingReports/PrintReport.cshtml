@using UTS_SMS.Models
@model List<UTS_SMS.ViewModels.BillingReportViewModel>

@{
    ViewData["Title"] = "Billing Report";
    Layout = null;
    var startDate = ViewBag.StartDate as DateTime?;
    var endDate = ViewBag.EndDate as DateTime?;
    var campus = ViewBag.Campus as UTS_SMS.Models.Campus;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Billing Report - @(startDate?.ToString("dd MMM yyyy")) to @(endDate?.ToString("dd MMM yyyy"))</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <style>
        /* Base styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 9pt;
            margin: 0.2in;
            padding: 0;
            color: #000;
            line-height: 1.2;
            background: #fff;
        }

        /* Header styling */
        .report-header {
            margin-bottom: 0.1in;
            padding-bottom: 0.05in;
            border-bottom: 1px solid #666;
        }

        .campus-logo {
            margin-top:20px;
            height: 1.5in;
            width: 1.5in;
            object-fit: contain;
        }

        .campus-name {
            font-size: 18pt;
            font-weight: bold;
            margin-bottom: 0.02in;
        }



        .report-title {
            font-size: 11pt;
            font-weight: bold;
            margin: 0.05in 0;
        }

        .report-period {
            font-size: 9pt;
            margin-bottom: 0.05in;
        }

        /* Summary section */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.1in;
            margin-bottom: 0.15in;
        }

        .summary-item {
            border: 1px solid #ccc;
            padding: 0.08in;
            border-radius: 3px;
            background: #f9f9f9;
        }

        .summary-title {
            font-size: 8pt;
            font-weight: bold;
            margin-bottom: 0.03in;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 10pt;
            font-weight: bold;
        }

        .summary-detail {
            font-size: 7pt;
            margin-top: 0.02in;
        }

        /* Table styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.15in;
            page-break-inside: avoid;
        }

            .data-table th {
                background: #e6e6e6;
                border: 1px solid #999;
                padding: 0.05in;
                font-size: 8pt;
                font-weight: bold;
                text-align: left;
            }

            .data-table td {
                border: 1px solid #ccc;
                padding: 0.04in;
                font-size: 8pt;
            }

            .data-table .row-alt {
                background: #f2f2f2;
            }

        .status-badge {
            padding: 0.02in 0.04in;
            border-radius: 2px;
            font-size: 7pt;
            font-weight: bold;
        }

        /* Footer */
        .report-footer {
            margin-top: 0.15in;
            padding-top: 0.05in;
            border-top: 1px solid #666;
            font-size: 8pt;
        }

        /* Print specific styles */
        @@media print {
            body

        {
            margin: 0.1in;
            font-size: 8pt;
        }

        .no-print {
            display: none;
        }

        .print-break {
            page-break-after: always;
        }

        /* Ensure tables don't break across pages awkwardly */
        table {
            page-break-inside: auto;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="report-header">
        <div style="position: relative; text-align: center; margin-bottom: 0.05in;">
            <!-- Logo absolutely at left -->
            @if (!string.IsNullOrEmpty(campus?.Logo))
            {
                <img src="@Url.Content($"~/{campus.Logo}")"
                     alt="@campus.Name Logo"
                     class="campus-logo"
                     style="position: absolute; left: 0; top: 50%; transform: translateY(-50%);" />
            }

            <!-- Centered block in full page -->
            <div>
                <div class="campus-name" style="font-weight: bold; font-size: 14pt;">
                    @(campus?.Name ?? "School Management System")
                </div>

                @if (!string.IsNullOrEmpty(campus?.Address))
                {
                    <div style="font-size: 8pt;">@campus.Address</div>
                }
                @if (!string.IsNullOrEmpty(campus?.Phone))
                {
                    <div style="font-size: 8pt;">Phone: @campus.Phone</div>
                }
            </div>
        </div>




        <div class="report-title" style="text-align: center;">BILLING REPORT</div>
        <div class="report-period" style="text-align: center;">
            Period: @(startDate?.ToString("MMMM yyyy"))
        </div>
    </div>

    <!-- Summary Section -->
    @{
        var totalPayable = Model.Sum(b => b.TotalPayable);
        var totalPaid = Model.Sum(b => b.TotalPaid);
        var totalAdvance = Model.Where(b => b.Balance < 0).Sum(b => Math.Abs(b.Balance));
        var totalDues = Model.Where(b => b.Balance > 0).Sum(b => b.Balance);

        var paidCount = Model.Count(b => b.Status == "Paid");
        var partialCount = Model.Count(b => b.Status == "Partial");
        var advanceCount = Model.Count(b => b.Status == "Advance");
        var notProcessedCount = Model.Count(b => b.Status == "NotProcessed");
    }

    <div class="summary-grid">
        <div class="summary-item">
            <div class="summary-title">Total Students</div>
            <div class="summary-value">@Model.Count</div>
            <div class="summary-detail">
                Paid: @paidCount | Partial: @partialCount<br />
                Advance: @advanceCount | NotProcessed: @notProcessedCount
            </div>
        </div>

        <div class="summary-item">
            <div class="summary-title">Total Payable</div>
            <div class="summary-value">₨@totalPayable.ToString("N0")</div>
        </div>

        <div class="summary-item">
            <div class="summary-title">Amount Paid</div>
            <div class="summary-value">₨@totalPaid.ToString("N0")</div>
        </div>

        <div class="summary-item">
            <div class="summary-title">Advance / Dues</div>
            <div class="summary-value" style="font-size: 9pt;">
                <span style="color: #1a5fb4;">Advance: ₨@totalAdvance.ToString("N0")</span><br />
                <span style="color: #c64600;">Dues: ₨@totalDues.ToString("N0")</span>
            </div>
        </div>
    </div>

    <!-- Students List -->
    <table class="data-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Section</th>
                <th>Father Phone</th>
                <th>Status</th>
                <th style="text-align: right;">Payable</th>
                <th style="text-align: right;">Paid</th>
                <th style="text-align: right;">Balance</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                var item = Model[i];
                <tr class="@(i % 2 == 0 ? "" : "row-alt")">
                    <td>@(i + 1)</td>
                    <td style="font-weight: bold;">@item.Student.StudentName</td>
                    <td>@item.Student.ClassObj?.Name</td>
                    <td>@item.Student.SectionObj?.Name</td>
                    <td>@item.Student.FatherPhone</td>
                    <td>
                        <span class="status-badge
                                @(item.Status == "Paid" ? "background-color: #cce8cc; color: #006400;" :
                                                            item.Status == "Partial" ? "background-color: #fff0cc; color: #8a6900;" :
                                                            item.Status == "Advance" ? "background-color: #cce0ff; color: #00498e;" :
                                                            "background-color: #ffe6e6; color: #990000;")">
                                                                                                       @item.Status
                                                                                                   </span>
                                                                                               </td>
                                                                                               <td style="text-align: right;">₨@item.TotalPayable.ToString("N0")</td>
                                                                                               <td style="text-align: right; color: #006400;">₨@item.TotalPaid.ToString("N0")</td>
                                                                                               <td style="text-align: right;
                            @(item.Balance == 0 ? "color: #006400;" :
                                                  item.Status == "Advance" ? "color: #00498e;" :
                                                  item.Status == "Partial" ? "color: #8a6900;" :
                                                  "color: #990000;")">
                    ₨@Math.Abs(item.Balance).ToString("N0")
                </td>
            </tr>
                        }
        </tbody>
        <tfoot>
            <tr style="background-color: #e6e6e6; font-weight: bold;">
                <td colspan="6" style="text-align: right;">TOTALS:</td>
                <td style="text-align: right;">₨@totalPayable.ToString("N0")</td>
                <td style="text-align: right; color: #006400;">₨@totalPaid.ToString("N0")</td>
                <td style="text-align: right; font-size: 8pt;">
                    <span style="color: #00498e;">Advance: ₨@totalAdvance.ToString("N0")</span><br />
                    <span style="color: #990000;">Dues: ₨@totalDues.ToString("N0")</span>
                </td>
            </tr>
        </tfoot>
    </table>

    <!-- Footer -->
    <div class="report-footer">
        <div style="display: flex; justify-content: space-between;">
            <div>
                <div>Report Generated: @DateTime.Now.ToString("dd MMMM yyyy hh:mm tt")</div>
                <div>Total Records: @Model.Count</div>
            </div>
            <div style="text-align: center;">
                <div style="border-top: 1px solid #000; width: 1.5in; margin: 0 auto 0.03in;"></div>
                <div>Principal / Authorized Signature</div>
            </div>
        </div>
    </div>

    <!-- Print Controls -->
    <div class="no-print" style="text-align: center; margin-top: 0.2in;">
        <button onclick="window.print()" style="background: #2f5e93; color: white; border: none; padding: 0.1in 0.2in; border-radius: 3px; cursor: pointer;">
            Print Report
        </button>
        <button onclick="window.close()" style="background: #666; color: white; border: none; padding: 0.1in 0.2in; border-radius: 3px; cursor: pointer; margin-left: 0.1in;">
            Close
        </button>
    </div>

    <script>
        // Auto print when page loads
        window.onload = function() {
            setTimeout(function() {
                window.print();
            }, 500);
        };
    </script>
</body>
</html>

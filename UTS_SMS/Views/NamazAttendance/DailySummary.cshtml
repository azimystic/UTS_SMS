@model IEnumerable<UTS_SMS.Models.NamazDailySummaryViewModel>

@{
    ViewData["Title"] = "Namaz Attendance Summary";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <div class="border-4 border-dashed border-primary-100 rounded-lg p-8">
            
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-primary-800">Namaz Attendance Summary</h1>
                <p class="mt-2 text-sm text-neutral-600">Daily summary for @ViewBag.Date?.ToString("MMMM dd, yyyy")</p>
            </div>

            <!-- Navigation -->
            <div class="mb-6">
                <a asp-action="Index" asp-route-date="@ViewBag.Date?.ToString("yyyy-MM-dd")" 
                   class="inline-flex items-center px-4 py-2 border border-primary-200 text-sm font-medium rounded-md text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    ← Back to Attendance
                </a>
            </div>

            <!-- Date Navigation -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <a asp-action="DailySummary" asp-route-date="@(((DateTime)ViewBag.Date).AddDays(-1).ToString("yyyy-MM-dd"))" 
                       class="inline-flex items-center px-3 py-2 border border-primary-200 shadow-sm text-sm leading-4 font-medium rounded-md text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        ← Previous Day
                    </a>
                    
                    <h2 class="text-xl font-semibold text-primary-800">
                        @ViewBag.Date?.ToString("dddd, MMMM dd, yyyy")
                    </h2>
                    
                    @if (ViewBag.Date != ViewBag.Today)
                    {
                        <a asp-action="DailySummary" asp-route-date="@(((DateTime)ViewBag.Date).AddDays(1).ToString("yyyy-MM-dd"))" 
                           class="inline-flex items-center px-3 py-2 border border-primary-200 shadow-sm text-sm leading-4 font-medium rounded-md text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Next Day →
                        </a>
                    }
                </div>
                
                @if (ViewBag.Date != ViewBag.Today)
                {
                    <a asp-action="DailySummary" asp-route-date="@ViewBag.Today?.ToString("yyyy-MM-dd")" 
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Today
                    </a>
                }
            </div>

            <!-- Summary Cards with Pie Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                @foreach (var summary in Model)
                {
                    <div class="bg-white overflow-hidden shadow-sms-xl rounded-2xl">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        @if (summary.PersonType == "Students")
                                        {
                                            <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                                                <svg class="w-6 h-6 text-primary-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path>
                                                </svg>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="w-10 h-10 bg-success-light rounded-full flex items-center justify-center">
                                                <svg class="w-6 h-6 text-success" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                                </svg>
                                            </div>
                                        }
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg font-semibold text-primary-800">@summary.PersonType</h3>
                                        <p class="text-sm text-neutral-500">@summary.TotalPersons Total</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-neutral-500">Jamat Rate</div>
                                    <div class="text-2xl font-bold text-@(summary.AttendancePercentage >= 80 ? "green" : summary.AttendancePercentage >= 60 ? "yellow" : "red")-600">
                                        @summary.AttendancePercentage%
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pie Chart Container -->
                            <div class="flex items-center justify-center mb-4">
                                <div class="relative w-48 h-48">
                                    <canvas id="pieChart_@summary.PersonType" width="192" height="192"></canvas>
                                </div>
                            </div>
                            
                            <!-- Statistics -->
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div class="text-center p-3 bg-success-light rounded-lg">
                                    <div class="text-xl font-semibold text-success">@summary.WithJamat</div>
                                    <div class="text-neutral-600 text-xs">With Jamat</div>
                                </div>
                                <div class="text-center p-3 bg-warning-light rounded-lg">
                                    <div class="text-xl font-semibold text-accent-600">@summary.Qaza</div>
                                    <div class="text-neutral-600 text-xs">Qaza</div>
                                </div>
                                <div class="text-center p-3 bg-error-light rounded-lg">
                                    <div class="text-xl font-semibold text-error">@summary.WithoutJamat</div>
                                    <div class="text-neutral-600 text-xs">Without Jamat</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Overall Statistics with Overall Pie Chart -->
            @{
                var totalWithJamat = Model.Sum(s => s.WithJamat);
                var totalQaza = Model.Sum(s => s.Qaza);
                var totalWithoutJamat = Model.Sum(s => s.WithoutJamat);
                var totalPersons = Model.Sum(s => s.TotalPersons);
                var overallPercentage = totalPersons > 0 ? (int)Math.Round((double)totalWithJamat / totalPersons * 100) : 0;
            }
            
            <div class="bg-white overflow-hidden shadow-sms-xl rounded-2xl">
                <div class="px-6 py-6">
                    <h3 class="text-xl leading-6 font-semibold text-primary-800 mb-6 text-center">Overall Summary</h3>
                    
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-8">
                        <!-- Overall Pie Chart -->
                        <div class="flex-shrink-0">
                            <div class="relative w-64 h-64">
                                <canvas id="overallPieChart" width="256" height="256"></canvas>
                            </div>
                        </div>
                        
                        <!-- Statistics Grid -->
                        <div class="flex-1 w-full">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="text-center p-4 bg-neutral-50 rounded-xl">
                                    <div class="text-3xl font-bold text-primary-800">@totalPersons</div>
                                    <div class="text-sm text-neutral-500 mt-1">Total People</div>
                                </div>
                                <div class="text-center p-4 bg-success-light rounded-xl">
                                    <div class="text-3xl font-bold text-success">@totalWithJamat</div>
                                    <div class="text-sm text-neutral-500 mt-1">With Jamat</div>
                                </div>
                                <div class="text-center p-4 bg-warning-light rounded-xl">
                                    <div class="text-3xl font-bold text-accent-600">@totalQaza</div>
                                    <div class="text-sm text-neutral-500 mt-1">Qaza</div>
                                </div>
                                <div class="text-center p-4 bg-error-light rounded-xl">
                                    <div class="text-3xl font-bold text-error">@totalWithoutJamat</div>
                                    <div class="text-sm text-neutral-500 mt-1">Without Jamat</div>
                                </div>
                            </div>
                            
                            <div class="text-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
                                <div class="text-lg font-semibold text-primary-800 mb-2">
                                    Overall Jamat Attendance Rate
                                </div>
                                <div class="text-4xl font-bold text-@(overallPercentage >= 80 ? "green" : overallPercentage >= 60 ? "yellow" : "red")-600">
                                    @overallPercentage%
                                </div>
                                <div class="text-sm text-neutral-600 mt-1">
                                    @totalWithJamat out of @totalPersons people prayed with Jamat
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="~/lib/chartjs/chart.min.js" asp-append-version="true"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Colors for charts
        const chartColors = {
            withJamat: '#10b981', // green
            qaza: '#f59e0b',      // yellow
            withoutJamat: '#ef4444' // red
        };
        
        // Chart options
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        };

        @foreach (var summary in Model)
        {
            <text>
        // Create pie chart for @summary.PersonType
        const ctx@(summary.PersonType) = document.getElementById('pieChart_@summary.PersonType').getContext('2d');
        new Chart(ctx@(summary.PersonType), {
            type: 'doughnut',
            data: {
                labels: ['With Jamat', 'Qaza', 'Without Jamat'],
                datasets: [{
                    data: [@summary.WithJamat, @summary.Qaza, @summary.WithoutJamat],
                    backgroundColor: [
                        chartColors.withJamat,
                        chartColors.qaza,
                        chartColors.withoutJamat
                    ],
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                ...chartOptions,
                plugins: {
                    ...chartOptions.plugins,
                    legend: {
                        display: false
                    }
                }
            }
        });
            </text>
        }

        // Create overall pie chart
        const overallCtx = document.getElementById('overallPieChart').getContext('2d');
        new Chart(overallCtx, {
            type: 'doughnut',
            data: {
                labels: ['With Jamat', 'Qaza', 'Without Jamat'],
                datasets: [{
                    data: [@totalWithJamat, @totalQaza, @totalWithoutJamat],
                    backgroundColor: [
                        chartColors.withJamat,
                        chartColors.qaza,
                        chartColors.withoutJamat
                    ],
                    borderWidth: 0,
                    cutout: '50%'
                }]
            },
            options: chartOptions
        });
    });
</script>
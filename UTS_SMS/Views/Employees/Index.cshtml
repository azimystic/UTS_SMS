@using UTS_SMS.Models
@model PaginatedList<UTS_SMS.Models.Employee>

@{
    ViewData["Title"] = "Employees";
    var roleList = ViewBag.Roles as IEnumerable<string>;
}

<div class="min-h-screen p-4 md:p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <h1 class="text-3xl font-bold text-primary-800 mb-4 md:mb-0">Employees</h1>
        <div class="flex space-x-2">
            <a asp-controller="Admin" asp-action="Dashboard" class="bg-gradient-primary hover:shadow-sms-lg text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-sms-md flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                Dashboard
            </a>
            <a asp-action="Create" class="bg-gradient-primary hover:shadow-sms-lg text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-sms-md">
                Add New Employee
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="bg-success-light border-l-4 border-success text-success p-4 mb-6 rounded-lg animate-fade-in">
            @TempData["SuccessMessage"]
        </div>
    }

    <form id="filterForm" asp-action="Index" method="get" class="bg-white p-4 rounded-xl shadow-sms-md mb-6 transition-all duration-300 hover:shadow-sms-lg border border-primary-100">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="col-span-1">
                <label class="block text-sm font-medium text-primary-800 mb-1">Search</label>
                <input type="text" name="searchString" value="@ViewData["CurrentFilter"]"
                       class="w-full px-3 py-2 border-2 border-primary-100 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-primary-50 text-primary-800 transition-all"
                       placeholder="Name, CNIC, Phone, Role" id="searchInput" />
            </div>
            <div class="col-span-1">
                <label class="block text-sm font-medium text-primary-800 mb-1">Role</label>
                <select name="roleFilter" asp-items="@(new SelectList(roleList))"
                        class="w-full px-3 py-2 border-2 border-primary-100 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-primary-50 text-primary-800 transition-all"
                        id="roleFilter">
                    <option value="">All Roles</option>
                </select>
            </div>
            <div class="col-span-1">
                <label class="block text-sm font-medium text-primary-800 mb-1">Status</label>
                <select name="showInactive"
                        class="w-full px-3 py-2 border-2 border-primary-100 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400 bg-primary-50 text-primary-800 transition-all"
                        id="statusFilter">
                    <option value="">All Employees</option>
                    <option value="false" selected="@(ViewData["ShowInactive"]?.ToString() == "False")">Active</option>
                    <option value="true" selected="@(ViewData["ShowInactive"]?.ToString() == "True")">Inactive</option>
                </select>
            </div>
            <div class="col-span-1 flex items-end">
                <a asp-action="Index" class="w-full bg-primary-100 hover:bg-primary-200 text-primary-800 px-4 py-2 rounded-md transition-colors duration-300 text-center">
                    Reset
                </a>
            </div>
        </div>
    </form>

    <div class="bg-white rounded-xl shadow-sms-md overflow-hidden transition-all duration-300 hover:shadow-sms-lg border border-primary-100">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-primary-100">
                <thead class="bg-gradient-dark text-white">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            <a asp-action="Index"
                               asp-route-sortOrder="@ViewData["NameSortParm"]"
                               asp-route-currentFilter="@ViewData["CurrentFilter"]"
                               asp-route-roleFilter="@ViewData["RoleFilter"]"
                               asp-route-showInactive="@ViewData["ShowInactive"]"
                               class="hover:text-accent-400 transition-colors duration-200">
                                Name
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">CNIC</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            <a asp-action="Index"
                               asp-route-sortOrder="@ViewData["RoleSortParm"]"
                               asp-route-currentFilter="@ViewData["CurrentFilter"]"
                               asp-route-roleFilter="@ViewData["RoleFilter"]"
                               asp-route-showInactive="@ViewData["ShowInactive"]"
                               class="hover:text-accent-400 transition-colors duration-200">
                                Role
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Phone</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            <a asp-action="Index"
                               asp-route-sortOrder="@ViewData["DateSortParm"]"
                               asp-route-currentFilter="@ViewData["CurrentFilter"]"
                               asp-route-roleFilter="@ViewData["RoleFilter"]"
                               asp-route-showInactive="@ViewData["ShowInactive"]"
                               class="hover:text-accent-400 transition-colors duration-200">
                                Join Date
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-primary-100">
                    @foreach (var item in Model)
                    {
                        <tr class="@(!item.IsActive ? "bg-gray-100" : "hover:bg-primary-50") transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-800">@item.FullName</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">@item.CNIC</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">@item.Role</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">@item.PhoneNumber</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">@item.JoiningDate.ToString("dd-MMM-yyyy")</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-600">
                                <div class="flex space-x-2">
                                    <a asp-action="Edit" asp-route-id="@item.Id"
                                       class="text-primary-600 hover:text-primary-800 bg-primary-50 p-2 rounded-full hover:bg-primary-100 transition-all duration-300 transform hover:scale-110"
                                       title="Edit Employee">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </a>

                                    @if (item.IsActive)
                                    {
                                        @* Quick Payroll Button - Create payroll for previous month (current payroll period) *@
                                        <a asp-controller="Payroll" 
                                           asp-action="Create" 
                                           asp-route-id="@item.Id" 
                                           asp-route-forMonth="@DateTime.Now.AddMonths(-1).Month"
                                           asp-route-forYear="@DateTime.Now.AddMonths(-1).Year"
                                           class="text-indigo-600 hover:text-white bg-indigo-50 p-2 rounded-full hover:bg-indigo-600 transition-all duration-300 transform hover:scale-110"
                                           title="Process Payroll for Previous Month">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z" />
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd" />
                                            </svg>
                                        </a>

                                        <form asp-action="MarkAsInactive" asp-route-id="@item.Id" method="post" class="inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit"
                                                    class="text-error hover:text-white bg-error-light p-2 rounded-full hover:bg-error transition-all duration-300 transform hover:scale-110"
                                                    title="Mark as Inactive"
                                                    onclick="return confirm('Are you sure you want to mark this employee as inactive?')">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form asp-action="MarkAsActive" asp-route-id="@item.Id" method="post" class="inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit"
                                                    class="text-success hover:text-white bg-success-light p-2 rounded-full hover:bg-success transition-all duration-300 transform hover:scale-110"
                                                    title="Mark as Active"
                                                    onclick="return confirm('Are you sure you want to mark this employee as active again?')">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                </svg>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @{
        var prevDisabled = !Model.HasPreviousPage ? "opacity-50 cursor-not-allowed" : "hover:bg-primary-50";
        var nextDisabled = !Model.HasNextPage ? "opacity-50 cursor-not-allowed" : "hover:bg-primary-50";
    }

    <div class="mt-6 flex justify-center">
        <nav class="relative z-0 inline-flex rounded-md shadow-sms-sm -space-x-px" aria-label="Pagination">
            <a asp-action="Index"
               asp-route-sortOrder="@ViewData["CurrentSort"]"
               asp-route-pageNumber="@(Model.PageIndex - 1)"
               asp-route-currentFilter="@ViewData["CurrentFilter"]"
               asp-route-roleFilter="@ViewData["RoleFilter"]"
               asp-route-showInactive="@ViewData["ShowInactive"]"
               class="relative inline-flex items-center px-4 py-2 rounded-l-md border-2 border-primary-100 bg-white text-sm font-medium text-primary-700 @prevDisabled transition-colors duration-200">
                Previous
            </a>

            @{
                int startPage = Math.Max(1, Model.PageIndex - 2);
                int endPage = Math.Min(Model.TotalPages, Model.PageIndex + 2);

                if (startPage > 1)
                {
                    <a asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="1"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                       asp-route-roleFilter="@ViewData["RoleFilter"]"
                       asp-route-showInactive="@ViewData["ShowInactive"]"
                       class="relative inline-flex items-center px-4 py-2 border-2 border-primary-100 bg-white text-sm font-medium @(1 == Model.PageIndex ? "z-10 bg-primary-50 border-primary-400 text-primary-600" : "text-primary-700 hover:bg-primary-50") transition-colors duration-200">
                        1
                    </a>
                    if (startPage > 2)
                    {
                        <span class="relative inline-flex items-center px-4 py-2 border-2 border-primary-100 bg-white text-sm font-medium text-neutral-600">
                            ...
                        </span>
                    }
                }

                for (int i = startPage; i <= endPage; i++)
                {
                    <a asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@i"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                       asp-route-roleFilter="@ViewData["RoleFilter"]"
                       asp-route-showInactive="@ViewData["ShowInactive"]"
                       class="relative inline-flex items-center px-4 py-2 border-2 border-primary-100 bg-white text-sm font-medium @(i == Model.PageIndex ? "z-10 bg-primary-50 border-primary-400 text-primary-600" : "text-primary-700 hover:bg-primary-50") transition-colors duration-200">
                        @i
                    </a>
                }

                if (endPage < Model.TotalPages)
                {
                    if (endPage < Model.TotalPages - 1)
                    {
                        <span class="relative inline-flex items-center px-4 py-2 border-2 border-primary-100 bg-white text-sm font-medium text-neutral-600">
                            ...
                        </span>
                    }
                    <a asp-action="Index"
                       asp-route-sortOrder="@ViewData["CurrentSort"]"
                       asp-route-pageNumber="@Model.TotalPages"
                       asp-route-currentFilter="@ViewData["CurrentFilter"]"
                       asp-route-roleFilter="@ViewData["RoleFilter"]"
                       asp-route-showInactive="@ViewData["ShowInactive"]"
                       class="relative inline-flex items-center px-4 py-2 border-2 border-primary-100 bg-white text-sm font-medium @(Model.TotalPages == Model.PageIndex ? "z-10 bg-primary-50 border-primary-400 text-primary-600" : "text-primary-700 hover:bg-primary-50") transition-colors duration-200">
                        @Model.TotalPages
                    </a>
                }
            }

            <a asp-action="Index"
               asp-route-sortOrder="@ViewData["CurrentSort"]"
               asp-route-pageNumber="@(Model.PageIndex + 1)"
               asp-route-currentFilter="@ViewData["CurrentFilter"]"
               asp-route-roleFilter="@ViewData["RoleFilter"]"
               asp-route-showInactive="@ViewData["ShowInactive"]"
               class="relative inline-flex items-center px-4 py-2 rounded-r-md border-2 border-primary-100 bg-white text-sm font-medium text-primary-700 @nextDisabled transition-colors duration-200">
                Next
            </a>
        </nav>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" /> 
    <script src="~/js/jquery.js"></script>
    <script>
        $(document).ready(function() {
            var typingTimer;
            var doneTypingInterval = 500;

            var filterElements = ['#searchInput', '#roleFilter', '#statusFilter'];

            $(filterElements.join(',')).on('input change', function() {
                clearTimeout(typingTimer);

                if ($(this).is('#searchInput')) {
                    typingTimer = setTimeout(submitForm, doneTypingInterval);
                } else {
                    submitForm();
                }
            });

            function submitForm() {
                $('#filterForm').submit();
            }

            $('#roleFilter').val('@ViewData["RoleFilter"]');
            $('#statusFilter').val('@ViewData["ShowInactive"]');
        });
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        tr {
            transition: all 0.2s ease;
        }

            tr:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-sm);
            }
    </style>
}
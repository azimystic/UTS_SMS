@{
    ViewData["Title"] = "Student Promotion";
    var campusList = ViewBag.Campuses as IEnumerable<Campus>;
}

<div class="min-h-screen   p-2 md:p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-primary-800 mb-1">Student Promotion</h1>
            <p class="text-sm text-neutral-600">Promote students to next class or mark as passed out</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="hidden mb-4">
        <div id="successMessage" class="hidden bg-success-light border-l-4 border-success text-success p-3 md:p-4 rounded-lg animate-fade-in text-sm flex items-center">
            <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span id="successMessageText"></span>
        </div>
        <div id="errorMessage" class="hidden bg-error-light border-l-4 border-error text-error p-3 md:p-4 rounded-lg animate-fade-in text-sm flex items-center">
            <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span id="errorMessageText"></span>
        </div>
    </div>

    <!-- Step 1: Select Campus and Current Class/Section -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sms-md mb-6 border-l-4 border-primary-500">
        <div class="flex items-center mb-4">
            <div class="bg-primary-100 text-primary-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">1</div>
            <h2 class="text-lg md:text-xl font-semibold text-primary-800">Select Current Class & Section</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Campus *</label>
                <select id="campusSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all">
                    <option value="">Select Campus</option>
                    @if (campusList != null)
                    {
                        @foreach (var campus in campusList)
                        {
                            <option value="@campus.Id">@campus.Name</option>
                        }
                    }
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Current Class *</label>
                <select id="currentClassSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all" disabled>
                    <option value="">Select Class</option>
                </select>
                <div id="classLoader" class="hidden mt-2">
                    <div class="flex items-center text-sm text-primary-600">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading...
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Current Section *</label>
                <select id="currentSectionSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all" disabled>
                    <option value="">Select Section</option>
                </select>
                <div id="sectionLoader" class="hidden mt-2">
                    <div class="flex items-center text-sm text-primary-600">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading...
                    </div>
                </div>
            </div>

            <div class="flex items-end">
                <button id="loadStudentsBtn" class="w-full bg-gradient-primary hover:bg-primary-700 text-white px-4 py-2 rounded-md transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span id="loadStudentsBtnText">Load Students</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 2: Select Target Class/Section -->
    <div id="targetClassSection" class="bg-white p-4 md:p-6 rounded-xl shadow-sms-md mb-6 border-l-4 border-primary-400 hidden">
        <div class="flex items-center mb-4">
            <div class="bg-primary-200 text-primary-900 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">2</div>
            <h2 class="text-lg md:text-xl font-semibold text-primary-800">Select Target Class, Section & Options</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Promote To Class *</label>
                <select id="targetClassSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all">
                    <option value="">Select Target Class</option>
                </select>
                <div id="targetClassLoader" class="hidden mt-2">
                    <div class="flex items-center text-sm text-primary-600">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading...
                    </div>
                </div>
            </div>

            <div id="targetSectionDiv">
                <label class="block text-sm font-medium text-neutral-700 mb-2">Promote To Section *</label>
                <select id="targetSectionSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all" disabled>
                    <option value="">Select Target Section</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Subject Grouping</label>
                <select id="targetSubjectsGroupingSelect" class="w-full px-3 py-2 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all">
                    <option value="">Select Subject Grouping</option>
                </select>
            </div>
        </div>

        <!-- Class Charges/Fees Section -->
        <div id="classChargesSection" class="mt-6 hidden">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-base font-semibold text-primary-800">Class Charges/Fees</h3>
                <button type="button" id="selectAllCharges" class="text-sm text-primary-600 hover:text-primary-800 font-medium">
                    Select All
                </button>
            </div>
            <div id="classChargesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <!-- Charges will be loaded here -->
            </div>
            <div id="noChargesMessage" class="hidden text-sm text-neutral-500 text-center py-4">
                No class charges/fees available for this class.
            </div>
        </div>
    </div>

    <!-- Step 3: Students List -->
    <div id="studentsSection" class="bg-white p-4 md:p-6 rounded-xl shadow-sms-md border-l-4 border-primary-300 hidden">
        <div class="flex items-center mb-4">
            <div class="bg-primary-200 text-primary-900 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3">3</div>
            <h2 class="text-lg md:text-xl font-semibold text-primary-800">Select Students to Promote</h2>
        </div>

        <!-- Statistics Card -->
        <div id="statsCard" class="bg-gradient-to-r from-primary-50 to-blue-50 border border-primary-200 rounded-lg p-4 mb-4 hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h3 class="text-lg font-semibold text-primary-800 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                        </svg>
                        Promotion Summary
                    </h3>
                    <p class="text-sm text-primary-600 mt-1">
                        <span id="selectedCount" class="font-bold text-lg">0</span> of <span id="totalStudents" class="font-bold text-lg">0</span> students selected
                    </p>
                </div>
                <div class="mt-2 md:mt-0">
                    <span id="promotionTarget" class="bg-white text-primary-800 px-4 py-2 rounded-full text-sm font-medium shadow-sm border border-primary-200"></span>
                </div>
            </div>
        </div>

        <!-- Search and Actions Bar -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
            <div class="relative w-full md:w-64">
                <input type="text" id="searchInput" class="w-full px-4 py-2 pl-10 border border-primary-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all" placeholder="Search students...">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <div class="flex space-x-2 w-full md:w-auto">
                <button id="selectAllBtn" class="flex-1 md:flex-none bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors duration-300 text-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Select All
                </button>
                <button id="promoteBtn" class="flex-1 md:flex-none bg-success hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed text-sm flex items-center justify-center" disabled>
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <span id="promoteBtnText">Promote Selected</span>
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="studentsLoader" class="hidden text-center py-12">
            <svg class="animate-spin h-12 w-12 mx-auto text-primary-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-neutral-600">Loading students...</p>
        </div>

        <!-- Students Table for Desktop -->
        <div class="hidden md:block overflow-x-auto">
            <table class="min-w-full divide-y divide-primary-100">
                <thead class="bg-gradient-dark text-white">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">
                            <input type="checkbox" id="masterCheckbox" class="w-4 h-4 text-primary-600 border-primary-200 rounded focus:ring-primary-400">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Father Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student CNIC</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Subject Grouping</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody" class="bg-white divide-y divide-primary-100">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Students Cards for Mobile -->
        <div id="studentsCards" class="block md:hidden space-y-4">
            <!-- Student cards will be loaded here -->
        </div>

        <!-- No Students Message -->
        <div id="noStudentsMessage" class="text-center text-neutral-500 py-12 hidden">
            <svg class="mx-auto h-16 w-16 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <h3 class="mt-4 text-lg font-medium text-primary-800">No students found</h3>
            <p class="mt-2 text-sm text-neutral-500">No students found in the selected class and section.</p>
        </div>

        <!-- No Search Results Message -->
        <div id="noSearchResults" class="text-center text-neutral-500 py-12 hidden">
            <svg class="mx-auto h-16 w-16 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-primary-800">No results found</h3>
            <p class="mt-2 text-sm text-neutral-500">Try adjusting your search terms.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/jquery.js"></script>
    <script>
        $(document).ready(function() {
            let selectedStudents = [];
            let selectedStudentsSet = new Set(); // Persistent storage for selected student IDs
            let currentGradeLevel = '';
            let isPassOut = false;
            let allStudents = [];
            let selectedCharges = new Set(); // Store selected charge IDs
            let allClassCharges = []; // Store all charges for the target class

            // Campus change handler
            $('#campusSelect').change(function() {
                const campusId = $(this).val();
                $('#currentClassSelect').prop('disabled', !campusId).empty().append('<option value="">Select Class</option>');
                $('#currentSectionSelect').prop('disabled', true).empty().append('<option value="">Select Section</option>');
                $('#loadStudentsBtn').prop('disabled', true);
                hideSteps();

                if (campusId) {
                    loadClasses(campusId);
                }
            });

            // Current class change handler
            $('#currentClassSelect').change(function() {
                const classId = $(this).val();

                $('#currentSectionSelect').prop('disabled', !classId).empty().append('<option value="">Select Section</option>');
                $('#loadStudentsBtn').prop('disabled', true);
                hideSteps();

                if (classId) {
                    $.get('/StudentPromotion/GetClassGradeLevel', { classId: classId })
                        .done(function(gradeLevel) {
                            currentGradeLevel = gradeLevel;
                        });

                    loadSections(classId, '#currentSectionSelect', '#sectionLoader');
                }
            });

            // Current section change handler
            $('#currentSectionSelect').change(function() {
                const sectionId = $(this).val();
                $('#loadStudentsBtn').prop('disabled', !sectionId);
                hideSteps();
            });

            // Load students button
            $('#loadStudentsBtn').click(function() {
                const classId = $('#currentClassSelect').val();
                const sectionId = $('#currentSectionSelect').val();

                if (classId && sectionId) {
                    loadStudents(classId, sectionId);
                    loadTargetClasses();
                }
            });

            // Target class change handler
            $('#targetClassSelect').change(function() {
                const targetClassId = $(this).val();
                const selectedOption = $(this).find('option:selected');
                isPassOut = selectedOption.text() === 'PassOut';

                if (isPassOut) {
                    $('#targetSectionDiv').hide();
                    $('#classChargesSection').addClass('hidden');
                    $('#promoteBtn').prop('disabled', selectedStudents.length === 0);
                } else {
                    $('#targetSectionDiv').show();
                    $('#targetSectionSelect').prop('disabled', !targetClassId).empty().append('<option value="">Select Target Section</option>');
                    $('#promoteBtn').prop('disabled', true);

                    if (targetClassId) {
                        loadSections(targetClassId, '#targetSectionSelect', '#targetSectionLoader');
                        loadClassCharges(targetClassId);
                    } else {
                        $('#classChargesSection').addClass('hidden');
                    }
                }
                updatePromotionTarget();
            });

            // Target section change handler
            $('#targetSectionSelect').change(function() {
                const sectionId = $(this).val();
                $('#promoteBtn').prop('disabled', selectedStudents.length === 0 || (!isPassOut && !sectionId));
                updatePromotionTarget();
            });

            // Search functionality
            $('#searchInput').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterStudents(searchTerm);
            });

            // Master checkbox handler
            $(document).on('change', '#masterCheckbox', function() {
                const isChecked = $(this).is(':checked');
                $('.student-checkbox:visible').each(function() {
                    $(this).prop('checked', isChecked);
                    const studentId = parseInt($(this).val());
                    if (isChecked) {
                        selectedStudentsSet.add(studentId);
                    } else {
                        selectedStudentsSet.delete(studentId);
                    }
                });
                updateSelectedStudents();
                updateSelectAllButton();
            });

            // Individual checkbox handler
            $(document).on('change', '.student-checkbox', function() {
                const studentId = parseInt($(this).val());
                if ($(this).is(':checked')) {
                    selectedStudentsSet.add(studentId);
                } else {
                    selectedStudentsSet.delete(studentId);
                }
                updateSelectedStudents();
                updateMasterCheckbox();
                updateSelectAllButton();
            });

            // Select all button handler
            $('#selectAllBtn').click(function() {
                const allChecked = $('.student-checkbox:visible:checked').length === $('.student-checkbox:visible').length;
                $('.student-checkbox:visible').each(function() {
                    $(this).prop('checked', !allChecked);
                    const studentId = parseInt($(this).val());
                    if (!allChecked) {
                        selectedStudentsSet.add(studentId);
                    } else {
                        selectedStudentsSet.delete(studentId);
                    }
                });
                $('#masterCheckbox').prop('checked', !allChecked);
                updateSelectedStudents();
                updateSelectAllButton();
            });

            // Select all charges button handler
            $('#selectAllCharges').click(function() {
                const allChecked = $('.charge-checkbox:checked').length === $('.charge-checkbox').length;
                $('.charge-checkbox').each(function() {
                    $(this).prop('checked', !allChecked);
                    const chargeId = parseInt($(this).val());
                    if (!allChecked) {
                        selectedCharges.add(chargeId);
                    } else {
                        selectedCharges.delete(chargeId);
                    }
                });
                updateSelectAllChargesButton();
            });

            // Individual charge checkbox handler
            $(document).on('change', '.charge-checkbox', function() {
                const chargeId = parseInt($(this).val());
                if ($(this).is(':checked')) {
                    selectedCharges.add(chargeId);
                } else {
                    selectedCharges.delete(chargeId);
                }
                updateSelectAllChargesButton();
            });

            // Promote button handler
            $('#promoteBtn').click(function() {
                if (selectedStudents.length === 0) {
                    showMessage('Please select at least one student to promote.', 'error');
                    return;
                }

                const campusId = $('#campusSelect').val();
                const fromClassId = $('#currentClassSelect').val();
                const fromSectionId = $('#currentSectionSelect').val();
                const toClassId = isPassOut ? null : $('#targetClassSelect').val();
                const toSectionId = isPassOut ? null : $('#targetSectionSelect').val();
                
                // Collect per-student subject groupings
                const studentSubjectGroupings = {};
                $('.student-subject-grouping').each(function() {
                    const studentId = parseInt($(this).data('student-id'));
                    const groupingId = $(this).val();
                    if (selectedStudentsSet.has(studentId) && groupingId) {
                        studentSubjectGroupings[studentId] = parseInt(groupingId);
                    }
                });

                // Collect selected class charges
                const selectedClassCharges = Array.from(selectedCharges);

                const confirmMessage = isPassOut
                    ? `Are you sure you want to mark ${selectedStudents.length} student${selectedStudents.length > 1 ? 's' : ''} as PassOut? This will mark them as left.`
                    : `Are you sure you want to promote ${selectedStudents.length} student${selectedStudents.length > 1 ? 's' : ''}?`;

                if (confirm(confirmMessage)) {
                    promoteStudents({
                        campusId: parseInt(campusId),
                        fromClassId: parseInt(fromClassId),
                        fromSectionId: parseInt(fromSectionId),
                        toClassId: toClassId ? parseInt(toClassId) : null,
                        toSectionId: toSectionId ? parseInt(toSectionId) : null,
                        toSubjectsGroupingId: null, // Not used anymore, we use per-student groupings
                        studentIds: selectedStudents,
                        studentSubjectGroupings: studentSubjectGroupings,
                        selectedClassCharges: selectedClassCharges,
                        isPassOut: isPassOut,
                        updateStudentCategory: false,
                        newStudentCategoryId: null
                    });
                }
            });

            // Functions
            function loadClasses(campusId) {
                $('#classLoader').removeClass('hidden');
                $.get('/StudentPromotion/GetClassesByCampus', { campusId: campusId })
                    .done(function(data) {
                        $('#currentClassSelect').empty().append('<option value="">Select Class</option>');
                        $.each(data, function(index, item) {
                            $('#currentClassSelect').append(`<option value="${item.id}">${item.name}</option>`);
                        });
                        $('#currentClassSelect').prop('disabled', false);
                    })
                    .fail(function() {
                        showMessage('Error loading classes', 'error');
                    })
                    .always(function() {
                        $('#classLoader').addClass('hidden');
                    });
            }

            function loadSections(classId, targetSelector, loaderSelector) {
                if (loaderSelector) {
                    $(loaderSelector).removeClass('hidden');
                }
                $.get('/StudentPromotion/GetSectionsByClass', { classId: classId })
                    .done(function(data) {
                        $(targetSelector).empty().append('<option value="">Select Section</option>');
                        $.each(data, function(index, item) {
                            $(targetSelector).append(`<option value="${item.id}">${item.name}</option>`);
                        });
                        $(targetSelector).prop('disabled', false);
                    })
                    .fail(function() {
                        showMessage('Error loading sections', 'error');
                    })
                    .always(function() {
                        if (loaderSelector) {
                            $(loaderSelector).addClass('hidden');
                        }
                    });
            }

            function loadTargetClasses() {
                const campusId = $('#campusSelect').val();
                $('#targetClassLoader').removeClass('hidden');

                $.get('/StudentPromotion/GetTargetClasses', {
                    campusId: campusId,
                    currentGradeLevel: currentGradeLevel
                })
                    .done(function(data) {
                        $('#targetClassSelect').empty().append('<option value="">Select Target Class</option>');
                        $.each(data, function(index, item) {
                            $('#targetClassSelect').append(`<option value="${item.id}">${item.name}</option>`);
                        });
                        $('#targetClassSection').removeClass('hidden');
                        
                        // Also load subject groupings
                        loadSubjectsGroupings(campusId);
                    })
                    .fail(function() {
                        showMessage('Error loading target classes', 'error');
                    })
                    .always(function() {
                        $('#targetClassLoader').addClass('hidden');
                    });
            }

            function loadSubjectsGroupings(campusId) {
                $.get('/StudentPromotion/GetSubjectsGroupingsByCampus', { campusId: campusId })
                    .done(function(data) {
                        $('#targetSubjectsGroupingSelect').empty().append('<option value="">Select Subject Grouping</option>');
                        if (data && data.length > 0) {
                            $.each(data, function(index, item) {
                                $('#targetSubjectsGroupingSelect').append(`<option value="${item.id}">${item.name}</option>`);
                            });
                        } else {
                            $('#targetSubjectsGroupingSelect').append('<option value="" disabled>No subject groupings available</option>');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Error loading subject groupings:', error);
                        $('#targetSubjectsGroupingSelect').empty()
                            .append('<option value="">Select Subject Grouping</option>')
                            .append('<option value="" disabled>Error loading options</option>');
                    });
            }

            function loadClassCharges(classId) {
                $.get('/StudentPromotion/GetClassChargesByClass', { classId: classId })
                    .done(function(data) {
                        allClassCharges = data;
                        if (data.length === 0) {
                            $('#classChargesSection').addClass('hidden');
                            $('#noChargesMessage').removeClass('hidden');
                            selectedCharges.clear();
                            return;
                        }

                        // Auto-select all charges by default
                        selectedCharges.clear();
                        data.forEach(charge => selectedCharges.add(charge.id));

                        renderClassCharges(data);
                        $('#classChargesSection').removeClass('hidden');
                        $('#noChargesMessage').addClass('hidden');
                        updateSelectAllChargesButton();
                    })
                    .fail(function() {
                        console.log('Error loading class charges');
                        $('#classChargesSection').addClass('hidden');
                    });
            }

            function renderClassCharges(charges) {
                let chargesHtml = '';
                $.each(charges, function(index, charge) {
                    const isChecked = selectedCharges.has(charge.id) ? 'checked' : '';
                    chargesHtml += `
                        <div class="flex items-center p-3 border border-primary-200 rounded-lg bg-neutral-50 hover:bg-primary-50 transition-colors">
                            <input type="checkbox" class="charge-checkbox w-4 h-4 text-primary-600 border-primary-200 rounded focus:ring-primary-400 mr-3" 
                                   value="${charge.id}" ${isChecked}>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-primary-800">${charge.chargeName}</p>
                                <p class="text-xs text-neutral-600">${charge.category || 'Fee'} - Rs. ${charge.amount}</p>
                            </div>
                        </div>
                    `;
                });
                $('#classChargesList').html(chargesHtml);
            }

            function updateSelectAllChargesButton() {
                const totalCharges = $('.charge-checkbox').length;
                const checkedCharges = $('.charge-checkbox:checked').length;

                if (checkedCharges === totalCharges && totalCharges > 0) {
                    $('#selectAllCharges').text('Deselect All');
                } else {
                    $('#selectAllCharges').text('Select All');
                }
            }

            function loadStudents(classId, sectionId) {
                $('#studentsLoader').removeClass('hidden');
                $('#noStudentsMessage').addClass('hidden');
                $('#studentsTableBody').empty();
                $('#studentsCards').empty();
                $('#loadStudentsBtnText').text('Loading...');
                $('#loadStudentsBtn').prop('disabled', true);

                $.get('/StudentPromotion/GetStudentsByClassSection', {
                    classId: classId,
                    sectionId: sectionId
                })
                    .done(function(data) {
                        allStudents = data;
                        if (data.length === 0) {
                            $('#noStudentsMessage').removeClass('hidden');
                        } else {
                            renderStudentsTable(data);
                            renderStudentsCards(data);
                            $('#totalStudents').text(data.length);
                            
                            // Set default subject grouping based on first student's current grouping
                            if (data.length > 0 && data[0].subjectsGroupingId) {
                                $('#targetSubjectsGroupingSelect').val(data[0].subjectsGroupingId);
                            }
                        }
                        $('#studentsSection').removeClass('hidden');
                        selectedStudents = [];
                        selectedStudentsSet.clear(); // Clear the persistent set
                        updateSelectAllButton();
                        $('#searchInput').val('');
                    })
                    .fail(function() {
                        showMessage('Error loading students', 'error');
                    })
                    .always(function() {
                        $('#studentsLoader').addClass('hidden');
                        $('#loadStudentsBtnText').text('Load Students');
                        $('#loadStudentsBtn').prop('disabled', false);
                    });
            }

            // Build subject grouping dropdown options for a student
            function buildSubjectGroupingOptions(student) {
                let groupingOptions = '<option value="0">Keep Same</option>';
                const subjectsGroupingSelect = $('#targetSubjectsGroupingSelect');
                subjectsGroupingSelect.find('option').each(function() {
                    const optionValue = $(this).val();
                    const optionText = $(this).text();
                    if (optionValue) {
                        groupingOptions += `<option value="${optionValue}">${optionText}</option>`;
                    }
                });
                return groupingOptions;
            }

            function filterStudents(searchTerm) {
                if (!searchTerm) {
                    $('.student-row, .student-card').show();
                    $('#noSearchResults').addClass('hidden');
                    $('#studentsTableBody, #studentsCards').removeClass('hidden');
                    return;
                }

                let visibleCount = 0;
                $('.student-row, .student-card').each(function() {
                    const text = $(this).text().toLowerCase();
                    if (text.includes(searchTerm)) {
                        $(this).show();
                        visibleCount++;
                    } else {
                        $(this).hide();
                    }
                });

                if (visibleCount === 0) {
                    $('#noSearchResults').removeClass('hidden');
                    $('#studentsTableBody, #studentsCards').addClass('hidden');
                } else {
                    $('#noSearchResults').addClass('hidden');
                    $('#studentsTableBody, #studentsCards').removeClass('hidden');
                }

                updateMasterCheckbox();
            }

            function renderStudentsTable(students) {
                let tableHtml = '';
                $.each(students, function(index, student) {
                    const isChecked = selectedStudentsSet.has(student.id) ? 'checked' : '';
                    const groupingOptions = buildSubjectGroupingOptions(student);
                    
                    tableHtml += `
                        <tr class="student-row hover:bg-neutral-50 transition-colors duration-200" data-student-id="${student.id}" data-subject-grouping-id="${student.subjectsGroupingId || ''}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" class="student-checkbox w-4 h-4 text-primary-600 border-primary-200 rounded focus:ring-primary-400" value="${student.id}" ${isChecked}>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-800">${student.studentName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">${student.fatherName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">${student.studentCNIC || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <select class="student-subject-grouping w-full px-2 py-1 text-sm border border-primary-200 rounded focus:outline-none focus:ring-1 focus:ring-primary-400" data-student-id="${student.id}">
                                    ${groupingOptions}
                                </select>
                            </td>
                        </tr>
                    `;
                });
                $('#studentsTableBody').html(tableHtml);
            }

            function renderStudentsCards(students) {
                let cardsHtml = '';
                $.each(students, function(index, student) {
                    const isChecked = selectedStudentsSet.has(student.id) ? 'checked' : '';
                    const groupingOptions = buildSubjectGroupingOptions(student);
                    
                    cardsHtml += `
                        <div class="student-card bg-neutral-50 rounded-lg p-4 border border-primary-100 hover:shadow-md transition-shadow duration-200" data-student-id="${student.id}" data-subject-grouping-id="${student.subjectsGroupingId || ''}">
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" class="student-checkbox w-4 h-4 text-primary-600 border-primary-200 rounded focus:ring-primary-400 mt-1" value="${student.id}" ${isChecked}>
                                <div class="flex-1">
                                    <h3 class="font-medium text-primary-800">${student.studentName}</h3>
                                    <p class="text-sm text-neutral-600 mt-1">Father: ${student.fatherName}</p>
                                    <p class="text-sm text-neutral-500 mt-1">CNIC: ${student.studentCNIC || 'N/A'}</p>
                                    <div class="mt-2">
                                        <label class="block text-xs font-medium text-neutral-700 mb-1">Subject Grouping</label>
                                        <select class="student-subject-grouping w-full px-2 py-1 text-sm border border-primary-200 rounded focus:outline-none focus:ring-1 focus:ring-primary-400" data-student-id="${student.id}">
                                            ${groupingOptions}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                $('#studentsCards').html(cardsHtml);
            }

            function updateSelectedStudents() {
                selectedStudents = Array.from(selectedStudentsSet);

                const canPromote = selectedStudents.length > 0 && (isPassOut || $('#targetSectionSelect').val());
                $('#promoteBtn').prop('disabled', !canPromote);

                $('#selectedCount').text(selectedStudents.length);
                updatePromotionTarget();
            }

            function updatePromotionTarget() {
                let targetText = '';
                if (isPassOut) {
                    targetText = '🎓 PassOut (Mark as Left)';
                } else {
                    const targetClass = $('#targetClassSelect option:selected').text();
                    const targetSection = $('#targetSectionSelect option:selected').text();
                    if (targetClass && targetClass !== 'Select Target Class') {
                        targetText = `📚 Promote to ${targetClass}`;
                        if (targetSection && targetSection !== 'Select Target Section') {
                            targetText += ` - ${targetSection}`;
                        }
                    }
                }
                $('#promotionTarget').text(targetText);

                if (selectedStudents.length > 0 && targetText) {
                    $('#statsCard').removeClass('hidden');
                } else {
                    $('#statsCard').addClass('hidden');
                }
            }

            function updateMasterCheckbox() {
                const totalCheckboxes = $('.student-checkbox:visible').length;
                const checkedCheckboxes = $('.student-checkbox:visible:checked').length;

                $('#masterCheckbox').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
                $('#masterCheckbox').prop('checked', checkedCheckboxes === totalCheckboxes && totalCheckboxes > 0);
            }

            function updateSelectAllButton() {
                const totalCheckboxes = $('.student-checkbox:visible').length;
                const checkedCheckboxes = $('.student-checkbox:visible:checked').length;

                if (checkedCheckboxes === totalCheckboxes && totalCheckboxes > 0) {
                    $('#selectAllBtn').html(`
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Deselect All
                    `).removeClass('bg-gray-600 hover:bg-gray-700').addClass('bg-error hover:bg-red-700');
                } else {
                    $('#selectAllBtn').html(`
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Select All
                    `).removeClass('bg-error hover:bg-red-700').addClass('bg-gray-600 hover:bg-gray-700');
                }
            }

            function promoteStudents(promotionData) {
                $('#promoteBtn').prop('disabled', true);
                $('#promoteBtnText').text('Promoting...');

                $.ajax({
                    url: '/StudentPromotion/PromoteStudents',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(promotionData),
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                            loadStudents($('#currentClassSelect').val(), $('#currentSectionSelect').val());
                            $('#targetClassSelect').val('');
                            $('#targetSectionSelect').val('').prop('disabled', true);
                            updatePromotionTarget();
                        } else {
                            showMessage(response.message, 'error');
                            $('#promoteBtn').prop('disabled', false);
                        }
                    },
                    error: function(xhr, status, error) {
                        showMessage('An error occurred while promoting students. Please try again.', 'error');
                        $('#promoteBtn').prop('disabled', false);
                    },
                    complete: function() {
                        $('#promoteBtnText').text('Promote Selected');
                    }
                });
            }

            function showMessage(message, type) {
                $('#messageContainer').removeClass('hidden');
                if (type === 'success') {
                    $('#successMessageText').text(message);
                    $('#successMessage').removeClass('hidden');
                    $('#errorMessage').addClass('hidden');
                } else {
                    $('#errorMessageText').text(message);
                    $('#errorMessage').removeClass('hidden');
                    $('#successMessage').addClass('hidden');
                }

                $('html, body').animate({ scrollTop: 0 }, 300);

                setTimeout(function() {
                    $('#messageContainer').addClass('hidden');
                    $('#successMessage, #errorMessage').addClass('hidden');
                }, 5000);
            }

            function hideSteps() {
                $('#targetClassSection').addClass('hidden');
                $('#studentsSection').addClass('hidden');
                selectedStudents = [];
            }
        });
    </script>

    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        input[type="checkbox"]:indeterminate {
            background-color: #3b82f6;
            border-color: #3b82f6;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M4 8h8'/%3e%3c/svg%3e");
        }

        .transition-all {
            transition: all 0.3s ease;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
}
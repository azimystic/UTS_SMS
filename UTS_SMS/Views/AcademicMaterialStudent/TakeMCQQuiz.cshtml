@model IEnumerable<UTS_SMS.Models.Question>

@{
    ViewData["Title"] = "MCQ Quiz";
    var chapter = ViewBag.Chapter as UTS_SMS.Models.Chapter;
}

<div class="min-h-screen bg-gradient-subtle p-4 md:p-6">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-primary-800">MCQ Quiz</h1>
                <p class="text-neutral-600 mt-2">Chapter @chapter.ChapterNumber: @chapter.Name</p>
            </div>
            <a href="@Url.Action("ViewChapter", new { id = chapter.Id })" class="mt-4 md:mt-0 bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-4 py-2 rounded-lg">
                ‚Üê Back to Chapter
            </a>
        </div>

        @if (!Model.Any())
        {
            <div class="bg-white rounded-2xl shadow-sms-xl p-12 text-center">
                <div class="text-6xl mb-4">‚ùì</div>
                <h3 class="text-xl font-semibold text-neutral-700 mb-2">No MCQs Available</h3>
                <p class="text-neutral-600">No MCQ questions have been added for this chapter yet.</p>
                <a href="@Url.Action("ViewChapter", new { id = chapter.Id })" class="mt-4 inline-block bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg">
                    View Chapter Content
                </a>
            </div>
        }
        else
        {
            <!-- Quiz Info -->
            <div class="bg-white rounded-2xl shadow-sms-xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-lg font-semibold text-neutral-800">Total Questions: <span class="text-primary-600">@Model.Count()</span></p>
                        <p class="text-sm text-neutral-600 mt-1">Answer all questions and submit to see your score</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="showAnswers" class="rounded border-primary-300" onchange="toggleAnswers()" />
                            <span class="text-sm font-medium text-neutral-700">Show Answers</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Quiz Form -->
            <form id="quizForm">
                @{
                    int questionNumber = 1;
                }
                @foreach (var question in Model)
                {
                    <div class="bg-white rounded-2xl shadow-sms-xl p-6 mb-4">
                        <div class="flex items-start mb-4">
                            <span class="bg-primary-100 text-primary-700 px-3 py-2 rounded-full text-sm font-bold mr-3">Q@(questionNumber)</span>
                            <p class="font-medium text-neutral-800 flex-1">@question.QuestionText</p>
                        </div>
                        
                        <div class="space-y-2 ml-12">
                            <label class="flex items-start space-x-3 p-3 border border-primary-200 rounded-lg hover:bg-primary-50 cursor-pointer transition-colors">
                                <input type="radio" name="question_@question.Id" value="A" class="mt-1" required />
                                <span class="flex-1">A) @question.OptionA</span>
                            </label>
                            <label class="flex items-start space-x-3 p-3 border border-primary-200 rounded-lg hover:bg-primary-50 cursor-pointer transition-colors">
                                <input type="radio" name="question_@question.Id" value="B" class="mt-1" required />
                                <span class="flex-1">B) @question.OptionB</span>
                            </label>
                            <label class="flex items-start space-x-3 p-3 border border-primary-200 rounded-lg hover:bg-primary-50 cursor-pointer transition-colors">
                                <input type="radio" name="question_@question.Id" value="C" class="mt-1" required />
                                <span class="flex-1">C) @question.OptionC</span>
                            </label>
                            <label class="flex items-start space-x-3 p-3 border border-primary-200 rounded-lg hover:bg-primary-50 cursor-pointer transition-colors">
                                <input type="radio" name="question_@question.Id" value="D" class="mt-1" required />
                                <span class="flex-1">D) @question.OptionD</span>
                            </label>
                        </div>
                        
                        <div class="answer-display hidden mt-4 ml-12 bg-green-50 border-l-4 border-green-500 p-3 rounded">
                            <p class="font-semibold text-green-700">Correct Answer: @question.CorrectOption</p>
                            @if (!string.IsNullOrEmpty(question.Answer))
                            {
                                <p class="text-neutral-700 text-sm mt-1">@question.Answer</p>
                            }
                        </div>
                    </div>
                    questionNumber++;
                }

                <div class="flex justify-center space-x-4 mt-6">
                    <button type="button" onclick="resetQuiz()" class="bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-6 py-3 rounded-lg">
                        üîÑ Reset
                    </button>
                    <button type="submit" class="bg-gradient-primary hover:bg-primary-700 text-white px-8 py-3 rounded-lg">
                        ‚úì Submit Quiz
                    </button>
                </div>
            </form>

            <!-- Results Modal -->
            <div id="resultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <div class="text-center">
                        <div id="resultIcon" class="text-6xl mb-4"></div>
                        <h2 class="text-2xl font-bold text-primary-800 mb-2">Quiz Completed!</h2>
                        <div class="bg-primary-50 rounded-xl p-6 mb-4">
                            <p class="text-4xl font-bold text-primary-700 mb-2" id="scoreDisplay"></p>
                            <p class="text-neutral-600" id="correctDisplay"></p>
                        </div>
                        <div id="resultMessage" class="text-neutral-700 mb-6"></div>
                        <div class="space-y-2">
                            <button onclick="closeResults()" class="w-full bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg">
                                Close
                            </button>
                            <button onclick="resetQuiz()" class="w-full bg-neutral-200 hover:bg-neutral-300 text-neutral-700 px-6 py-3 rounded-lg">
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<script>
    function toggleAnswers() {
        const showAnswers = document.getElementById('showAnswers').checked;
        document.querySelectorAll('.answer-display').forEach(answer => {
            if (showAnswers) {
                answer.classList.remove('hidden');
            } else {
                answer.classList.add('hidden');
            }
        });
    }

    function resetQuiz() {
        document.getElementById('quizForm').reset();
        document.getElementById('resultsModal').classList.add('hidden');
        document.getElementById('showAnswers').checked = false;
        toggleAnswers();
        
        // Remove all result indicators
        document.querySelectorAll('.border-green-500, .border-red-500').forEach(el => {
            el.classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');
            el.classList.add('border-primary-200');
        });
    }

    document.getElementById('quizForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const answers = {};
        
        // Collect answers
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('question_')) {
                const questionId = key.replace('question_', '');
                answers[questionId] = value;
            }
        }
        
        try {
            const response = await fetch('@Url.Action("SubmitMCQQuiz")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chapterId: @chapter.Id,
                    answers: answers
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Mark correct/incorrect answers
                result.results.forEach(r => {
                    const options = document.querySelectorAll(`input[name="question_${r.questionId}"]`);
                    options.forEach(option => {
                        const label = option.closest('label');
                        label.classList.remove('border-primary-200', 'hover:bg-primary-50');
                        
                        if (option.value === r.studentAnswer) {
                            if (r.isCorrect) {
                                label.classList.add('border-green-500', 'bg-green-50');
                            } else {
                                label.classList.add('border-red-500', 'bg-red-50');
                            }
                        }
                        
                        if (option.value === r.correctAnswer) {
                            label.classList.add('border-green-500', 'bg-green-50');
                        }
                    });
                });
                
                // Show results
                const percentage = result.score;
                let icon, message;
                
                if (percentage >= 90) {
                    icon = 'üèÜ';
                    message = 'Outstanding! Excellent work!';
                } else if (percentage >= 75) {
                    icon = 'üéâ';
                    message = 'Great job! Well done!';
                } else if (percentage >= 60) {
                    icon = 'üëç';
                    message = 'Good effort! Keep practicing!';
                } else {
                    icon = 'üìö';
                    message = 'Keep studying! You can do better!';
                }
                
                document.getElementById('resultIcon').textContent = icon;
                document.getElementById('scoreDisplay').textContent = percentage.toFixed(1) + '%';
                document.getElementById('correctDisplay').textContent = `${result.correctCount} out of ${result.totalQuestions} correct`;
                document.getElementById('resultMessage').textContent = message;
                document.getElementById('resultsModal').classList.remove('hidden');
                
                // Auto-show answers
                document.getElementById('showAnswers').checked = true;
                toggleAnswers();
            }
        } catch (error) {
            // Show error message in a better way
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Error submitting quiz. Please try again.</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
            console.error(error);
        }
    });

    function closeResults() {
        document.getElementById('resultsModal').classList.add('hidden');
    }
</script>

@using UTS_SMS.Models
@model UTS_SMS.Controllers.TeacherController.TeacherDashboardViewModel

@{
    ViewData["Title"] = "Teacher Dashboard";
    var userName = Model.TeacherName ?? "Teacher";
    var lastMonth = new DateTime(Model.PayrollDetails.LastMonthYear, Model.PayrollDetails.LastMonthMonth, 1);
    var monthBeforeLast = new DateTime(Model.PayrollDetails.MonthBeforeLastYear, Model.PayrollDetails.MonthBeforeLastMonth, 1);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - SMS</title>

    <!-- Outfit Font - Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS - Offline -->
    <link rel="stylesheet" href="~/lib/tailwindcss/tailwind.min.css" asp-append-version="true" />

    <!-- Apache ECharts - Offline -->
    <script src="~/lib/echarts/echarts.min.js" asp-append-version="true"></script>

    <!-- Font Awesome - Offline -->
    <link rel="stylesheet" href="~/lib/fontawesome/css/all.min.css" asp-append-version="true" />
    
    <!-- SweetAlert2 - Offline -->
    <link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css" asp-append-version="true" />
    <script src=" "~/lib/sweetalert2/sweetalert2.min.js" asp-append-version="true"></script>

    <style>
        * {
            font-family: 'Outfit', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background: linear-gradient(180deg, #F5F1E8 0%, #E8E4D9 50%, #FFFEF9 100%);
        }

        .card-dark {
            background: linear-gradient(135deg, #2D2D2D 0%, #1a1a1a 100%);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15);
        }

        .profile-card {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .profile-blur {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 0%, transparent 100%);
            mask-image: linear-gradient(to top, black 0%, transparent 100%);
        }

        .timetable-slot {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.5rem 0.625rem;
            border-radius: 0.625rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
            min-width: 140px;
        }

        .timetable-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-day {
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            transform: scale(1.05);
        }

        .event-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #2D2D2D;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="p-4">
        <!-- Top Section: Profile + Attendance + Payroll + Awards -->
        <div class="flex gap-4 mb-4">

            <!-- Profile Card -->
            <div style="width: 220px; height: 320px; flex-shrink: 0;">
                <div class="profile-card">
                    @if (!string.IsNullOrEmpty(Model.ProfilePicture))
                    {
                        <img src="/@Model.ProfilePicture" alt="@Model.TeacherName" class="w-full h-full object-cover" />
                    }
                    else
                    {
                        <div class="w-full h-full bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-6xl text-white opacity-50"></i>
                        </div>
                    }
                    <div class="profile-blur flex flex-col justify-end p-4">
                        <h2 class="text-white font-bold text-base mb-2 drop-shadow-lg">@Model.TeacherName</h2>
                        <div class="space-y-1 text-white text-xs drop-shadow">
                            <div><i class="fas fa-building mr-1"></i>@Model.CampusName</div>
                            <div><i class="fas fa-calendar-check mr-1"></i>Attendance: @Model.AttendancePercentage%</div>
                            @if (Model.CurrentPerformance != null)
                            {
                                <div><i class="fas fa-star mr-1"></i>Score: @Model.CurrentPerformance.TotalScore.ToString("F1")/20</div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Attendance Card (Dark Theme) -->
            <div class="card-dark rounded-2xl p-4 flex flex-col flex-1" style="height: 320px;">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="fas fa-chart-line text-[#4CAF50]"></i>
                        My Attendance
                    </h3>
                    <div class="flex gap-1">
                        <button onclick="loadAttendanceChart('thisYear', event)" class="attendance-period-btn px-2 py-1 text-xs bg-[#FFD700] text-[#2D2D2D] rounded font-medium">Year</button>
                        <button onclick="loadAttendanceChart('lastYear', event)" class="attendance-period-btn px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded font-medium">Last</button>
                    </div>
                </div>
                <div id="attendanceTrendsChart" class="flex-grow w-full" style="min-height: 180px;"></div>
                <div class="grid grid-cols-3 gap-2 mt-3">
                    <div class="text-center p-2 bg-gray-800 rounded-lg">
                        <div class="text-lg font-bold text-white" id="totalDays">0</div>
                        <div class="text-xs text-gray-400">Total</div>
                    </div>
                    <div class="text-center p-2 bg-gray-800 rounded-lg">
                        <div class="text-lg font-bold text-[#4CAF50]" id="presentDays">0</div>
                        <div class="text-xs text-gray-400">Present</div>
                    </div>
                    <div class="text-center p-2 bg-gray-800 rounded-lg">
                        <div class="text-lg font-bold text-[#ef4444]" id="absentDays">0</div>
                        <div class="text-xs text-gray-400">Absent</div>
                    </div>
                </div>
            </div>

            <!-- Payroll Details Card (Compact) -->
            <div class="glassmorphism rounded-2xl p-4 flex flex-col" style="width: calc(25% - 1rem); height: 320px; flex-shrink: 0;">
                @{
                    var teacherJoiningDate = Model.Teacher.JoiningDate;
                    var joiningMonth = teacherJoiningDate.Month;
                    var joiningYear = teacherJoiningDate.Year;
                    var currentMonth = DateTime.Now.Month;
                    var currentYear = DateTime.Now.Year;
                    var isNewEmployee = (joiningYear == currentYear && joiningMonth == currentMonth);
                }
                
                @if (isNewEmployee)
                {
                    <!-- New employee message -->
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-[#2D2D2D] flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-[#FFD700] text-xs"></i>
                            </div>
                            Payroll
                        </h3>
                    </div>
                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-center p-4">
                            <i class="fas fa-user-clock text-4xl text-gray-400 mb-3"></i>
                            <h4 class="text-sm font-bold text-gray-700 mb-2">Welcome Aboard!</h4>
                            <p class="text-xs text-gray-600">You joined in @teacherJoiningDate.ToString("MMMM yyyy")</p>
                            <p class="text-xs text-gray-500 mt-2">Complete this month to view your payroll details</p>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Regular payroll display -->
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-[#2D2D2D] flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-[#FFD700] text-xs"></i>
                            </div>
                            Payroll
                        </h3>
                        <div class="flex items-center gap-1">
                            @if (Model.PayrollDetails.LastMonthRecord != null)
                            {
                                <button onclick="window.open('/PayrollReports/TransactionReceipt/@Model.PayrollDetails.LastMonthRecord.Id', '_blank')" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-700 transition-all" title="Print Receipt">
                                    <i class="fas fa-print text-xs"></i>
                                </button>
                                <button onclick="window.open('/PayrollReports/Details/@Model.Teacher.Id', '_blank')" class="w-6 h-6 rounded-full bg-blue-100 hover:bg-blue-200 flex items-center justify-center text-blue-700 transition-all" title="View Details">
                                    <i class="fas fa-info-circle text-xs"></i>
                                </button>
                            }
                            <button onclick="loadPayroll('lastMonth', event)" class="payroll-period-btn px-2 py-1 text-xs bg-[#FFD700] text-[#2D2D2D] rounded font-medium">@lastMonth.ToString("MMM")</button>
                            <button onclick="loadPayroll('monthBeforeLast', event)" class="payroll-period-btn px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded font-medium">@monthBeforeLast.ToString("MMM")</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 flex-shrink-0">
                        <div class="flex justify-between p-3 bg-gray-50 rounded-xl">
                            <span class="text-sm text-gray-600">Gross:</span>
                            <span class="text-sm font-bold text-[#2D2D2D]" id="grossSalary">@Model.PayrollDetails.LastMonthGross.ToString("C")</span>
                        </div>
                        <div class="flex justify-between p-3 bg-red-50 rounded-xl">
                            <span class="text-sm text-gray-600">Deductions:</span>
                            <span class="text-sm font-bold text-[#ef4444]" id="deductions">@Model.PayrollDetails.LastMonthDeductions.ToString("C")</span>
                        </div>
                        <div class="flex justify-between p-3 bg-green-50 rounded-xl">
                            <span class="text-sm text-gray-600">Net:</span>
                            <span class="text-sm font-bold text-[#4CAF50]" id="netSalary">@Model.PayrollDetails.LastMonthNet.ToString("C")</span>
                        </div>
                    </div>

                    @if (Model.PayrollDetails.LastMonthRecord != null)
                    {
                        <div class="mt-3 pt-3 border-t border-gray-200 flex-1 min-h-0">
                            <h4 class="text-xs font-bold text-gray-700 mb-2">Transaction Record</h4>
                            <div class="space-y-1.5">
                                @foreach (var transaction in Model.PayrollDetails.LastMonthRecord.Transactions.OrderByDescending(t => t.PaymentDate).Take(3))
                                {
                                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                                        <div class="flex-1">
                                            <div class="text-xs text-gray-600">@transaction.PaymentDate.ToString("MMM dd")</div>
                                            <div class="text-xs text-gray-500">@(transaction.CashPaid > 0 && transaction.OnlinePaid > 0 ? "Mixed" : transaction.CashPaid > 0 ? "Cash" : "Online")</div>
                                        </div>
                                        <span class="text-xs font-bold text-[#2D2D2D]">@transaction.AmountPaid.ToString("C")</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else if (Model.LeaveBalance != null)
                    {
                        <div class="mt-3 pt-3 border-t border-gray-200 flex-1 min-h-0">
                            <h4 class="text-xs font-bold text-gray-700 mb-2">Leave Balance</h4>
                            <div class="space-y-1.5">
                                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                                    <span class="text-xs text-gray-600">Casual:</span>
                                    <span class="text-xs font-bold text-[#2D2D2D]">@Model.LeaveBalance.CasualRemaining/@Model.LeaveBalance.CasualTotal</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-red-50 rounded-lg">
                                    <span class="text-xs text-gray-600">Sick:</span>
                                    <span class="text-xs font-bold text-[#2D2D2D]">@Model.LeaveBalance.SickRemaining/@Model.LeaveBalance.SickTotal</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                                    <span class="text-xs text-gray-600">Annual:</span>
                                    <span class="text-xs font-bold text-[#2D2D2D]">@Model.LeaveBalance.AnnualRemaining/@Model.LeaveBalance.AnnualTotal</span>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Teacher Awards Card (if any) -->
            @if (Model.AllTeacherAwards != null && Model.AllTeacherAwards.Any())
            {
                <div class="glassmorphism rounded-2xl p-4 flex flex-col" style="width: calc(25% - 1rem); height: 320px; flex-shrink: 0;">
                    <h3 class="text-sm font-bold text-[#2D2D2D] mb-3 flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                            <i class="fas fa-trophy text-[#FFD700] text-xs"></i>
                        </div>
                        My Awards
                    </h3>
                    <div class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1">
                        @foreach (var award in Model.AllTeacherAwards)
                        {
                            var awardMonthName = new DateTime(award.Year, award.Month, 1).ToString("MMM");
                            
                            <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-3 border border-yellow-200">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-base">
                                        ðŸ¥‡
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-800 text-xs">@awardMonthName @award.Year</div>
                                        <div class="text-xs text-gray-600">Teacher of Month</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-yellow-600">@award.Score.ToString("F1")</div>
                                        <div class="text-xs text-gray-500">/20</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Today's and Tomorrow's Timetable (Full Width) -->
        <div class="grid grid-cols-1 gap-4 mb-4">
            <!-- Today's Timetable -->
            <div class="glassmorphism rounded-2xl p-3 hover-lift">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-bold text-[#2D2D2D] flex items-center gap-2">
                        <i class="fas fa-clock text-[#4CAF50]"></i>
                        <span id="scheduleTitle">Today's Schedule</span>
                    </h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <span class="text-xs text-gray-600">Tomorrow</span>
                        <input type="checkbox" id="timetableToggle" onchange="toggleTimetable()" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div id="todaySchedule" class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                    @if (Model.TodayTimetable.Any())
                    {
                        @foreach (var slot in Model.TodayTimetable)
                        {
                            <div class="timetable-slot bg-green-50 border-2 border-green-300">
                                <div class="font-semibold text-[#2D2D2D] text-xs">@slot.SubjectName</div>
                                <div class="text-xs text-gray-600">@slot.ClassName - @slot.SectionName</div>
                                <div class="text-xs text-gray-500 flex items-center gap-1">
                                    <i class="fas fa-clock text-xs"></i>
                                    @slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm")
                                </div>
                                @if (!string.IsNullOrEmpty(slot.SubstitutionInfo))
                                {
                                    <div class="text-xs text-orange-600 mt-1">@slot.SubstitutionInfo</div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-xs text-gray-500 text-center py-4 w-full">No classes today</div>
                    }
                </div>
                <div id="tomorrowSchedule" class="hidden flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                    @if (Model.TomorrowTimetable.Any())
                    {
                        @foreach (var slot in Model.TomorrowTimetable)
                        {
                            <div class="timetable-slot bg-blue-50 border-2 border-blue-300">
                                <div class="font-semibold text-[#2D2D2D] text-xs">@slot.SubjectName</div>
                                <div class="text-xs text-gray-600">@slot.ClassName - @slot.SectionName</div>
                                <div class="text-xs text-gray-500 flex items-center gap-1">
                                    <i class="fas fa-clock text-xs"></i>
                                    @slot.StartTime.ToString(@"hh\:mm") - @slot.EndTime.ToString(@"hh\:mm")
                                </div>
                                @if (!string.IsNullOrEmpty(slot.SubstitutionInfo))
                                {
                                    <div class="text-xs text-orange-600 mt-1">@slot.SubstitutionInfo</div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-xs text-gray-500 text-center py-4 w-full">No classes tomorrow</div>
                    }
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="flex flex-col gap-4">

            <!-- Calendar and Performance Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                <!-- Calendar Card -->
                <div class="card-dark rounded-2xl p-4 hover-lift flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2">
                            <i class="fas fa-calendar-alt"></i>
                            Calendar
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="changeMonth(-1)" class="w-6 h-6 rounded-lg bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-white transition">
                                <i class="fas fa-chevron-left text-[10px]"></i>
                            </button>
                            <span id="currentMonthYear" class="text-white font-semibold text-xs"></span>
                            <button onclick="changeMonth(1)" class="w-6 h-6 rounded-lg bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-white transition">
                                <i class="fas fa-chevron-right text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                    <div id="dashboardCalendar" class="mb-3 flex-grow text-xs"></div>
                    <div id="calendarEventsContainer" class="hidden border-t border-gray-700 pt-3 mt-auto max-h-48 overflow-y-auto custom-scrollbar">
                        <h4 class="text-xs font-bold text-white mb-2" id="eventTitle">Events</h4>
                        <div id="calendarEvents" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Test-wise Performance Card -->
                <div class="glassmorphism rounded-2xl p-4 hover-lift flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-[#2D2D2D] flex items-center gap-2">
                            <i class="fas fa-chart-line text-[#FFD700]"></i>
                            Test-wise Performance
                        </h3>
                        <div class="flex gap-1">
                            <select id="testWiseSubjectFilter" onchange="loadTestWiseChart()" class="px-2 py-1 text-xs border border-gray-300 rounded font-medium">
                                <option value="">All Subjects</option>
                            </select>
                            <select id="testWiseCategoryFilter" onchange="loadTestWiseChart()" class="px-2 py-1 text-xs border border-gray-300 rounded font-medium">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                    <div id="testWiseChart" class="flex-grow" style="width: 100%; min-height: 250px;"></div>
                </div>

                <!-- Class-wise Performance Card -->
                <div class="glassmorphism rounded-2xl p-4 hover-lift flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-[#2D2D2D] flex items-center gap-2">
                            <i class="fas fa-chart-bar text-[#667eea]"></i>
                            Class-wise Average
                        </h3>
                        <select id="classWiseSubjectFilter" onchange="loadClassWiseChart()" class="px-2 py-1 text-xs border border-gray-300 rounded font-medium">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                    <div id="classWiseChart" class="flex-grow" style="width: 100%; min-height: 250px;"></div>
                </div>
            </div>

            <!-- Duties, To-Do, and Complaints Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Assigned Duties Card -->
                <div class="glassmorphism rounded-2xl p-3 hover-lift">
                    <h3 class="text-sm font-bold text-[#2D2D2D] mb-2 flex items-center gap-2">
                        <i class="fas fa-tasks text-purple-600"></i>
                        Assigned Duties
                    </h3>
                    <div class="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar pr-2">
                        @if (Model.AssignedDuties.Any())
                        {
                            @foreach (var duty in Model.AssignedDuties)
                            {
                                <div class="flex items-start gap-2 p-2 bg-white rounded-lg border border-gray-200 hover:border-purple-400 transition-all">
                                    <i class="fas fa-check-circle text-purple-600 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-xs font-semibold text-gray-800 truncate">@duty.DutyTitle</div>
                                        <div class="text-xs text-gray-600 truncate">@duty.Description</div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700">@duty.Status</span>
                                            <span class="text-xs text-gray-500">@duty.StartDate.ToString("MMM dd")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-xs text-gray-500 text-center py-8">No duties assigned</div>
                        }
                    </div>
                </div>

                <!-- To-Do List Card -->
                <div class="card-dark rounded-2xl p-3 hover-lift" id="todoListCard">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2">
                            <i class="fas fa-list-check"></i>
                            To-Do List
                        </h3>
                        <button onclick="showAddTodoModal()" class="w-7 h-7 rounded-full bg-[#FFD700] flex items-center justify-center text-[#2D2D2D] hover:bg-[#FFC700] transition-all" title="Add task">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                    <div id="todoListContainer" class="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar pr-2">
                        @foreach (var todo in Model.ToDoList)
                        {
                            <div class="todo-item flex items-start gap-2 p-2 @(todo.IsCompleted ? "bg-gray-800" : "bg-gray-700") rounded-lg" data-todo-id="@todo.Id" data-completed="@todo.IsCompleted.ToString().ToLower()">
                                <button class="todo-checkbox w-5 h-5 rounded @(todo.IsCompleted ? "bg-[#4CAF50]" : "border-2 border-gray-400") flex items-center justify-center flex-shrink-0 mt-0.5 cursor-pointer hover:opacity-80 transition-opacity" onclick="toggleToDo(@todo.Id)">
                                    @if (todo.IsCompleted)
                                    {
                                        <i class="fas fa-check text-xs text-white"></i>
                                    }
                                </button>
                                <div class="flex-1 min-w-0">
                                    <div class="todo-title text-xs font-medium text-white @(todo.IsCompleted ? "line-through" : "") truncate">@todo.Title</div>
                                    <div class="todo-desc text-xs text-gray-400 truncate">@todo.Description</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="todo-priority text-xs px-2 py-0.5 rounded @(todo.Priority == "High" ? "bg-red-500/20 text-red-300" : todo.Priority == "Medium" ? "bg-yellow-500/20 text-yellow-300" : "bg-blue-500/20 text-blue-300")">@todo.Priority</span>
                                        <span class="todo-date text-xs text-gray-400">@todo.DueDate.ToString("MMM dd")</span>
                                    </div>
                                </div>
                                <button class="w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 hover:bg-red-500/30 transition-all flex-shrink-0 mt-0.5" onclick="deleteToDo(@todo.Id)" title="Delete">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>

                <!-- Teacher Complaints Card -->
                <div class="glassmorphism rounded-2xl p-3 hover-lift">
                    <h3 class="text-sm font-bold text-[#2D2D2D] mb-2 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                        Student Complaints
                    </h3>
                    <div class="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar pr-2">
                        @if (Model.TeacherComplaints.Any())
                        {
                            @foreach (var complaint in Model.TeacherComplaints)
                            {
                                <div class="flex items-start gap-2 p-2 bg-white rounded-lg border-l-4 @(complaint.Priority == "High" ? "border-red-500" : complaint.Priority == "Medium" ? "border-yellow-500" : "border-blue-500") hover:shadow-md transition-all">
                                    <i class="fas fa-user-graduate @(complaint.Priority == "High" ? "text-red-600" : complaint.Priority == "Medium" ? "text-yellow-600" : "text-blue-600") mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-xs font-semibold text-gray-800 truncate">@complaint.Title</div>
                                        <div class="text-xs text-gray-600 truncate">@complaint.StudentName - @complaint.ClassName @complaint.SectionName</div>
                                        <div class="text-xs text-gray-500 truncate mt-0.5">@complaint.Description</div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs px-2 py-0.5 rounded @(complaint.Priority == "High" ? "bg-red-100 text-red-700" : complaint.Priority == "Medium" ? "bg-yellow-100 text-yellow-700" : "bg-blue-100 text-blue-700")">@complaint.Priority</span>
                                            <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700">@complaint.ComplaintType</span>
                                            <span class="text-xs text-gray-500">@complaint.ComplaintDate.ToString("MMM dd")</span>
                                        </div>
                                    </div>
                                    <a href="/StudentComplaint/Details/@complaint.Id" class="w-6 h-6 rounded-full bg-blue-100 hover:bg-blue-200 flex items-center justify-center text-blue-700 transition-all flex-shrink-0 mt-0.5" title="View Details">
                                        <i class="fas fa-eye text-xs"></i>
                                    </a>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-xs text-gray-500 text-center py-8">No open complaints</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const teacherId = @Model.TeacherId;
        let calendarCurrentMonth = new Date().getMonth();
        let calendarCurrentYear = new Date().getFullYear();
        let calendarEventsByDate = {};
        
        const payrollData = {
            lastMonth: {
                gross: @Model.PayrollDetails.LastMonthGross,
                deductions: @Model.PayrollDetails.LastMonthDeductions,
                net: @Model.PayrollDetails.LastMonthNet,
                record: @(Model.PayrollDetails.LastMonthRecord != null ? Model.PayrollDetails.LastMonthRecord.Id.ToString() : "null")
            },
            monthBeforeLast: {
                gross: @Model.PayrollDetails.MonthBeforeLastGross,
                deductions: @Model.PayrollDetails.MonthBeforeLastDeductions,
                net: @Model.PayrollDetails.MonthBeforeLastNet,
                record: @(Model.PayrollDetails.MonthBeforeLastRecord != null ? Model.PayrollDetails.MonthBeforeLastRecord.Id.ToString() : "null")
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            updateMonthYearDisplay();
            initCalendar();
            loadAttendanceChart('thisYear');
            loadSubjectFilters();
            loadCategoryFilter();
            loadClassWiseChart();
            loadTestWiseChart();
            
            window.addEventListener('resize', function() {
                echarts.getInstanceByDom(document.getElementById('attendanceTrendsChart'))?.resize();
                echarts.getInstanceByDom(document.getElementById('classWiseChart'))?.resize();
                echarts.getInstanceByDom(document.getElementById('testWiseChart'))?.resize();
            });
        });

        function updateMonthYearDisplay() {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('currentMonthYear').textContent = monthNames[calendarCurrentMonth] + ' ' + calendarCurrentYear;
        }

        function changeMonth(direction) {
            calendarCurrentMonth += direction;
            if (calendarCurrentMonth > 11) {
                calendarCurrentMonth = 0;
                calendarCurrentYear++;
            } else if (calendarCurrentMonth < 0) {
                calendarCurrentMonth = 11;
                calendarCurrentYear--;
            }
            updateMonthYearDisplay();
            loadCalendar(calendarCurrentYear, calendarCurrentMonth);
        }

        function initCalendar() {
            loadCalendar(calendarCurrentYear, calendarCurrentMonth);
        }

        function loadCalendar(year, month) {
            const calendarDiv = document.getElementById('dashboardCalendar');
            const today = new Date();
            
            fetch(`/Teacher/GetCalendarEventsByMonth?year=${year}&month=${month + 1}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;
                    
                    const events = data.events || [];
                    calendarEventsByDate = {};
                    
                    events.forEach(event => {
                        const date = new Date(event.startDate);
                        if (date.getMonth() === month && date.getFullYear() === year) {
                            const day = date.getDate();
                            if (!calendarEventsByDate[day]) calendarEventsByDate[day] = [];
                            calendarEventsByDate[day].push(event);
                        }
                    });

                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDay = new Date(year, month, 1).getDay();

                    let html = '<div class="grid grid-cols-7 gap-1 text-center">';
                    
                    ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach((day, i) => {
                        html += `<div class="text-xs font-medium ${i === 0 ? 'text-red-400' : 'text-gray-400'} py-1">${day}</div>`;
                    });

                    for (let i = 0; i < firstDay; i++) {
                        html += '<div></div>';
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const isSunday = date.getDay() === 0;
                        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                        const hasEvents = calendarEventsByDate[day]?.length > 0;
                        const isHoliday = hasEvents && calendarEventsByDate[day].some(e => e.isHoliday);
                        const hasExam = hasEvents && calendarEventsByDate[day].some(e => e.eventType === 'exam');
                        
                        let bgClass = isToday ? 'bg-[#FFD700] text-[#2D2D2D] font-bold' :
                                     isHoliday ? 'bg-blue-600 text-white' :
                                     isSunday ? 'bg-red-900/50 text-red-300' :
                                     hasExam ? 'bg-orange-600 text-white' :
                                     hasEvents ? 'bg-gray-600 text-white' :
                                     'bg-gray-800 text-gray-300 hover:bg-gray-700';
                        
                        html += `<div class="calendar-day p-2 rounded-lg ${bgClass} cursor-pointer text-xs" 
                                     onclick='showDayEvents(${day})'>
                            ${day}
                            ${hasEvents ? `<div class="event-dot ${hasExam ? 'bg-orange-300' : isHoliday ? 'bg-white' : 'bg-green-400'}"></div>` : ''}
                        </div>`;
                    }

                    html += '</div>';
                    calendarDiv.innerHTML = html;
                })
                .catch(error => console.error('Error loading calendar:', error));
        }

        function showDayEvents(day) {
            const events = calendarEventsByDate[day] || [];
            const date = new Date(calendarCurrentYear, calendarCurrentMonth, day);
            
            const container = document.getElementById('calendarEvents');
            const titleElement = document.getElementById('eventTitle');
            const eventsContainer = document.getElementById('calendarEventsContainer');
            
            titleElement.textContent = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            if (!events || events.length === 0) {
                eventsContainer.classList.add('hidden');
                return;
            }

            eventsContainer.classList.remove('hidden');
            
            let html = '';
            
            // Group exam events by exam name and subject
            const examEvents = events.filter(e => e.eventType === 'exam');
            const otherEvents = events.filter(e => e.eventType !== 'exam');
            
            // Group exams by exam name and subject
            const examGroups = {};
            examEvents.forEach(event => {
                const key = event.title; // Already contains "ExamName - SubjectName"
                if (!examGroups[key]) {
                    examGroups[key] = {
                        title: event.title,
                        examName: event.examName || event.title.split(' - ')[0],
                        subjectName: event.subjectName || event.title.split(' - ')[1],
                        description: event.description,
                        classes: event.classes || []
                    };
                }
            });
            
            // Display exam groups
            Object.values(examGroups).forEach(examGroup => {
                html += `<div class="p-2 bg-gray-800 rounded-lg border-l-4 border-orange-400">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-graduation-cap text-orange-400 text-xs mt-0.5"></i>
                        <div class="flex-1">
                            <div class="text-xs font-semibold text-white">${examGroup.title}</div>`;
                
                if (examGroup.description) {
                    html += `<div class="text-xs text-gray-400 mt-1">${examGroup.description}</div>`;
                }
                
                html += `</div>
                    </div>
                </div>`;
            });
            
            // Display other events
            otherEvents.forEach(event => {
                const icon = event.isHoliday ? 'fa-umbrella-beach' : 'fa-calendar-day';
                const borderColor = event.isHoliday ? 'border-blue-400' : 'border-gray-400';
                const iconColor = event.isHoliday ? 'text-blue-400' : 'text-gray-400';
                
                html += `<div class="p-2 bg-gray-800 rounded-lg border-l-4 ${borderColor}">
                    <div class="flex items-start gap-2">
                        <i class="fas ${icon} ${iconColor} text-xs mt-0.5"></i>
                        <div class="flex-1">
                            <div class="text-xs font-semibold text-white">${event.title}</div>
                            ${event.description ? `<div class="text-xs text-gray-400 mt-1">${event.description}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function loadAttendanceChart(period, event = null) {
            const chartDom = document.getElementById('attendanceTrendsChart');
            const myChart = echarts.getInstanceByDom(chartDom) || echarts.init(chartDom);
            
            const buttons = document.querySelectorAll('.attendance-period-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-[#FFD700]', 'text-[#2D2D2D]');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            let activeBtn;
            if (event && event.target) {
                activeBtn = event.target;
            } else {
                activeBtn = Array.from(buttons).find(btn => 
                    btn.getAttribute('onclick')?.includes(period)
                );
            }

            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-700', 'text-gray-300');
                activeBtn.classList.add('bg-[#FFD700]', 'text-[#2D2D2D]');
            }
            
            fetch(`/Teacher/GetAttendanceData?teacherId=${teacherId}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;
                    
                    document.getElementById('totalDays').textContent = data.totals.total;
                    document.getElementById('presentDays').textContent = data.totals.present;
                    document.getElementById('absentDays').textContent = data.totals.absent;

                    myChart.setOption({
                        tooltip: { trigger: 'axis' },
                        legend: { 
                            data: ['Present', 'Absent', 'Leave', 'Late'], 
                            bottom: 0,
                            left: 'center',
                            itemGap: 15,
                            textStyle: { fontSize: 10, color: '#fff' }
                        },
                        grid: { left: '10%', right: '10%', bottom: '20%', top: '10%' },
                        xAxis: { 
                            type: 'category', 
                            data: data.labels, 
                            axisLabel: { fontSize: 10, color: '#ccc' },
                            axisLine: { lineStyle: { color: '#555' } }
                        },
                        yAxis: { 
                            type: 'value', 
                            axisLabel: { fontSize: 10, color: '#ccc' },
                            axisLine: { lineStyle: { color: '#555' } },
                            splitLine: { lineStyle: { color: '#444' } }
                        },
                        series: [
                            {
                                name: 'Present',
                                type: 'line',
                                data: data.presentData,
                                smooth: true,
                                itemStyle: { color: '#4CAF50' },
                                areaStyle: { color: 'rgba(76, 175, 80, 0.2)' }
                            },
                            {
                                name: 'Absent',
                                type: 'line',
                                data: data.absentData,
                                smooth: true,
                                itemStyle: { color: '#ef4444' },
                                areaStyle: { color: 'rgba(239, 68, 68, 0.2)' }
                            },
                            {
                                name: 'Leave',
                                type: 'line',
                                data: data.leaveData,
                                smooth: true,
                                itemStyle: { color: '#FFD700' },
                                areaStyle: { color: 'rgba(255, 215, 0, 0.2)' }
                            },
                            {
                                name: 'Late',
                                type: 'line',
                                data: data.lateData,
                                smooth: true,
                                itemStyle: { color: '#f59e0b' },
                                areaStyle: { color: 'rgba(245, 158, 11, 0.2)' }
                            }
                        ]
                    });
                })
                .catch(error => console.error('Error loading attendance:', error));
        }

        function loadPayroll(period, event = null) {
            const buttons = document.querySelectorAll('.payroll-period-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-[#FFD700]', 'text-[#2D2D2D]');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            if (event && event.target) {
                event.target.classList.remove('bg-gray-200', 'text-gray-700');
                event.target.classList.add('bg-[#FFD700]', 'text-[#2D2D2D]');
            }
            
            const data = period === 'lastMonth' ? payrollData.lastMonth : payrollData.monthBeforeLast;
            
            document.getElementById('grossSalary').textContent = '$' + data.gross.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('deductions').textContent = '$' + data.deductions.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('netSalary').textContent = '$' + data.net.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // Update buttons visibility
            const payrollCard = document.querySelector('.glassmorphism:has(#grossSalary)');
            const printBtn = payrollCard.querySelector('[title="Print Receipt"]');
            const detailsBtn = payrollCard.querySelector('[title="View Details"]');
            
            if (printBtn && detailsBtn) {
                if (data.record) {
                    printBtn.style.display = 'flex';
                    detailsBtn.style.display = 'flex';
                    printBtn.onclick = () => window.open('/PayrollReports/TransactionReceipt/' + data.record, '_blank');
                } else {
                    printBtn.style.display = 'none';
                    detailsBtn.style.display = 'none';
                }
            }
        }

        function loadSubjectFilters() {
            fetch(`/Teacher/GetTeacherSubjects?teacherId=${teacherId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const classWiseFilter = document.getElementById('classWiseSubjectFilter');
                        const testWiseFilter = document.getElementById('testWiseSubjectFilter');
                        
                        data.subjects.forEach(subject => {
                            const option1 = new Option(subject.name, subject.id);
                            const option2 = new Option(subject.name, subject.id);
                            classWiseFilter.add(option1);
                            testWiseFilter.add(option2);
                        });
                    }
                });
        }

        function loadCategoryFilter() {
            fetch(`/Teacher/GetExamCategories?teacherId=${teacherId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const filter = document.getElementById('testWiseCategoryFilter');
                        data.categories.forEach(category => {
                            filter.add(new Option(category.name, category.id));
                        });
                    }
                });
        }

        function loadClassWiseChart() {
            const chartDom = document.getElementById('classWiseChart');
            if (!chartDom) return;
            
            const subjectId = document.getElementById('classWiseSubjectFilter')?.value || '';
            const url = `/Teacher/GetClassWiseData?teacherId=${teacherId}${subjectId ? '&subjectId=' + subjectId : ''}`;
            
            console.log('Loading class-wise chart from:', url);
            
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    console.log('Class-wise data received:', result);
                    
                    if (!result.success || !result.data || result.data.length === 0) {
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 text-xs">No data available</div>';
                        return;
                    }
                    
                    chartDom.innerHTML = '';
                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (myChart) {
                        myChart.dispose();
                    }
                    myChart = echarts.init(chartDom);
                    
                    // Group data by class-section
                    const groupedData = {};
                    result.data.forEach(d => {
                        if (!groupedData[d.className]) {
                            groupedData[d.className] = [];
                        }
                        groupedData[d.className].push(d);
                    });
                    
                    // Calculate average for each class-section across all subjects
                    const classes = Object.keys(groupedData);
                    const averages = classes.map(className => {
                        const subjects = groupedData[className];
                        const totalAvg = subjects.reduce((sum, s) => sum + s.averagePercentage, 0);
                        return Math.round(totalAvg / subjects.length * 100) / 100;
                    });

                    console.log('Chart classes:', classes);
                    console.log('Chart averages:', averages);

                    myChart.setOption({
                        tooltip: { 
                            trigger: 'axis',
                            formatter: function(params) {
                                const className = classes[params[0].dataIndex];
                                const subjects = groupedData[className];
                                let tooltipText = `<div style="font-weight: bold; margin-bottom: 8px;">${className}</div>`;
                                tooltipText += `<div style="font-size: 11px; color: #666; margin-bottom: 8px;">Average: ${averages[params[0].dataIndex].toFixed(1)}%</div>`;
                                tooltipText += `<div style="border-top: 1px solid #ddd; padding-top: 8px;">`;
                                subjects.forEach(subject => {
                                    tooltipText += `<div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-right: 6px;"></span>
                                        <span style="font-weight: 500;">${subject.subjectName}:</span> 
                                        <span style="color: #4CAF50; font-weight: bold;">${subject.averagePercentage.toFixed(1)}%</span>
                                        <span style="color: #999; font-size: 10px;"> (${subject.totalStudents} students, ${subject.totalTests} tests)</span>
                                    </div>`;
                                });
                                tooltipText += `</div>`;
                                return tooltipText;
                            }
                        },
                        grid: { left: '12%', right: '8%', bottom: '25%', top: '10%' },
                        xAxis: {
                            type: 'category',
                            data: classes,
                            axisLabel: { 
                                rotate: 45, 
                                interval: 0, 
                                fontSize: 9,
                                formatter: function(value) {
                                    return value.length > 15 ? value.substring(0, 15) + '...' : value;
                                }
                            }
                        },
                        yAxis: { 
                            type: 'value', 
                            max: 100, 
                            axisLabel: { fontSize: 10 },
                            name: 'Average %',
                            nameTextStyle: { fontSize: 10 }
                        },
                        series: [{
                            data: averages,
                            type: 'bar',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#667eea' },
                                    { offset: 1, color: '#764ba2' }
                                ])
                            },
                            barWidth: '50%',
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c}%',
                                fontSize: 9
                            }
                        }]
                    });
                    
                    setTimeout(() => myChart.resize(), 100);
                })
                .catch(error => {
                    console.error('Error loading class-wise chart:', error);
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-red-500 text-xs">Error loading data</div>';
                });
        }

        function loadTestWiseChart() {
            const chartDom = document.getElementById('testWiseChart');
            if (!chartDom) return;
            
            const subjectId = document.getElementById('testWiseSubjectFilter')?.value || '';
            const categoryId = document.getElementById('testWiseCategoryFilter')?.value || '';
            const url = `/Teacher/GetTestWiseData?teacherId=${teacherId}${subjectId ? '&subjectId=' + subjectId : ''}${categoryId ? '&categoryId=' + categoryId : ''}`;
            
            console.log('Loading test-wise chart from:', url);
            
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    console.log('Test-wise data received:', result);
                    
                    if (!result.success || !result.data || result.data.length === 0) {
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 text-xs">No data available</div>';
                        return;
                    }
                    
                    chartDom.innerHTML = '';
                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (myChart) {
                        myChart.dispose();
                    }
                    myChart = echarts.init(chartDom);
                    
                    // Group data by exam name only (not by class)
                    const groupedData = {};
                    result.data.forEach(d => {
                        const key = d.examName;
                        if (!groupedData[key]) {
                            groupedData[key] = {
                                examName: d.examName,
                                categoryName: d.categoryName,
                                classes: []
                            };
                        }
                        groupedData[key].classes.push({
                            className: d.className,
                            subjectName: d.subjectName,
                            averagePercentage: d.averagePercentage,
                            totalStudents: d.totalStudents
                        });
                    });
                    
                    // Calculate overall average for each exam across all classes and subjects
                    const exams = Object.keys(groupedData);
                    const averages = exams.map(examName => {
                        const classes = groupedData[examName].classes;
                        const totalAvg = classes.reduce((sum, c) => sum + c.averagePercentage, 0);
                        return Math.round(totalAvg / classes.length * 100) / 100;
                    });

                    console.log('Chart exams:', exams);
                    console.log('Chart averages:', averages);

                    myChart.setOption({
                        tooltip: { 
                            trigger: 'axis',
                            confine: true,
                            formatter: function(params) {
                                const examName = exams[params[0].dataIndex];
                                const examData = groupedData[examName];
                                let tooltipText = `<div style="font-weight: bold; font-size: 13px; margin-bottom: 6px;">${examName}</div>`;
                                tooltipText += `<div style="font-size: 11px; color: #666; margin-bottom: 8px;">${examData.categoryName}</div>`;
                                tooltipText += `<div style="font-size: 11px; color: #999; margin-bottom: 8px;">Overall Average: ${averages[params[0].dataIndex].toFixed(1)}%</div>`;
                                tooltipText += `<div style="border-top: 1px solid #ddd; padding-top: 8px; max-height: 200px; overflow-y: auto;">`;
                                
                                // Group by class-section
                                const classSections = {};
                                examData.classes.forEach(c => {
                                    if (!classSections[c.className]) {
                                        classSections[c.className] = [];
                                    }
                                    classSections[c.className].push(c);
                                });
                                
                                Object.keys(classSections).forEach(className => {
                                    const subjects = classSections[className];
                                    const classAvg = subjects.reduce((sum, s) => sum + s.averagePercentage, 0) / subjects.length;
                                    
                                    tooltipText += `<div style="margin-bottom: 8px; padding: 6px; background: #f9f9f9; border-radius: 4px;">`;
                                    tooltipText += `<div style="font-weight: bold; font-size: 11px; color: #333; margin-bottom: 4px;">${className} - Avg: ${classAvg.toFixed(1)}%</div>`;
                                    
                                    subjects.forEach(subject => {
                                        tooltipText += `<div style="margin-left: 8px; margin-bottom: 2px; font-size: 10px;">
                                            <span style="display: inline-block; width: 6px; height: 6px; background: #ffd700; border-radius: 50%; margin-right: 4px;"></span>
                                            <span style="font-weight: 500;">${subject.subjectName}:</span> 
                                            <span style="color: #4CAF50; font-weight: bold;">${subject.averagePercentage.toFixed(1)}%</span>
                                            <span style="color: #999;"> (${subject.totalStudents} students)</span>
                                        </div>`;
                                    });
                                    
                                    tooltipText += `</div>`;
                                });
                                
                                tooltipText += `</div>`;
                                return tooltipText;
                            }
                        },
                        grid: { left: '10%', right: '8%', bottom: '25%', top: '10%' },
                        xAxis: {
                            type: 'category',
                            data: exams,
                            axisLabel: { 
                                rotate: 45, 
                                interval: 0, 
                                fontSize: 9,
                                formatter: function(value) {
                                    return value.length > 15 ? value.substring(0, 15) + '...' : value;
                                }
                            }
                        },
                        yAxis: { 
                            type: 'value', 
                            max: 100, 
                            axisLabel: { fontSize: 10 },
                            name: 'Average %',
                            nameTextStyle: { fontSize: 10 }
                        },
                        series: [{
                            data: averages,
                            type: 'bar',
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: '#ffd700' },
                                    { offset: 1, color: '#ffa500' }
                                ])
                            },
                            barWidth: '50%',
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c}%',
                                fontSize: 9
                            }
                        }]
                    });
                    
                    setTimeout(() => myChart.resize(), 100);
                })
                .catch(error => {
                    console.error('Error loading test-wise chart:', error);
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-red-500 text-xs">Error loading data</div>';
                });
        }

        function toggleTimetable() {
            const todaySchedule = document.getElementById('todaySchedule');
            const tomorrowSchedule = document.getElementById('tomorrowSchedule');
            const scheduleTitle = document.getElementById('scheduleTitle');
            const toggle = document.getElementById('timetableToggle');
            
            if (toggle.checked) {
                todaySchedule.classList.add('hidden');
                tomorrowSchedule.classList.remove('hidden');
                scheduleTitle.textContent = "Tomorrow's Schedule";
            } else {
                todaySchedule.classList.remove('hidden');
                tomorrowSchedule.classList.add('hidden');
                scheduleTitle.textContent = "Today's Schedule";
            }
        }

        function showAddTodoModal() {
            Swal.fire({
                title: 'Add To-Do Item',
                html: `
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                            <input type="text" id="todoTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter title" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="todoDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Enter description"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                            <input type="date" id="todoDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${new Date().toISOString().split('T')[0]}" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Priority *</label>
                            <select id="todoPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Add To-Do',
                confirmButtonColor: '#FFD700',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const title = document.getElementById('todoTitle').value;
                    const description = document.getElementById('todoDescription').value;
                    const dueDate = document.getElementById('todoDueDate').value;
                    const priority = document.getElementById('todoPriority').value;
                    
                    if (!title) {
                        Swal.showValidationMessage('Title is required');
                        return false;
                    }
                    
                    if (!dueDate) {
                        Swal.showValidationMessage('Due date is required');
                        return false;
                    }
                    
                    return { title, description, dueDate, priority };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/Teacher/AddToDo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(result.value)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'To-Do Added!',
                                confirmButtonColor: '#FFD700',
                                timer: 1500,
                                showConfirmButton: false
                            });
                            refreshToDoList();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#FFD700'
                            });
                        }
                    });
                }
            });
        }

        function toggleToDo(todoId) {
            const todoItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            if (!todoItem) return;
            
            fetch(`/Teacher/ToggleToDo?id=${todoId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshToDoList();
                    }
                });
        }

        function deleteToDo(todoId) {
            Swal.fire({
                title: 'Delete Task?',
                text: 'Are you sure you want to delete this task?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it',
                confirmButtonColor: '#ef4444',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/Teacher/DeleteToDo?id=${todoId}`, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Deleted!',
                                    confirmButtonColor: '#FFD700',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                refreshToDoList();
                            }
                        });
                }
            });
        }

        function refreshToDoList() {
            fetch(`/Teacher/GetToDoListData?teacherId=${teacherId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;
                    
                    const container = document.getElementById('todoListContainer');
                    
                    if (!data.todos || data.todos.length === 0) {
                        container.innerHTML = '<div class="text-xs text-gray-400 text-center py-8">No tasks yet</div>';
                        return;
                    }
                    
                    let html = '';
                    data.todos.forEach(todo => {
                        const priorityClass = todo.priority === 'High' ? 'bg-red-500/20 text-red-300' :
                                            todo.priority === 'Medium' ? 'bg-yellow-500/20 text-yellow-300' :
                                            'bg-blue-500/20 text-blue-300';
                        const bgClass = todo.isCompleted ? 'bg-gray-800' : 'bg-gray-700';
                        const checkClass = todo.isCompleted ? 'bg-[#4CAF50]' : 'border-2 border-gray-400';
                        const titleClass = todo.isCompleted ? 'line-through' : '';
                        const dueDate = new Date(todo.dueDate);
                        const formattedDate = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        
                        html += `
                            <div class="todo-item flex items-start gap-2 p-2 ${bgClass} rounded-lg" data-todo-id="${todo.id}" data-completed="${todo.isCompleted}">
                                <button class="todo-checkbox w-5 h-5 rounded ${checkClass} flex items-center justify-center flex-shrink-0 mt-0.5 cursor-pointer hover:opacity-80 transition-opacity" onclick="toggleToDo(${todo.id})">
                                    ${todo.isCompleted ? '<i class="fas fa-check text-xs text-white"></i>' : ''}
                                </button>
                                <div class="flex-1 min-w-0">
                                    <div class="todo-title text-xs font-medium text-white ${titleClass} truncate">${todo.title}</div>
                                    <div class="todo-desc text-xs text-gray-400 truncate">${todo.description || ''}</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="todo-priority text-xs px-2 py-0.5 rounded ${priorityClass}">${todo.priority}</span>
                                        <span class="todo-date text-xs text-gray-400">${formattedDate}</span>
                                    </div>
                                </div>
                                <button class="w-6 h-6 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 hover:bg-red-500/30 transition-all flex-shrink-0 mt-0.5" onclick="deleteToDo(${todo.id})" title="Delete">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => console.error('Error refreshing to-do list:', error));
        }
    </script>
</body>
</html>

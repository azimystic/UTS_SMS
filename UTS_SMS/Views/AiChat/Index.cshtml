@model UTS_SMS.ViewModels.AiChatViewModel
@{
    ViewData["Title"] = "Chat with AI";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* ── AI Chat Module Styles ──────────────────────────────────────── */
    .ai-chat-container {
        display: flex;
        height: calc(100vh - 80px);
        margin: -24px -15px -20px -15px;
        background: #0f172a;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        overflow: hidden;
    }

    /* ── Left Sidebar: Conversations ──────────────────────────────── */
    .chat-sidebar {
        width: 280px;
        min-width: 280px;
        background: #1e293b;
        border-right: 1px solid #334155;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
    }

    .chat-sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #334155;
    }

    .new-chat-btn {
        width: 100%;
        padding: 10px 16px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .new-chat-btn:hover {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .conversation-item {
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        color: #94a3b8;
        font-size: 13px;
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.15s;
        position: relative;
    }

    .conversation-item:hover {
        background: #334155;
        color: #e2e8f0;
    }

    .conversation-item.active {
        background: #334155;
        color: #f1f5f9;
        font-weight: 500;
    }

    .conversation-item .conv-title {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .conversation-item .delete-conv {
        opacity: 0;
        color: #ef4444;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        transition: opacity 0.15s;
    }

    .conversation-item:hover .delete-conv {
        opacity: 1;
    }

    /* ── Main Chat Area ──────────────────────────────────────────── */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .chat-header {
        padding: 12px 20px;
        background: #1e293b;
        border-bottom: 1px solid #334155;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-header-title {
        color: #f1f5f9;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chat-header-title .ai-badge {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scroll-behavior: smooth;
    }

    /* ── Welcome State ───────────────────────────────────────────── */
    .welcome-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
    }

    .welcome-logo {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        animation: float 3s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
    }

    .welcome-title {
        color: #f1f5f9;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .welcome-subtitle {
        color: #64748b;
        font-size: 15px;
        margin-bottom: 32px;
    }

    .suggested-questions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        max-width: 800px;
        width: 100%;
    }

    .suggested-question {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 14px 16px;
        color: #cbd5e1;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s;
    }

    .suggested-question:hover {
        background: #334155;
        border-color: #6366f1;
        color: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .suggested-question i {
        color: #6366f1;
        font-size: 16px;
        min-width: 20px;
    }

    /* ── Message Bubbles ─────────────────────────────────────────── */
    .message {
        display: flex;
        gap: 12px;
        max-width: 85%;
        animation: fadeInUp 0.3s ease;
    }

    @@keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message.user-message {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .message.user-message .message-avatar {
        background: #6366f1;
        color: white;
    }

    .message.ai-message .message-avatar {
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.6;
    }

    .user-message .message-content {
        background: #6366f1;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .ai-message .message-content {
        background: #1e293b;
        color: #e2e8f0;
        border: 1px solid #334155;
        border-bottom-left-radius: 4px;
    }

    .ai-message .message-content p { margin-bottom: 8px; }
    .ai-message .message-content p:last-child { margin-bottom: 0; }
    .ai-message .message-content ul,
    .ai-message .message-content ol { padding-left: 20px; margin: 8px 0; }
    .ai-message .message-content li { margin-bottom: 4px; }
    .ai-message .message-content strong { color: #f1f5f9; }
    .ai-message .message-content code {
        background: #0f172a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
        color: #a5b4fc;
    }

    /* ── Thinking Steps ──────────────────────────────────────────── */
    .thinking-container {
        display: flex;
        gap: 12px;
        max-width: 85%;
        animation: fadeInUp 0.3s ease;
    }

    .thinking-steps {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 12px 16px;
        min-width: 300px;
    }

    .thinking-step {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        font-size: 13px;
        color: #94a3b8;
        animation: fadeInUp 0.3s ease;
    }

    .thinking-step .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
    }

    .thinking-step.active .step-icon {
        background: #6366f1;
        color: white;
        animation: pulse 1.5s infinite;
    }

    .thinking-step.done .step-icon {
        background: #22c55e;
        color: white;
    }

    @@keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        50% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); }
    }

    /* ── Source Citations ─────────────────────────────────────────── */
    .sources-container {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .source-badge {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 4px 10px;
        font-size: 11px;
        color: #a5b4fc;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
        text-decoration: none;
    }

    .source-badge:hover {
        background: #1e293b;
        border-color: #6366f1;
        color: #c7d2fe;
    }

    .source-badge i {
        font-size: 10px;
        color: #6366f1;
    }

    /* ── Right Sidebar: Documents ─────────────────────────────────── */
    .docs-sidebar {
        width: 260px;
        min-width: 260px;
        background: #1e293b;
        border-left: 1px solid #334155;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
    }

    .docs-sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #334155;
        color: #f1f5f9;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .docs-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .doc-item {
        padding: 8px 12px;
        border-radius: 8px;
        color: #94a3b8;
        font-size: 12px;
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .doc-item i {
        color: #ef4444;
        font-size: 14px;
    }

    .doc-item .doc-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .doc-item .doc-chunks {
        color: #64748b;
        font-size: 10px;
    }

    .active-sources-header {
        padding: 12px 16px;
        border-bottom: 1px solid #334155;
        color: #94a3b8;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .active-source-item {
        padding: 8px 12px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        margin: 4px 8px;
        color: #a5b4fc;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: fadeInUp 0.3s ease;
    }

    .active-source-item i {
        color: #6366f1;
    }

    /* ── Input Area ──────────────────────────────────────────────── */
    .chat-input-container {
        padding: 16px 20px;
        background: #1e293b;
        border-top: 1px solid #334155;
    }

    .chat-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        max-width: 800px;
        margin: 0 auto;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 8px 12px;
        transition: border-color 0.2s;
    }

    .chat-input-wrapper:focus-within {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .chat-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #f1f5f9;
        font-size: 14px;
        padding: 8px 4px;
        resize: none;
        max-height: 120px;
        line-height: 1.5;
        outline: none;
    }

    .chat-input::placeholder {
        color: #475569;
    }

    .send-btn {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border: none;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        transform: scale(1.05);
    }

    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .chat-input-hint {
        text-align: center;
        padding: 4px 0 0 0;
        font-size: 11px;
        color: #475569;
    }

    /* ── Typing Indicator ────────────────────────────────────────── */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 4px 0;
    }

    .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #6366f1;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-6px); opacity: 1; }
    }

    /* Ingest button */
    .ingest-btn {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
    }

    .ingest-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .ingest-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Mobile responsive */
    @@media (max-width: 1024px) {
        .docs-sidebar { display: none; }
    }
    @@media (max-width: 768px) {
        .chat-sidebar { display: none; }
        .ai-chat-container { margin: -12px -10px; }
    }

    /* Scrollbar styling */
    .chat-messages::-webkit-scrollbar,
    .conversations-list::-webkit-scrollbar,
    .docs-list::-webkit-scrollbar {
        width: 4px;
    }
    .chat-messages::-webkit-scrollbar-track,
    .conversations-list::-webkit-scrollbar-track,
    .docs-list::-webkit-scrollbar-track {
        background: transparent;
    }
    .chat-messages::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
    }
</style>

<div class="ai-chat-container">
    <!-- ── Left Sidebar: Conversations ────────────────────────────── -->
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i>
                New Chat
            </button>
        </div>
        <div class="conversations-list" id="conversationsList">
            <!-- Populated by SignalR -->
        </div>
    </div>

    <!-- ── Main Chat Area ─────────────────────────────────────────── -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-header-title">
                <i class="fas fa-robot" style="color: #8b5cf6;"></i>
                School AI Assistant
                <span class="ai-badge">GEMINI</span>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Welcome State -->
            <div class="welcome-state" id="welcomeState">
                <div class="welcome-logo">
                    <i class="fas fa-brain"></i>
                </div>
                <h2 class="welcome-title">Hello, @Model.UserName!</h2>
                <p class="welcome-subtitle">I'm your AI school assistant. Ask me about grades, study materials, or performance.</p>

                <div class="suggested-questions">
                    @foreach (var question in Model.SuggestedQuestions)
                    {
                        <div class="suggested-question" onclick="askSuggestedQuestion('@question.Text.Replace("'", "\\'")') ">
                            <i class="@question.Icon"></i>
                            <span>@question.Text</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea class="chat-input"
                          id="chatInput"
                          placeholder="Ask me anything about your grades, study materials..."
                          rows="1"
                          onkeydown="handleInputKeydown(event)"
                          oninput="autoResizeInput(this)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="chat-input-hint">
                AI responses are generated using your school data. Always verify important information.
            </div>
        </div>
    </div>

    <!-- ── Right Sidebar: Active Documents ────────────────────────── -->
    <div class="docs-sidebar">
        <div class="docs-sidebar-header">
            <i class="fas fa-file-alt"></i>
            Knowledge Base
        </div>

        <!-- Drag-and-drop PDF upload area -->
        <div id="pdfDropArea" style="margin:12px 8px; padding:18px 10px; border:2px dashed #6366f1; border-radius:12px; background:#0f172a; color:#a5b4fc; text-align:center; cursor:pointer; transition:background 0.2s;">
            <i class="fas fa-cloud-upload-alt" style="font-size:22px;"></i><br>
            <span id="pdfDropText">Drag & drop PDF here or <span style='color:#6366f1;text-decoration:underline;cursor:pointer;' onclick='document.getElementById("pdfFileInput").click()'>browse</span></span>
            <input type="file" id="pdfFileInput" accept="application/pdf" style="display:none" onchange="handlePdfFile(this.files)" />
        </div>
        <div id="pdfUploadStatus" style="font-size:12px;color:#94a3b8;margin:4px 8px 0 8px;"></div>

        @if (Model.UserRole == "Admin")
        {
            <div style="padding: 8px;">
                <button class="ingest-btn" id="ingestBtn" onclick="ingestDocuments()" style="width:100%;">
                    <i class="fas fa-upload"></i> Index PDFs into AI Brain
                </button>
            </div>
        }

        <div id="ingestionLog" style="padding: 0 8px; display: none;">
            <div style="color: #94a3b8; font-size: 11px; padding: 8px 4px; border-bottom: 1px solid #334155; margin-bottom: 4px;">
                Ingestion Progress:
            </div>
            <div id="ingestionMessages" style="max-height: 200px; overflow-y: auto; font-size: 11px; color: #94a3b8;"></div>
        </div>

        <div class="docs-list" id="docsList">
            <div style="color: #475569; font-size: 12px; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading documents...
            </div>
        </div>

        <div class="active-sources-header" id="activeSourcesHeader" style="display:none;">
            <i class="fas fa-search"></i> Sources Used in Response
        </div>
        <div id="activeSources"></div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>
        // ── State ──────────────────────────────────────────────────────
        let connection = null;
        let currentConversationId = null;
        let isStreaming = false;
        let currentAiMessageEl = null;
        let currentResponseText = '';

        // ── SignalR Connection ──────────────────────────────────────────
        async function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/aichat-hub")
                .withAutomaticReconnect()
                .build();

            // Event handlers
            connection.on("ConversationCreated", (id) => {
                currentConversationId = id;
                loadConversations();
            });

            connection.on("ThinkingStep", (step) => {
                showThinkingStep(step);
            });

            connection.on("StreamStarted", () => {
                hideThinking();
                startAiMessage();
            });

            connection.on("ContentChunk", (text) => {
                appendToAiMessage(text);
            });

            connection.on("SourceCitation", (sourceJson) => {
                try {
                    const source = JSON.parse(sourceJson);
                    addSourceCitation(source);
                } catch { }
            });

            connection.on("StreamComplete", (convId) => {
                finishStreaming();
                currentConversationId = convId;
                loadConversations();
            });

            connection.on("Error", (err) => {
                finishStreaming();
                showError(err);
            });

            connection.on("ConversationsList", (conversations) => {
                renderConversations(conversations);
            });

            connection.on("ConversationMessages", (convId, messages) => {
                currentConversationId = convId;
                renderConversationMessages(messages);
                highlightActiveConversation(convId);
            });

            connection.on("ConversationDeleted", (convId, success) => {
                if (success) {
                    if (currentConversationId === convId) startNewChat();
                    loadConversations();
                }
            });

            connection.on("IngestionProgress", (msg) => {
                appendIngestionLog(msg);
            });

            connection.on("IngestionComplete", (msg) => {
                appendIngestionLog(msg);
                document.getElementById('ingestBtn')?.removeAttribute('disabled');
                loadDocuments();
            });

            connection.onreconnecting(() => {
                showConnectionStatus('Reconnecting...');
            });

            connection.onreconnected(() => {
                showConnectionStatus('Connected');
                setTimeout(() => hideConnectionStatus(), 2000);
            });

            try {
                await connection.start();
                console.log("SignalR connected");
                loadConversations();
                loadDocuments();
            } catch (err) {
                console.error("SignalR connection error:", err);
                showError("Failed to connect to AI service. Please refresh the page.");
            }
        }

        // ── Send Message ───────────────────────────────────────────────
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || isStreaming) return;

            // Hide welcome state
            document.getElementById('welcomeState')?.remove();

            // Show user message
            addUserMessage(message);

            // Clear input
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;

            // Show thinking state
            isStreaming = true;
            updateSendButton();
            showThinkingContainer();

            // Clear active sources
            clearActiveSources();

            try {
                await connection.invoke("SendMessage", currentConversationId, message);
            } catch (err) {
                finishStreaming();
                showError("Failed to send message: " + err.toString());
            }
        }

        function askSuggestedQuestion(text) {
            document.getElementById('chatInput').value = text;
            document.getElementById('sendBtn').disabled = false;
            sendMessage();
        }

        // ── Message Rendering ──────────────────────────────────────────
        function addUserMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgHtml = `
                <div class="message user-message">
                    <div class="message-avatar"><i class="fas fa-user"></i></div>
                    <div class="message-content">${escapeHtml(text)}</div>
                </div>`;
            messagesDiv.insertAdjacentHTML('beforeend', msgHtml);
            scrollToBottom();
        }

        function startAiMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-message';
            msgDiv.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content" id="currentAiContent"></div>`;
            messagesDiv.appendChild(msgDiv);
            currentAiMessageEl = document.getElementById('currentAiContent');
            currentResponseText = '';
            scrollToBottom();
        }

        function appendToAiMessage(text) {
            if (!currentAiMessageEl) startAiMessage();
            currentResponseText += text;
            currentAiMessageEl.innerHTML = formatMarkdown(currentResponseText);
            scrollToBottom();
        }

        function showThinkingContainer() {
            const messagesDiv = document.getElementById('chatMessages');
            // Remove any existing thinking container
            document.getElementById('thinkingContainer')?.remove();

            const thinkDiv = document.createElement('div');
            thinkDiv.id = 'thinkingContainer';
            thinkDiv.className = 'thinking-container';
            thinkDiv.innerHTML = `
                <div class="message-avatar" style="background: linear-gradient(135deg, #6366f1, #a855f7); color: white; width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="thinking-steps" id="thinkingSteps">
                    <div class="thinking-step active">
                        <div class="step-icon"><i class="fas fa-spinner fa-spin" style="font-size:8px;"></i></div>
                        <span>Analyzing your question...</span>
                    </div>
                </div>`;
            messagesDiv.appendChild(thinkDiv);
            scrollToBottom();
        }

        function showThinkingStep(stepText) {
            const stepsDiv = document.getElementById('thinkingSteps');
            if (!stepsDiv) return;

            // Mark previous steps as done
            stepsDiv.querySelectorAll('.thinking-step.active').forEach(s => {
                s.classList.remove('active');
                s.classList.add('done');
                s.querySelector('.step-icon').innerHTML = '<i class="fas fa-check" style="font-size:8px;"></i>';
            });

            // Add new step
            const step = document.createElement('div');
            step.className = 'thinking-step active';
            step.innerHTML = `
                <div class="step-icon"><i class="fas fa-spinner fa-spin" style="font-size:8px;"></i></div>
                <span>${escapeHtml(stepText)}</span>`;
            stepsDiv.appendChild(step);
            scrollToBottom();
        }

        function hideThinking() {
            const container = document.getElementById('thinkingContainer');
            if (container) {
                // Mark all remaining as done
                container.querySelectorAll('.thinking-step.active').forEach(s => {
                    s.classList.remove('active');
                    s.classList.add('done');
                    s.querySelector('.step-icon').innerHTML = '<i class="fas fa-check" style="font-size:8px;"></i>';
                });
                // Fade out after brief delay
                setTimeout(() => {
                    container.style.opacity = '0.5';
                    container.style.transition = 'opacity 0.3s';
                }, 500);
            }
        }

        function addSourceCitation(source) {
            // Add to message content  
            if (currentAiMessageEl) {
                let sourcesDiv = currentAiMessageEl.querySelector('.sources-container');
                if (!sourcesDiv) {
                    sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'sources-container';
                    currentAiMessageEl.appendChild(sourcesDiv);
                }
                sourcesDiv.innerHTML += `
                    <a class="source-badge" href="/${source.filePath}" target="_blank" title="Open ${source.fileName}">
                        <i class="fas fa-file-pdf"></i>
                        ${escapeHtml(source.fileName)} (p.${source.pageNumber})
                    </a>`;
            }

            // Add to right sidebar active sources
            const activeDiv = document.getElementById('activeSources');
            document.getElementById('activeSourcesHeader').style.display = '';
            activeDiv.innerHTML += `
                <div class="active-source-item">
                    <i class="fas fa-file-pdf"></i>
                    <span>${escapeHtml(source.fileName)} — ${escapeHtml(source.chapterName)} (p.${source.pageNumber})</span>
                </div>`;
        }

        function clearActiveSources() {
            document.getElementById('activeSources').innerHTML = '';
            document.getElementById('activeSourcesHeader').style.display = 'none';
        }

        function finishStreaming() {
            isStreaming = false;
            currentAiMessageEl = null;
            updateSendButton();
        }

        function showError(msg) {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.insertAdjacentHTML('beforeend', `
                <div class="message ai-message">
                    <div class="message-avatar" style="background: #ef4444;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="message-content" style="border-color: #ef4444; color: #fca5a5;">
                        ${escapeHtml(msg)}
                    </div>
                </div>`);
            scrollToBottom();
        }

        // ── Conversations ──────────────────────────────────────────────
        function loadConversations() {
            if (connection?.state === signalR.HubConnectionState.Connected) {
                connection.invoke("GetConversations").catch(console.error);
            }
        }

        function renderConversations(conversations) {
            const list = document.getElementById('conversationsList');
            if (!conversations.length) {
                list.innerHTML = '<div style="color: #475569; font-size: 12px; text-align: center; padding: 20px;">No conversations yet</div>';
                return;
            }

            list.innerHTML = conversations.map(c => `
                <div class="conversation-item ${c.id === currentConversationId ? 'active' : ''}"
                     onclick="loadConversation(${c.id})">
                    <i class="fas fa-comment" style="font-size: 12px;"></i>
                    <span class="conv-title">${escapeHtml(c.title)}</span>
                    <span class="delete-conv" onclick="event.stopPropagation(); deleteConversation(${c.id});">
                        <i class="fas fa-trash"></i>
                    </span>
                </div>`).join('');
        }

        function loadConversation(id) {
            currentConversationId = id;
            highlightActiveConversation(id);
            connection.invoke("LoadConversation", id).catch(console.error);
        }

        function renderConversationMessages(messages) {
            const div = document.getElementById('chatMessages');
            div.innerHTML = '';

            messages.forEach(msg => {
                if (msg.role === 'user') {
                    addUserMessage(msg.content);
                } else if (msg.role === 'assistant') {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message ai-message';
                    let sourcesHtml = '';
                    if (msg.sources) {
                        try {
                            const sources = JSON.parse(msg.sources);
                            if (sources.length) {
                                sourcesHtml = '<div class="sources-container">' +
                                    sources.map(s => `<a class="source-badge" href="/${s.FilePath || s.filePath}" target="_blank">
                                        <i class="fas fa-file-pdf"></i>
                                        ${escapeHtml(s.FileName || s.fileName)} (p.${s.PageNumber || s.pageNumber})
                                    </a>`).join('') + '</div>';
                            }
                        } catch { }
                    }
                    msgDiv.innerHTML = `
                        <div class="message-avatar"><i class="fas fa-robot"></i></div>
                        <div class="message-content">${formatMarkdown(msg.content)}${sourcesHtml}</div>`;
                    div.appendChild(msgDiv);
                }
            });

            scrollToBottom();
        }

        function deleteConversation(id) {
            if (confirm('Delete this conversation?')) {
                connection.invoke("DeleteConversation", id).catch(console.error);
            }
        }

        function highlightActiveConversation(id) {
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.conversation-item').forEach(el => {
                if (el.getAttribute('onclick')?.includes(id)) el.classList.add('active');
            });
        }

        function startNewChat() {
            currentConversationId = null;
            const div = document.getElementById('chatMessages');
            div.innerHTML = `
                <div class="welcome-state" id="welcomeState">
                    <div class="welcome-logo"><i class="fas fa-brain"></i></div>
                    <h2 class="welcome-title">Hello, @Model.UserName!</h2>
                    <p class="welcome-subtitle">I'm your AI school assistant. Ask me about grades, study materials, or performance.</p>
                    <div class="suggested-questions">
                        @foreach (var question in Model.SuggestedQuestions)
                        {
                            <text>
                            <div class="suggested-question" onclick="askSuggestedQuestion('@question.Text.Replace("'", "\\'")') ">
                                <i class="@question.Icon"></i>
                                <span>@question.Text</span>
                            </div>
                            </text>
                        }
                    </div>
                </div>`;
            clearActiveSources();
            highlightActiveConversation(null);
        }

        // ── Documents List ─────────────────────────────────────────────
        async function loadDocuments() {
            try {
                const res = await fetch('/AiChat/Documents');
                const docs = await res.json();
                const list = document.getElementById('docsList');

                if (!docs.length) {
                    list.innerHTML = '<div style="color: #475569; font-size: 12px; text-align: center; padding: 20px;"><i class="fas fa-inbox"></i><br>No documents indexed yet</div>';
                    return;
                }

                list.innerHTML = docs.map(d => `
                    <div class="doc-item">
                        <i class="fas fa-file-pdf"></i>
                        <span class="doc-name" title="${escapeHtml(d.fileName)}">${escapeHtml(d.fileName)}</span>
                        <span class="doc-chunks">${d.chunkCount} chunks</span>
                    </div>`).join('');
            } catch {
                document.getElementById('docsList').innerHTML =
                    '<div style="color: #475569; font-size: 12px; text-align: center; padding: 20px;">ChromaDB not connected</div>';
            }
        }

        // ── PDF Ingestion ──────────────────────────────────────────────
        function ingestDocuments() {
            const btn = document.getElementById('ingestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Indexing...';

            document.getElementById('ingestionLog').style.display = '';
            document.getElementById('ingestionMessages').innerHTML = '';

            connection.invoke("IngestDocuments").catch(err => {
                appendIngestionLog('❌ Error: ' + err.toString());
                btn.removeAttribute('disabled');
            });
        }

        function appendIngestionLog(msg) {
            const div = document.getElementById('ingestionMessages');
            const line = document.createElement('div');
            line.style.padding = '2px 4px';
            line.textContent = msg;
            div.appendChild(line);
            div.scrollTop = div.scrollHeight;
        }

        // ── PDF Drag-and-Drop Upload ─────────────────────────────
        const pdfDropArea = document.getElementById('pdfDropArea');
        const pdfFileInput = document.getElementById('pdfFileInput');
        const pdfUploadStatus = document.getElementById('pdfUploadStatus');
        if (pdfDropArea) {
            pdfDropArea.addEventListener('dragover', e => {
                e.preventDefault();
                pdfDropArea.style.background = '#1e293b';
            });
            pdfDropArea.addEventListener('dragleave', e => {
                e.preventDefault();
                pdfDropArea.style.background = '#0f172a';
            });
            pdfDropArea.addEventListener('drop', e => {
                e.preventDefault();
                pdfDropArea.style.background = '#0f172a';
                if (e.dataTransfer.files.length) handlePdfFile(e.dataTransfer.files);
            });
            pdfDropArea.addEventListener('click', () => pdfFileInput.click());
        }
        function handlePdfFile(files) {
            if (!files.length) return;
            const file = files[0];
            if (file.type !== 'application/pdf') {
                pdfUploadStatus.textContent = 'Only PDF files are allowed.';
                return;
            }
            pdfUploadStatus.textContent = 'Uploading...';
            const formData = new FormData();
            formData.append('file', file);
            fetch('/AiChat/UploadPdf', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    pdfUploadStatus.textContent = 'Upload successful!';
                    loadDocuments();
                } else {
                    pdfUploadStatus.textContent = 'Upload failed: ' + (res.error || 'Unknown error');
                }
            })
            .catch(() => pdfUploadStatus.textContent = 'Upload failed.');
        }

        // ── Utilities ──────────────────────────────────────────────────
        function scrollToBottom() {
            const div = document.getElementById('chatMessages');
            div.scrollTop = div.scrollHeight;
        }

        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeInput(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
            document.getElementById('sendBtn').disabled = !el.value.trim() || isStreaming;
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            const input = document.getElementById('chatInput');
            btn.disabled = !input.value.trim() || isStreaming;
            if (isStreaming) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Bold: **text**
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic: *text*
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Code: `text`
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            // Headers: ### text
            html = html.replace(/^### (.*$)/gm, '<h4 style="color:#a5b4fc;margin:8px 0 4px;">$1</h4>');
            html = html.replace(/^## (.*$)/gm, '<h3 style="color:#c7d2fe;margin:10px 0 4px;">$1</h3>');
            // Bullet lists: • or -
            html = html.replace(/^[•\-] (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul style="padding-left:20px;margin:8px 0;">$&</ul>');
            // Numbered lists
            html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
            // Newlines to <br>
            html = html.replace(/\n/g, '<br>');
            // Clean up double <br> inside lists
            html = html.replace(/<\/li><br>/g, '</li>');
            return html;
        }

        function showConnectionStatus(msg) {
            // Could show a banner; keeping simple for hackathon
            console.log('Connection status:', msg);
        }

        function hideConnectionStatus() { }

        // ── Initialize ─────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', initializeConnection);
    </script>
}

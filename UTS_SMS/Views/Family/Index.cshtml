@using UTS_SMS.Models
@model IEnumerable<Family>

@{
    ViewData["Title"] = "Families";
    var campusList = ViewBag.Campuses as IEnumerable<dynamic>;
}

<div class="min-h-screen bg-neutral-50 p-3 md:p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-primary-800 mb-3 md:mb-0">Families</h1>
    </div>

    <!-- Mobile Filter Button -->
    <div class="md:hidden mb-4">
        <button id="mobile-filter-toggle" class="w-full bg-gradient-primary text-white py-2 px-4 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            Filter Families
        </button>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="bg-white p-4 md:p-6 rounded-lg shadow-sm mb-6 hidden md:block">
        <form id="filter-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
            @if (campusList?.Count() > 1)
            {
                <div>
                    <label for="campus-filter" class="block text-sm font-medium text-neutral-700 mb-1">Campus</label>
                    <select id="campus-filter" name="campusFilter" class="w-full px-3 py-2 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400 text-sm">
                        <option value="">All Campuses</option>
                        @foreach (var campus in campusList)
                        {
                            <option value="@campus.Id">@campus.Name</option>
                        }
                    </select>
                </div>
            }
            <div>
                <label for="father-name-filter" class="block text-sm font-medium text-neutral-700 mb-1">Father Name</label>
                <input type="text" id="father-name-filter" name="fatherNameFilter" 
                       class="w-full px-3 py-2 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400 text-sm" 
                       placeholder="Search by father name">
            </div>
            <div class="flex items-end">
                <button type="button" onclick="filterFamilies()" 
                        class="w-full bg-gradient-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                    Search
                </button>
            </div>
            <div class="flex items-end">
                <button type="button" onclick="clearFilters()" 
                        class="w-full bg-neutral-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300 text-sm">
                    Clear
                </button>
            </div>
        </form>
    </div>

    <!-- Family Cards/Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full">
                <thead class="bg-neutral-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Father Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">CNIC</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Students</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Campus</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-primary-100" id="family-table-body">
                    @foreach (var family in Model)
                    {
                        <tr class="hover:bg-neutral-50 family-row" 
                            data-campus-id="@family.CampusId" 
                            data-father-name="@family.FatherName.ToLower()">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-primary-800">@family.FatherName</div>
                                @if (family.IsFatherDeceased)
                                {
                                    <div class="text-sm text-error">Deceased</div>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@family.FatherCNIC</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@family.FatherPhone</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                    @family.Students.Count() Students
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-primary-800">@family.Campus?.Name</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a asp-action="Details" asp-route-id="@family.Id" 
                                       class="text-primary-600 hover:text-primary-800 transition-colors duration-300">Details</a>
                                    <a asp-action="Edit" asp-route-id="@family.Id" 
                                       class="text-info hover:text-indigo-900 transition-colors duration-300">Edit</a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden space-y-4 p-4" id="family-cards">
            @foreach (var family in Model)
            {
                <div class="family-card bg-white border border-primary-100 rounded-lg p-4 shadow-sm" 
                     data-campus-id="@family.CampusId" 
                     data-father-name="@family.FatherName.ToLower()">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-primary-800">@family.FatherName</h3>
                            @if (family.IsFatherDeceased)
                            {
                                <span class="text-sm text-error">Deceased</span>
                            }
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                            @family.Students.Count() Students
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="text-sm text-neutral-600">
                            <span class="font-medium">CNIC:</span> @family.FatherCNIC
                        </div>
                        @if (!string.IsNullOrEmpty(family.FatherPhone))
                        {
                            <div class="text-sm text-neutral-600">
                                <span class="font-medium">Phone:</span> @family.FatherPhone
                            </div>
                        }
                        <div class="text-sm text-neutral-600">
                            <span class="font-medium">Campus:</span> @family.Campus?.Name
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <a asp-action="Details" asp-route-id="@family.Id" 
                           class="flex-1 bg-gradient-primary hover:bg-primary-700 text-white text-center py-2 px-4 rounded-lg text-sm transition-all duration-300">
                            Details
                        </a>
                        <a asp-action="Edit" asp-route-id="@family.Id" 
                           class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-center py-2 px-4 rounded-lg text-sm transition-all duration-300">
                            Edit
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    // Mobile filter toggle
    document.getElementById('mobile-filter-toggle').addEventListener('click', function() {
        const filterPanel = document.getElementById('filter-panel');
        filterPanel.classList.toggle('hidden');
    });

    function filterFamilies() {
        const campusFilter = document.getElementById('campus-filter')?.value.toLowerCase() || '';
        const fatherNameFilter = document.getElementById('father-name-filter').value.toLowerCase();

        // Filter desktop table rows
        const tableRows = document.querySelectorAll('.family-row');
        tableRows.forEach(row => {
            const campusId = row.getAttribute('data-campus-id') || '';
            const fatherName = row.getAttribute('data-father-name') || '';
            
            const campusMatch = !campusFilter || campusId === campusFilter;
            const nameMatch = !fatherNameFilter || fatherName.includes(fatherNameFilter);
            
            if (campusMatch && nameMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter mobile cards
        const cards = document.querySelectorAll('.family-card');
        cards.forEach(card => {
            const campusId = card.getAttribute('data-campus-id') || '';
            const fatherName = card.getAttribute('data-father-name') || '';
            
            const campusMatch = !campusFilter || campusId === campusFilter;
            const nameMatch = !fatherNameFilter || fatherName.includes(fatherNameFilter);
            
            if (campusMatch && nameMatch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function clearFilters() {
        if (document.getElementById('campus-filter')) {
            document.getElementById('campus-filter').value = '';
        }
        document.getElementById('father-name-filter').value = '';
        filterFamilies();
    }
</script>

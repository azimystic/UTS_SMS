@model SMS.ViewModels.PayrollCreateViewModel

@{
    ViewData["Title"] = "Process Payroll";
    var monthName = new DateTime(Model.ForYear, Model.ForMonth, 1).ToString("MMMM yyyy");
    var currentMonth = DateTime.Now.Month;
    var currentYear = DateTime.Now.Year;
    var isCurrentOrFutureMonth = (Model.ForYear > currentYear) || (Model.ForYear == currentYear && Model.ForMonth >= currentMonth);
    var daysInMonth = DateTime.DaysInMonth(Model.ForYear, Model.ForMonth);
}

<!-- Apache ECharts - Offline -->
<script src="~/lib/echarts/echarts.min.js" asp-append-version="true"></script>
<!-- SweetAlert2 -->
<link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css" asp-append-version="true" />
<script src="~/lib/sweetalert2/sweetalert2.min.js" asp-append-version="true"></script>

<style>
    .card-dark {
        background: linear-gradient(135deg, #2D2D2D 0%, #1a1a1a 100%);
    }

    .input-field:focus {
        border-color: var(--primary-500, #FBBF24);
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }
    
    .swal2-popup { 
        font-size: 1rem; 
        font-family: var(--font-family, 'Inter', sans-serif); 
        border-radius: 1.5rem; 
    }
    .swal2-html-container { 
        text-align: left; 
        line-height: 1.8; 
    }
    .swal2-title { 
        font-size: 1.5rem; 
        padding: 1rem 1rem 0.5rem; 
    }
    .swal2-actions { 
        gap: 0.5rem; 
    }
</style>

<div class="min-h-screen bg-neutral-50 py-3 md:py-6">
    <div class="max-w-full mx-auto px-0">
        
        <!-- Header with Back Button -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 px-3 md:px-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-primary-800">Process Payroll</h1>
                <p class="text-neutral-600 text-sm">@monthName</p>
            </div>
            <a asp-action="Index" class="mt-3 md:mt-0 bg-gradient-primary hover:shadow-sms-lg text-white px-4 py-2 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-sms-md flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to List
            </a>
        </div>

        <!-- Employee Info Card -->
        <div class="card-gradient rounded-xl shadow-sms-md p-4 md:p-6 mb-6 hover-lift border border-primary-100 mx-3 md:mx-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 flex items-center justify-center flex-shrink-0">
                        @if (!string.IsNullOrEmpty(Model.EmployeeProfilePicture))
                        {
                            <img src="/@Model.EmployeeProfilePicture" alt="@Model.EmployeeName" class="w-full h-full rounded-xl object-cover" />
                        }
                        else
                        {
                            <i class="fas fa-user text-2xl text-white"></i>
                        }
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-primary-800">@Model.EmployeeName</h2>
                        <p class="text-neutral-600 text-sm">@Model.EmployeeRole | @Model.CampusName</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-neutral-600">Processing for</div>
                        <div class="text-xl font-bold text-primary-800">@monthName</div>
                    </div>
                </div>
            </div>
            
            @if (isCurrentOrFutureMonth)
            {
                <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 p-3 rounded-lg">
                    <p class="text-sm font-medium"><i class="fas fa-exclamation-triangle mr-2"></i>Note: You cannot process payroll for current or future months.</p>
                </div>
            }
            
            @if (Model.IsExistingRecordWithBalance)
            {
                <div class="mt-4 bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-3 rounded-lg">
                    <p class="text-sm font-medium">
                        <i class="fas fa-info-circle mr-2"></i>
                        Payroll for this month already exists with a @(Model.ExistingBalance > 0 ? "pending" : "advance") balance of <strong>₨@Math.Abs(Model.ExistingBalance).ToString("N0")</strong>. 
                        @if (Model.ExistingBalance > 0)
                        {
                            <span>You can pay the remaining balance.</span>
                        }
                        else
                        {
                            <span>The employee has received an advance payment.</span>
                        }
                    </p>
                </div>
            }
            
            <!-- Quick Stats Bar -->
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3 md:gap-4 mt-6">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-success-light flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalPresent</div>
                        <div class="text-xs text-neutral-600">Present</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-error-light flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-times-circle text-error"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalAbsent</div>
                        <div class="text-xs text-neutral-600">Absent</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-warning-light flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-clock text-warning"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalLate</div>
                        <div class="text-xs text-neutral-600">Late</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-info-light flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user-clock text-info"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalShortLeave</div>
                        <div class="text-xs text-neutral-600">Short Leave</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-calendar-minus text-yellow-600"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalLeave</div>
                        <div class="text-xs text-neutral-600">Leave</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-calendar-day text-purple-600"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.TotalHolidays</div>
                        <div class="text-xs text-neutral-600">Holidays</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-percentage text-primary-600"></i>
                    </div>
                    <div>
                        <div class="text-lg font-bold text-primary-800">@Model.AttendancePercentage%</div>
                        <div class="text-xs text-neutral-600">Attendance</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6 px-3 md:px-6">
            
            <!-- Left Column - Charts and Forms -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Attendance Comparison Pie Chart -->
                <div class="card-gradient rounded-xl shadow-sms-md p-4 md:p-6 hover-lift border border-primary-100">
                    <h3 class="text-xl font-bold text-primary-800 mb-4">Attendance Comparison (This Month)</h3>
                    <div id="attendancePieChart" style="width: 100%; height: 350px;"></div>
                </div>
                

                <!-- Attendance Calendar (Improved) -->
                <div class="card-dark rounded-xl shadow-sms-md p-4 md:p-6 hover-lift">
                    <h3 class="text-lg font-bold text-white mb-4">Attendance Calendar</h3>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs">
                        <div class="text-gray-400 font-medium py-1">S</div>
                        <div class="text-gray-400 font-medium py-1">M</div>
                        <div class="text-gray-400 font-medium py-1">T</div>
                        <div class="text-gray-400 font-medium py-1">W</div>
                        <div class="text-gray-400 font-medium py-1">T</div>
                        <div class="text-gray-400 font-medium py-1">F</div>
                        <div class="text-gray-400 font-medium py-1">S</div>

                        @{
                            var firstDayOfMonth = new DateTime(Model.ForYear, Model.ForMonth, 1);
                            var startDay = (int)firstDayOfMonth.DayOfWeek;

                            for (int i = 0; i < startDay; i++)
                            {
                                <div class="h-8"></div>
                            }

                            for (int day = 1; day <= daysInMonth; day++)
                            {
                                var currentDate = new DateTime(Model.ForYear, Model.ForMonth, day);
                                var attendance = Model.AttendanceRecords.FirstOrDefault(a => a.Date.Date == currentDate.Date);
                                var status = attendance?.Status ?? "A";
                                // Attendance Status Codes: P=Present, A=Absent, T=Late (Tardy), S=Short Leave, L=Leave, H=Holiday
                                var statusClass = status switch
                                {
                                    "P" => "bg-green-500 text-white hover:bg-green-600",
                                    "A" => "bg-red-500 text-white hover:bg-red-600",
                                    "T" => "bg-orange-500 text-white hover:bg-orange-600",  // T = Late (Tardy)
                                    "S" => "bg-blue-500 text-white hover:bg-blue-600",
                                    "L" => "bg-yellow-500 text-white hover:bg-yellow-600",
                                    "H" => "bg-purple-500 text-white hover:bg-purple-600",
                                    _ => "bg-gray-600 text-gray-300 hover:bg-gray-700"
                                };
                                var statusText = status switch
                                {
                                    "P" => "Present",
                                    "A" => "Absent",
                                    "T" => "Late",
                                    "S" => "Short Leave",
                                    "L" => "Leave",
                                    "H" => "Holiday",
                                    _ => "No Record"
                                };

                                <div class="h-8 flex items-center justify-center">
                                    <div class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-medium @statusClass cursor-pointer transition-all duration-200" 
                                         title="@statusText - @currentDate.ToString("MMM dd, yyyy")">
                                        @day
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex flex-wrap gap-2 mt-4 text-xs text-gray-300">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span>Present</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span>Absent</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-500"></span>Late</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span>Short Leave</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-500"></span>Leave</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span>Holiday</span>
                    </div>
                </div>

                <!-- Payroll History (Last 3 Months) -->
                @if (Model.PayrollHistory.Any())
                {
                    <div class="card-gradient rounded-xl shadow-sms-md p-4 md:p-6 hover-lift border border-primary-100">
                        <h3 class="text-xl font-bold text-primary-800 mb-4">Payroll History (Last 3 Months)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="text-left text-neutral-600 border-b border-primary-100">
                                        <th class="pb-3 font-medium">Month</th>
                                        <th class="pb-3 font-medium">Basic</th>
                                        <th class="pb-3 font-medium">Net</th>
                                        <th class="pb-3 font-medium">Paid</th>
                                        <th class="pb-3 font-medium">Balance</th>
                                        <th class="pb-3 font-medium">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var history in Model.PayrollHistory)
                                    {
                                        <tr class="border-b border-primary-100">
                                            <td class="py-3 font-medium text-primary-800">
                                                @history.MonthName
                                                @if (history.BalanceTransferredToNextMonth)
                                                {
                                                    <span class="ml-2 text-accent-600" title="Balance transferred to @history.TransferredToMonthName">
                                                        <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                                        </svg>
                                                        @history.TransferredToMonthName
                                                    </span>
                                                }
                                            </td>
                                            <td class="py-3 text-neutral-700">₨@history.BasicSalary.ToString("N0")</td>
                                            <td class="py-3 text-neutral-700">₨@history.NetSalary.ToString("N0")</td>
                                            <td class="py-3 text-neutral-700">₨@history.AmountPaid.ToString("N0")</td>
                                            <td class="py-3 font-semibold @{
                                                string balanceColorClass;
                                                if (history.Balance == 0)
                                                {
                                                    balanceColorClass = "text-success";
                                                }
                                                else if (history.Balance > 0)
                                                {
                                                    balanceColorClass = "text-warning";
                                                }
                                                else
                                                {
                                                    balanceColorClass = "text-info";
                                                }
                                                @balanceColorClass
                                            }">
                                                ₨@Math.Abs(history.Balance).ToString("N0")
                                            </td>
                                            <td class="py-3">
                                                <span class="px-2 py-1 rounded-full text-xs font-medium @{
                                                    string statusClass;
                                                    if (history.Status == "Paid")
                                                    {
                                                        statusClass = "bg-success-light text-success";
                                                    }
                                                    else if (history.Status == "Pending")
                                                    {
                                                        statusClass = "bg-warning-light text-warning";
                                                    }
                                                    else
                                                    {
                                                        statusClass = "bg-info-light text-info";
                                                    }
                                                    @statusClass
                                                }">
                                                    @history.Status
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
                
            </div>

            <!-- Right Column - Salary Details and Info Cards -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Salary Details Form -->
                <form asp-action="Create" method="post" id="payrollForm" class="card-dark rounded-xl shadow-sms-md p-4 md:p-6 hover-lift" data-student-fee-deduction="@Model.StudentFeeDeduction">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="bg-red-900/30 border-l-4 border-red-500 text-red-400 p-3 rounded-lg mb-6">
                            @TempData["ErrorMessage"]
                        </div>
                    }
                    <div asp-validation-summary="ModelOnly" class="bg-red-900/30 border-l-4 border-red-500 text-red-400 p-3 rounded-lg mb-6"></div>

                    <input type="hidden" asp-for="EmployeeId" />
                    <input type="hidden" asp-for="ForMonth" />
                    <input type="hidden" asp-for="ForYear" />
                    <input type="hidden" id="AmountPaid" asp-for="AmountPaid" />
                    <input type="hidden" asp-for="OnlineAccount" />
                    <input type="hidden" asp-for="TransactionReference" />
                    <input type="hidden" asp-for="PaymentDate" />

                    <h3 class="text-xl font-bold text-white mb-4">Salary Details</h3>

                    <div class="space-y-3 mb-4">
                        <!-- Basic Salary -->
                        <div>
                            <label asp-for="BasicSalary" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="BasicSalary" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg bg-gray-800 cursor-not-allowed input-field text-white" readonly />
                            </div>
                        </div>

                        <!-- Allowances -->
                        <div>
                            <label asp-for="Allowances" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="Allowances" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg bg-gray-800 cursor-not-allowed input-field text-white" readonly />
                            </div>
                        </div>

                        <!-- Deductions -->
                        <div>
                            <label asp-for="Deductions" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="Deductions" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg bg-gray-800 cursor-not-allowed input-field text-white" readonly />
                            </div>
                        </div>

                        <!-- Attendance Deduction -->
                        <div>
                            <label asp-for="AttendanceDeduction" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="AttendanceDeduction" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg input-field calculate-field text-white bg-gray-800 focus:ring-2 focus:ring-primary-400 focus:border-primary-400" />
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Based on attendance</p>
                        </div>

                        <!-- Previous Balance -->
                        <div>
                            <label asp-for="PreviousBalance" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="PreviousBalance" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg bg-gray-800 cursor-not-allowed input-field text-white" readonly />
                            </div>
                        </div>

                        <!-- Bonus -->
                        <div>
                            <label asp-for="Bonus" class="block text-sm font-medium text-gray-300 mb-1"></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="Bonus" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg input-field calculate-field text-white bg-gray-800 focus:ring-2 focus:ring-primary-400 focus:border-primary-400" value="0" />
                            </div>
                        </div>

                        <!-- Cash in Hand -->
                        <div>
                            <label asp-for="CashPaid" class="block text-sm font-medium text-gray-300 mb-1">Cash in Hand</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="CashPaid" id="CashPaid" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg input-field payment-field text-white bg-gray-800 focus:ring-2 focus:ring-primary-400 focus:border-primary-400" value="0" />
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Cash payment amount</p>
                        </div>

                        <!-- Online Paid -->
                        <div>
                            <label asp-for="OnlinePaid" class="block text-sm font-medium text-gray-300 mb-1">Online Paid</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">₨</span>
                                </div>
                                <input asp-for="OnlinePaid" id="OnlinePaid" class="pl-10 w-full px-4 py-2.5 border-2 border-gray-700 rounded-lg input-field payment-field text-white bg-gray-800 focus:ring-2 focus:ring-primary-400 focus:border-primary-400" value="0" />
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Digital/Bank transfer amount</p>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="text-center p-3 bg-blue-900/30 rounded-xl border border-blue-600">
                            <div class="text-xs font-medium text-gray-300 mb-1">Total Payable</div>
                            <div class="text-lg font-bold text-blue-400" id="totalPayable">₨0</div>
                        </div>
                        
                        @if (Model.IsEmployeeParent && Model.StudentFeeDeduction > 0)
                        {
                            <div class="text-center p-3 bg-yellow-900/30 rounded-xl border border-yellow-600">
                                <div class="text-xs font-medium text-gray-300 mb-1">Fee Deduction</div>
                                <div class="text-lg font-bold text-yellow-400" id="feeDeduction">₨@Model.StudentFeeDeduction.ToString("N0")</div>
                            </div>
                        }

                        <div class="text-center p-3 bg-green-900/30 rounded-xl border border-green-600">
                            <div class="text-xs font-medium text-gray-300 mb-1">Total Paid</div>
                            <div class="text-lg font-bold text-green-400" id="totalPaid">₨0</div>
                        </div>

                        <div class="text-center p-3 bg-red-900/30 rounded-xl border border-red-600">
                            <div class="text-xs font-medium text-gray-300 mb-1">Balance</div>
                            <div class="text-lg font-bold text-red-400" id="balance">₨0</div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-gradient-primary hover:shadow-sms-lg text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 shadow-sms-md flex items-center gap-2 @(isCurrentOrFutureMonth ? "opacity-50 cursor-not-allowed" : "")" @(isCurrentOrFutureMonth ? "disabled" : "")>
                            <i class="fas fa-check-circle"></i>
                            Process Payroll
                        </button>
                    </div>
                </form>
                
                <!-- Employee Profile Card -->
                <div class="card-gradient rounded-xl shadow-sms-md p-4 md:p-6 hover-lift border border-primary-100">
                    <div class="flex flex-col items-center mb-4">
                        <div class="w-20 h-20 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 flex items-center justify-center mb-3 flex-shrink-0">
                            @if (!string.IsNullOrEmpty(Model.EmployeeProfilePicture))
                            {
                                <img src="/@Model.EmployeeProfilePicture" alt="@Model.EmployeeName" class="w-full h-full rounded-xl object-cover" />
                            }
                            else
                            {
                                <i class="fas fa-user text-3xl text-white"></i>
                            }
                        </div>
                        <h3 class="text-lg font-bold text-primary-800 mb-1">@Model.EmployeeName</h3>
                        <p class="text-sm text-neutral-600 mb-1">@Model.EmployeeRole</p>
                        <p class="text-xs text-accent-600 font-medium">@Model.CampusName</p>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between p-3 bg-neutral-50 rounded-lg border border-primary-100">
                            <span class="text-sm text-neutral-600">Basic Salary:</span>
                            <span class="text-sm font-bold text-primary-800">₨@Model.BasicSalary.ToString("N0")</span>
                        </div>
                        <div class="flex justify-between p-3 bg-success-light rounded-lg border border-success">
                            <span class="text-sm text-neutral-600">Allowances:</span>
                            <span class="text-sm font-bold text-success">+₨@Model.Allowances.ToString("N0")</span>
                        </div>
                        <div class="flex justify-between p-3 bg-error-light rounded-lg border border-error">
                            <span class="text-sm text-neutral-600">Deductions:</span>
                            <span class="text-sm font-bold text-error">-₨@Model.Deductions.ToString("N0")</span>
                        </div>
                        <div class="flex justify-between p-3 bg-primary-100 rounded-lg border border-primary-400">
                            <span class="text-sm text-primary-700 font-medium">Gross Salary:</span>
                            <span class="text-sm font-bold text-primary-800">₨@Model.GrossSalary.ToString("N0")</span>
                        </div>
                    </div>
                </div>

                <!-- Student Fee Deductions Card (if employee is parent) -->
                @if (Model.IsEmployeeParent && Model.StudentFeeDeductions.Any())
                {
                    <div class="card-dark rounded-xl shadow-sms-md p-4 md:p-6 hover-lift">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-user-graduate mr-2 text-accent-400"></i>
                            Student Fee Deductions
                        </h3>
                        <div class="space-y-3">
                            @foreach (var deduction in Model.StudentFeeDeductions)
                            {
                                <div class="p-3 bg-gray-800 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="text-sm font-medium text-white">@deduction.StudentName</div>
                                            <div class="text-xs text-gray-400">@deduction.ClassName</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-accent-400">₨@deduction.AmountDeducted.ToString("N0")</div>
                                            <div class="text-xs text-gray-400">@deduction.PaymentMode</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <div class="flex justify-between p-3 bg-accent-900/20 rounded-lg mt-3 border border-accent-700">
                                <span class="text-sm font-medium text-white">Total Fee Deduction:</span>
                                <span class="text-sm font-bold text-accent-400">₨@Model.StudentFeeDeduction.ToString("N0")</span>
                            </div>
                        </div>
                    </div>
                }

                <!-- Salary Deductions Card (from database) -->
                @if (Model.SalaryDeductions.Any())
                {
                    <div class="card-dark rounded-xl shadow-sms-md p-4 md:p-6 hover-lift">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-money-bill-wave mr-2 text-accent-400"></i>
                            Salary Deductions
                        </h3>
                        <div class="space-y-3">
                            @foreach (var deduction in Model.SalaryDeductions)
                            {
                                <div class="p-3 bg-gray-800 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="text-sm font-medium text-white">@deduction.StudentName</div>
                                            <div class="text-xs text-gray-400">@deduction.ClassName</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-red-400">-₨@deduction.AmountDeducted.ToString("N0")</div>
                                            <div class="text-xs text-gray-400">@deduction.DeductionDate.ToString("dd MMM yyyy")</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <div class="flex justify-between p-3 bg-red-900/30 rounded-lg mt-3 border border-red-700">
                                <span class="text-sm font-medium text-white">Total Salary Deductions:</span>
                                <span class="text-sm font-bold text-red-400">-₨@Model.TotalSalaryDeductions.ToString("N0")</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Attendance Pie Chart
        initAttendanceChart();
        
        // Initialize Performance Bar Chart (if teacher)
        initPerformanceBarChart();
        
        // Set today's date in hidden field
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('[name="PaymentDate"]').value = today;
        
        // Calculate totals function
        function calculateTotals() {
            const basicSalary = parseFloat(document.getElementById("BasicSalary").value) || 0;
            const allowances = parseFloat(document.getElementById("Allowances").value) || 0;
            const deductions = parseFloat(document.getElementById("Deductions").value) || 0;
            const attendanceDeduction = parseFloat(document.getElementById("AttendanceDeduction").value) || 0;
            const previousBalance = parseFloat(document.getElementById("PreviousBalance").value) || 0;
            const bonus = parseFloat(document.getElementById("Bonus").value) || 0;
            // Get student fee deduction from data attribute on the form
            const studentFeeDeduction = parseFloat(document.querySelector('form[data-student-fee-deduction]')?.dataset.studentFeeDeduction) || 0;
            
            // Check if this is an existing payroll with balance
            const isExistingPayroll = @Model.IsExistingRecordWithBalance.ToString().ToLower();
            const existingBalance = @Math.Abs(Model.ExistingBalance);

            let totalPayable = 0;
            
            if (isExistingPayroll) {
                // For existing payroll, only show the remaining balance as payable
                totalPayable = existingBalance;
            } else {
                // For new payroll, calculate full payable amount
                totalPayable = basicSalary + allowances - deductions - attendanceDeduction - studentFeeDeduction + bonus + previousBalance;
            }

            // Update UI
            document.getElementById("totalPayable").innerText = '₨' + totalPayable.toLocaleString();
            
            // Calculate total paid from CashPaid and OnlinePaid
            const cashPaid = parseFloat(document.getElementById("CashPaid").value) || 0;
            const onlinePaid = parseFloat(document.getElementById("OnlinePaid").value) || 0;
            const totalPaid = cashPaid + onlinePaid;
            
            // Set AmountPaid to sum of CashPaid and OnlinePaid
            document.getElementById("AmountPaid").value = totalPaid;
            document.getElementById("totalPaid").innerText = '₨' + totalPaid.toLocaleString();
            
            // Calculate balance
            const balance = totalPayable - totalPaid;
            document.getElementById("balance").innerText = '₨' + balance.toLocaleString();
            // Update color based on balance
            if (balance === 0) {
                document.getElementById("balance").className = 'text-lg font-bold text-green-400';
            } else if (balance > 0) {
                document.getElementById("balance").className = 'text-lg font-bold text-red-400';
            } else {
                document.getElementById("balance").className = 'text-lg font-bold text-yellow-400';
            }
        }

        // Add event listeners to all calculate fields
        document.querySelectorAll('.calculate-field').forEach(el => {
            el.addEventListener('input', calculateTotals);
        });
        
        // Add event listeners to payment fields
        document.querySelectorAll('.payment-field').forEach(el => {
            el.addEventListener('input', calculateTotals);
        });

        // Initialize calculation on page load
        calculateTotals();
        
        // Form submission validation with SweetAlert2
        let isConfirmed = false;
        const payrollForm = document.getElementById('payrollForm');
        
        if (payrollForm) {
            payrollForm.addEventListener('submit', function(e) {
                if (isConfirmed) return true;
                
                e.preventDefault();
                e.stopImmediatePropagation();
                
                // Get current values
                const basicSalary = parseFloat(document.getElementById("BasicSalary").value) || 0;
                const allowances = parseFloat(document.getElementById("Allowances").value) || 0;
                const deductions = parseFloat(document.getElementById("Deductions").value) || 0;
                const attendanceDeduction = parseFloat(document.getElementById("AttendanceDeduction").value) || 0;
                const previousBalance = parseFloat(document.getElementById("PreviousBalance").value) || 0;
                const bonus = parseFloat(document.getElementById("Bonus").value) || 0;
                const studentFeeDeduction = parseFloat(document.querySelector('form[data-student-fee-deduction]')?.dataset.studentFeeDeduction) || 0;
                
                // Check if this is an existing payroll with balance
                const isExistingPayroll = @Model.IsExistingRecordWithBalance.ToString().ToLower();
                const existingBalance = @Math.Abs(Model.ExistingBalance);
                
                let totalPayable = 0;
                
                if (isExistingPayroll) {
                    // For existing payroll, only show the remaining balance as payable
                    totalPayable = existingBalance;
                } else {
                    // For new payroll, calculate full payable amount
                    totalPayable = basicSalary + allowances - deductions - attendanceDeduction - studentFeeDeduction + bonus + previousBalance;
                }
                
                const cashPaid = parseFloat(document.getElementById("CashPaid").value) || 0;
                const onlinePaid = parseFloat(document.getElementById("OnlinePaid").value) || 0;
                const totalPaid = cashPaid + onlinePaid;
                
                // Validation 1: Check if paying more than payable
                if (totalPaid > totalPayable) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Payment Exceeds Payable',
                        text: `Total payment (₨${totalPaid.toLocaleString()}) cannot exceed Total Payable (₨${totalPayable.toLocaleString()}).`,
                        confirmButtonColor: '#FBBF24',
                        confirmButtonText: 'OK'
                    });
                    return false;
                }
                
                // Prepare confirmation message
                let difference = totalPaid - totalPayable;
                let confirmMessage = '', iconType = 'question';
                
                if (difference > 0) {
                    confirmMessage = `<div style="text-align: left;"><p><strong>Total Payable:</strong> <span style="float: right;">₨${totalPayable.toLocaleString()}</span></p><p><strong>Total Paid:</strong> <span style="float: right;">₨${totalPaid.toLocaleString()}</span></p><hr style="margin: 10px 0;"><p><strong style="color: #3b82f6;">Advance Amount:</strong> <span style="color: #3b82f6; float: right; font-weight: bold;">₨${Math.abs(difference).toLocaleString()}</span></p><p style="margin-top: 15px; color: #f97316;"><strong>⚠️ Paying MORE than required.</strong></p></div>`;
                    iconType = 'info';
                } else if (difference < 0) {
                    confirmMessage = `<div style="text-align: left;"><p><strong>Total Payable:</strong> <span style="float: right;">₨${totalPayable.toLocaleString()}</span></p><p><strong>Total Paid:</strong> <span style="float: right;">₨${totalPaid.toLocaleString()}</span></p><hr style="margin: 10px 0;"><p><strong style="color: #ef4444;">Remaining Balance:</strong> <span style="color: #ef4444; float: right; font-weight: bold;">₨${Math.abs(difference).toLocaleString()}</span></p><p style="margin-top: 15px; color: #f97316;"><strong>⚠️ Paying LESS than required.</strong></p></div>`;
                    iconType = 'warning';
                } else {
                    confirmMessage = `<div style="text-align: left;"><p><strong>Total Payable:</strong> <span style="float: right;">₨${totalPayable.toLocaleString()}</span></p><p><strong>Total Paid:</strong> <span style="float: right;">₨${totalPaid.toLocaleString()}</span></p><hr style="margin: 10px 0;"><p style="margin-top: 15px; color: #10b981;"><strong>✓ Payment amount matches exactly.</strong></p></div>`;
                    iconType = 'success';
                }
                
                const formEl = this;
                Swal.fire({
                    title: 'Confirm Payroll',
                    html: confirmMessage,
                    icon: iconType,
                    showCancelButton: true,
                    confirmButtonColor: '#FBBF24',
                    cancelButtonColor: '#6B7280',
                    confirmButtonText: '<i class="fas fa-check"></i> Confirm',
                    cancelButtonText: 'Cancel',
                    allowOutsideClick: false,
                    width: '450px'
                }).then((result) => {
                    if (result.isConfirmed) {
                        isConfirmed = true;
                        formEl.submit();
                    }
                });
                
                return false;
            });
        }
    });
    
    // Initialize Attendance Pie Chart (This Month Only)
    function initAttendanceChart() {
        const chartDom = document.getElementById('attendancePieChart');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        
        // Get this month's attendance data
        const totalPresent = @Model.TotalPresent;
        const totalAbsent = @Model.TotalAbsent;
        const totalLate = @Model.TotalLate;
        const totalShortLeave = @Model.TotalShortLeave;
        const totalLeave = @Model.TotalLeave;
        const totalHolidays = @Model.TotalHolidays;
        
        // Calculate working days (all days minus Sundays and holidays)
        const daysInMonth = @DateTime.DaysInMonth(Model.ForYear, Model.ForMonth);
        const totalWorkingDays = daysInMonth - @Model.TotalHolidays - Math.floor(daysInMonth / 7); // Approximate Sundays
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'horizontal',
                bottom: 0,
                textStyle: { fontSize: 11 }
            },
            series: [
                {
                    name: 'Attendance',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {c}\n({d}%)',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: true
                    },
                    data: [
                        { value: totalPresent, name: 'Present', itemStyle: { color: '#4CAF50' } },
                        { value: totalAbsent, name: 'Absent', itemStyle: { color: '#ef4444' } },
                        { value: totalLate, name: 'Late', itemStyle: { color: '#f97316' } },
                        { value: totalShortLeave, name: 'Short Leave', itemStyle: { color: '#3b82f6' } },
                        { value: totalLeave, name: 'Leave', itemStyle: { color: '#eab308' } }
                    ]
                }
            ]
        };
        
        myChart.setOption(option);
        
        // Make chart responsive
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }
    
    // Initialize Performance Bar Chart for Teachers
    function initPerformanceBarChart() {
        const chartDom = document.getElementById('performanceBarChart');
        if (!chartDom) return; // Not a teacher or no performance data
        
        const myChart = echarts.init(chartDom);
        
        // Get performance data from server
        @if (Model.EmployeeRole == "Teacher" && Model.TeacherPerformance != null)
        {
            <text>
            const classPerformances = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TeacherPerformance.ClassPerformances, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
            
            // Prepare data for the chart
            const classes = classPerformances.map(cp => `${cp.className}-${cp.sectionName}`);
            const classAverages = classPerformances.map(cp => cp.classAverage);
            
            // Prepare subject data (create series for each unique subject)
            const allSubjects = new Set();
            classPerformances.forEach(cp => {
                cp.subjectAverages.forEach(sa => allSubjects.add(sa.subjectName));
            });
            
            const subjectColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
            const series = [];
            let colorIndex = 0;
            
            allSubjects.forEach(subjectName => {
                const data = classPerformances.map(cp => {
                    const subjectAvg = cp.subjectAverages.find(sa => sa.subjectName === subjectName);
                    return subjectAvg ? subjectAvg.average : 0;
                });
                
                series.push({
                    name: subjectName,
                    type: 'bar',
                    data: data,
                    itemStyle: { 
                        color: subjectColors[colorIndex % subjectColors.length],
                        borderRadius: [5, 5, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: '{c}%',
                        fontSize: 10,
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        focus: 'series'
                    }
                });
                colorIndex++;
            });
            
            // Add class average line
            series.push({
                name: 'Class Average',
                type: 'line',
                data: classAverages,
                itemStyle: { 
                    color: '#1f2937',
                    borderWidth: 2
                },
                lineStyle: {
                    width: 3,
                    type: 'dashed'
                },
                label: {
                    show: true,
                    position: 'top',
                    formatter: function(params) {
                        return 'Avg: ' + params.value.toFixed(1) + '%';
                    },
                    fontSize: 11,
                    fontWeight: 'bold',
                    color: '#1f2937',
                    backgroundColor: '#fff',
                    padding: [2, 4],
                    borderRadius: 3
                },
                symbol: 'circle',
                symbolSize: 8,
                emphasis: {
                    focus: 'series'
                },
                z: 10
            });
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = `<div style="font-weight: bold; margin-bottom: 5px;">${params[0].axisValue}</div>`;
                        params.forEach(p => {
                            if (p.seriesName === 'Class Average') {
                                result += `<div style="border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px;">`;
                            }
                            result += `${p.marker} ${p.seriesName}: <b>${p.value.toFixed(1)}%</b><br/>`;
                        });
                        return result + '</div>';
                    }
                },
                legend: {
                    data: Array.from(allSubjects).concat(['Class Average']),
                    bottom: 0,
                    textStyle: { fontSize: 10 },
                    type: 'scroll'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: classes,
                    axisLabel: {
                        fontSize: 11,
                        fontWeight: 'bold',
                        rotate: 0,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Percentage',
                    axisLabel: {
                        formatter: '{value}%',
                        fontSize: 10
                    },
                    min: 0,
                    max: 100
                },
                series: series
            };
            
            myChart.setOption(option);
            
            // Make chart responsive
            window.addEventListener('resize', function() {
                myChart.resize();
            });
            
            // Exam category filter functionality
            const examCategoryFilter = document.getElementById('examCategoryFilter');
            if (examCategoryFilter) {
                examCategoryFilter.addEventListener('change', function() {
                    // TODO: Implement filtering by exam category
                    // This would require filtering the exam results on the server side
                    console.log('Filter by category:', this.value);
                });
            }
            </text>
        }
    }
</script>

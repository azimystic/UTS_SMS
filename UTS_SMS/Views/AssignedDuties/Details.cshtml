@model UTS_SMS.Models.AssignedDuty

@{
    ViewData["Title"] = "Duty Details";
    var isOverdue = Model.DueDate < DateTime.Now && Model.ProgressPercentage < 100;
    var isLocked = Model.Status == "Cancelled" || Model.Status == "Overdue" || Model.Status == "Completed";
    var canUpdate = (ViewBag.IsAssignedEmployee == true || ViewBag.IsAssignedStudent == true) && !isLocked;
}
<link rel="stylesheet" href="~/lib/sweetalert2/sweetalert2.min.css" />
<div class="min-h-screen  p-4 md:p-6">
    <div class="w-full max-w-full">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-primary-800"> Duty Progress Tracker</h1>
                <p class="text-neutral-600 mt-1">@Model.DutyTitle</p>
            </div>
            <a asp-action="Index" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl transition-all duration-300 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to List
            </a>
        </div>

        <!-- Status and Priority Badges -->
        <div class="flex flex-wrap gap-3 mb-6">
            @{
                var statusClass = Model.Status switch
                {
                    "Assigned" => "bg-primary-100 text-primary-800",
                    "In Progress" => "bg-warning-light text-yellow-800",
                    "Completed" => "bg-success-light text-success",
                    "Overdue" => "bg-error-light text-error",
                    "Cancelled" => "bg-neutral-100 text-primary-800",
                    _ => "bg-neutral-100 text-primary-800"
                };
                
                var priorityClass = Model.Priority switch
                {
                    "High" => "bg-error-light text-error",
                    "Medium" => "bg-warning-light text-yellow-800",
                    "Low" => "bg-success-light text-success",
                    _ => "bg-neutral-100 text-primary-800"
                };
            }
            <span id="status-badge" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium @statusClass">
                @Model.Status
            </span>
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium @priorityClass">
                @Model.Priority Priority
            </span>
            @if (isOverdue)
            {
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-error-light text-error">
                     Overdue by @((DateTime.Now - Model.DueDate).Days) days
                </span>
            }
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Progress Card -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sms-lg overflow-hidden mb-6">
                    <div class="px-6 py-4 bg-gradient-to-r from-primary-600 to-blue-700">
                        <h2 class="text-xl font-semibold text-white"> Progress Overview</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-lg font-medium text-neutral-700">Completion Progress</span>
                            <span id="progress-value" class="text-2xl font-bold text-primary-800">@Model.ProgressPercentage%</span>
                        </div>
                        <div class="w-full bg-primary-100 rounded-full h-4 mb-6">
                            <div id="progress-bar" class="bg-gradient-primary h-4 rounded-full transition-all duration-300" style="width: @Model.ProgressPercentage%"></div>
                        </div>
                        
                        @* Progress Slider for assigned users *@
                        @if (canUpdate)
                        {
                            <div class="mt-6 p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border-2 border-primary-200">
                                <label for="progress-slider" class="block text-base font-semibold text-primary-800 mb-3">
                                      Update Your Progress
                                </label>
                                <input type="range" id="progress-slider" min="0" max="100" value="@Model.ProgressPercentage" step="5"
                                       class="w-full h-3 bg-primary-200 rounded-lg appearance-none cursor-pointer accent-primary-600 mb-3">
                                <div class="flex justify-between text-xs text-neutral-600 mb-4">
                                    <span>0%</span>
                                    <span>25%</span>
                                    <span>50%</span>
                                    <span>75%</span>
                                    <span>100%</span>
                                </div>
                                <button id="saveProgress" class="w-full bg-gradient-primary hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
                                      Save Progress
                                </button>
                            </div>
                        }
                        else if (isLocked)
                        {
                            <div class="mt-6 p-4 bg-neutral-100 rounded-lg border border-neutral-300">
                                <p class="text-neutral-600 text-center">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                    Progress updates are locked for @Model.Status.ToLower() duties.
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="mt-6 p-4 bg-neutral-100 rounded-lg border border-neutral-300">
                                <p class="text-neutral-600 text-center">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    You do not have permission to update this duty's progress.
                                </p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Main Details Card -->
                <div class="bg-white rounded-2xl shadow-sms-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-green-600 to-green-700">
                        <h2 class="text-xl font-semibold text-white"> Duty Information</h2>
                    </div>
                    
                    <div class="p-6">
                        <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                            <div class="md:col-span-2">
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Duty Title</dt>
                                <dd class="text-lg text-primary-800 font-semibold">@Model.DutyTitle</dd>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(Model.Description))
                            {
                                <div class="md:col-span-2">
                                    <dt class="text-sm font-medium text-neutral-700 mb-1">Description</dt>
                                    <dd class="text-base text-primary-800 bg-neutral-50 p-4 rounded-lg">@Model.Description</dd>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(Model.Instructions))
                            {
                                <div class="md:col-span-2">
                                    <dt class="text-sm font-medium text-neutral-700 mb-1">Instructions</dt>
                                    <dd class="text-base text-primary-800 bg-warning-light p-4 rounded-lg border-l-4 border-yellow-400">@Model.Instructions</dd>
                                </div>
                            }
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Assigned Employee</dt>
                                <dd class="text-base text-primary-800">@(Model.Employee?.FullName ?? "No Employee Assigned")</dd>
                            </div>
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Campus</dt>
                                <dd class="text-base text-primary-800">@Model.Campus?.Name</dd>
                            </div>
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Start Date</dt>
                                <dd class="text-base text-primary-800">@Model.StartDate.ToString("MMMM dd, yyyy")</dd>
                            </div>
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Due Date</dt>
                                <dd class="text-base text-primary-800 font-semibold">@Model.DueDate.ToString("MMMM dd, yyyy")</dd>
                            </div>
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Assigned By</dt>
                                <dd class="text-base text-primary-800">@(Model.AssignedBy ?? "N/A")</dd>
                            </div>
                            
                            <div>
                                <dt class="text-sm font-medium text-neutral-700 mb-1">Assigned Date</dt>
                                <dd class="text-base text-primary-800">@Model.AssignedDate.ToString("MMMM dd, yyyy")</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Right Column: Assigned Students & Timeline -->
            <div class="lg:col-span-1">
                @if (Model.AssignedStudents?.Any() == true)
                {
                    <div class="bg-white rounded-2xl shadow-sms-lg overflow-hidden mb-6">
                        <div class="px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700">
                            <h2 class="text-xl font-semibold text-white">  Assigned Students</h2>
                        </div>
                        
                        <div class="p-6">
                            <div class="space-y-3">
                                @foreach (var assignedStudent in Model.AssignedStudents.Where(ads => ads.IsActive))
                                {
                                    <div class="flex items-center justify-between p-4 bg-neutral-50 rounded-lg hover:bg-primary-50 transition-colors">
                                        <div class="flex-1">
                                            <div class="font-medium text-primary-800">@assignedStudent.Student?.StudentName</div>
                                            <div class="text-sm text-neutral-600">@assignedStudent.Student?.ClassObj?.Name - @assignedStudent.Student?.SectionObj?.Name</div>
                                        </div>
                                        <div class="text-right ml-4">
                                            @{
                                                var studentStatusClass = assignedStudent.Status switch
                                                {
                                                    "Assigned" => "bg-primary-100 text-primary-800",
                                                    "In Progress" => "bg-warning-light text-yellow-800",
                                                    "Completed" => "bg-success-light text-success",
                                                    _ => "bg-neutral-100 text-primary-800"
                                                };
                                            }
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium @studentStatusClass">
                                                @assignedStudent.Status
                                            </span>
                                            @if (assignedStudent.ProgressPercentage > 0)
                                            {
                                                <div class="text-xs text-neutral-500 mt-1">@assignedStudent.ProgressPercentage%</div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Timeline Card -->
                <div class="bg-white rounded-2xl shadow-sms-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-orange-600 to-orange-700">
                        <h2 class="text-xl font-semibold text-black"> Timeline</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-neutral-700">Created</p>
                                    <p class="text-sm text-neutral-600">@Model.AssignedDate.ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>

                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-neutral-700">Start Date</p>
                                    <p class="text-sm text-neutral-600">@Model.StartDate.ToString("MMM dd, yyyy")</p>
                                </div>
                            </div>

                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 @(isOverdue ? "bg-error-light" : "bg-green-100") rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 @(isOverdue ? "text-error" : "text-green-600")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-neutral-700">Due Date</p>
                                    <p class="text-sm text-neutral-600">@Model.DueDate.ToString("MMM dd, yyyy")</p>
                                    @if (Model.DueDate > DateTime.Now)
                                    {
                                        <p class="text-xs text-success mt-1">@((Model.DueDate - DateTime.Now).Days) days remaining</p>
                                    }
                                </div>
                            </div>

                            @if (Model.Status == "Completed" && Model.CompletedDate.HasValue)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-10 h-10 bg-success-light rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-success">Completed</p>
                                        <p class="text-sm text-neutral-600">@Model.CompletedDate.Value.ToString("MMM dd, yyyy")</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

   
    
    


    <script src="~/lib/sweetalert2/sweetalert2.min.js"></script>
    <script>
        @if (canUpdate)
        {
            <text>
            const progressSlider = document.getElementById('progress-slider');
            const progressValue = document.getElementById('progress-value');
            const progressBar = document.getElementById('progress-bar');
            const saveButton = document.getElementById('saveProgress');

            // Update display when slider moves
            progressSlider.addEventListener('input', function() {
                progressValue.textContent = this.value + '%';
                progressBar.style.width = this.value + '%';
            });

            // Save progress
            saveButton.addEventListener('click', async function() {
                const newProgress = parseInt(progressSlider.value);
                
                try {
                    const response = await fetch("/AssignedDuties/UpdateProgress", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: `id=@Model.Id&progressPercentage=${newProgress}`
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Update status badge if duty is completed
                        if (result.status === "Completed") {
                            const statusBadge = document.getElementById("status-badge");
                            statusBadge.className = "inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-success-light text-success";
                            statusBadge.textContent = "Completed";
                            
                            // Show success message
                            await Swal.fire({
                                title: 'Congratulations!',
                                text: 'Duty marked as completed with 100% progress!',
                                icon: 'success',
                                confirmButtonColor: '#10b981'
                            });
                            
                            // Reload page to show updated state
                            window.location.reload();
                        } else if (result.status === "In Progress") {
                            const statusBadge = document.getElementById("status-badge");
                            statusBadge.className = "inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-warning-light text-yellow-800";
                            statusBadge.textContent = "In Progress";
                            
                            await Swal.fire({
                                title: 'Progress Updated!',
                                text: result.message,
                                icon: 'success',
                                confirmButtonColor: '#10b981',
                                timer: 2000
                            });
                        } else {
                            await Swal.fire({
                                title: 'Progress Updated!',
                                text: result.message,
                                icon: 'success',
                                confirmButtonColor: '#10b981',
                                timer: 2000
                            });
                        }
                    } else {
                        await Swal.fire({
                            title: 'Error!',
                            text: result.message,
                            icon: 'error',
                            confirmButtonColor: '#ef4444'
                        });
                        
                        // Reset slider to original value
                        progressSlider.value = @Model.ProgressPercentage;
                        progressValue.textContent = '@Model.ProgressPercentage%';
                        progressBar.style.width = '@Model.ProgressPercentage%';
                    }
                } catch (error) {
                    console.error("Error updating progress:", error);
                    await Swal.fire({
                        title: 'Error!',
                        text: 'Failed to update progress. Please try again.',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                    
                    // Reset slider to original value
                    progressSlider.value = @Model.ProgressPercentage;
                    progressValue.textContent = '@Model.ProgressPercentage%';
                    progressBar.style.width = '@Model.ProgressPercentage%';
                }
            });
            </text>
        }
    </script>


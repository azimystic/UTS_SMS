@using UTS_SMS.Models
@model IEnumerable<UTS_SMS.Models.TeacherPerformance>
@using System.Globalization

@{
    ViewData["Title"] = "Teacher of the Month - Performance Rankings";

    // Normalize typed values from ViewBag to avoid runtime conversions/FormatException.
    int currentMonth = ViewBag.CurrentMonth != null ? (int)ViewBag.CurrentMonth : DateTime.Now.Month;
    int currentYear = ViewBag.CurrentYear != null ? (int)ViewBag.CurrentYear : DateTime.Now.Year;

    var topPerformers = (ViewBag.TopPerformers as List<UTS_SMS.Models.TeacherPerformance>) ?? new List<UTS_SMS.Models.TeacherPerformance>();
}

<div class="min-h-screen bg-gradient-subtle p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-primary-800 flex items-center">
                    🏆 Teacher of the Month
                </h1>
                <p class="text-neutral-600 mt-2">Performance rankings based on comprehensive evaluation criteria</p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 mt-4 lg:mt-0">
                <a asp-action="Calculate" asp-route-month="@currentMonth" asp-route-year="@currentYear"
                   class="bg-success hover:bg-green-700 text-white px-4 py-2 rounded-xl transition-all duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    Calculate Performance
                </a>
            </div>
        </div>

        <!-- Month/Year Filter -->
        <div class="bg-white rounded-2xl shadow-sms-lg p-6 mb-6">
            <form method="get" class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Month</label>
                    <select name="month" class="w-full px-4 py-3 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400">
                        @for (int i = 1; i <= 12; i++)
                        {
                            var monthName = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i);
                            var isSelected = (i == currentMonth);
                            <option value="@i" selected="@(isSelected ? "selected" : null)">@monthName</option>
                        }
                    </select>
                </div>

                <div class="flex-1">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Year</label>
                    <select name="year" class="w-full px-4 py-3 border border-primary-200 rounded-lg focus:ring-2 focus:ring-primary-400 focus:border-primary-400">
                        @for (int i = DateTime.Now.Year; i >= DateTime.Now.Year - 5; i--)
                        {
                            var isSelected = (i == currentYear);
                            <option value="@i" selected="@(isSelected ? "selected" : null)">@i</option>
                        }
                    </select>
                </div>

                <button type="submit" class="bg-gradient-primary hover:bg-primary-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                    Filter
                </button>
            </form>
        </div>

        @if (topPerformers.Any())
        {
            <!-- Top 3 Performers -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                @for (int i = 0; i < topPerformers.Count && i < 3; i++)
                {
                    var performer = topPerformers[i];
                    var rankClass = i == 0 ? "bg-gradient-to-br from-yellow-400 to-yellow-600" :
                    i == 1 ? "bg-gradient-to-br from-gray-300 to-gray-500" :
                    "bg-gradient-to-br from-orange-400 to-orange-600";
                    var rankIcon = i == 0 ? "🥇" : i == 1 ? "🥈" : "🥉";

                    <div class="@rankClass text-white rounded-2xl shadow-sms-xl p-6 transform hover:scale-105 transition-all duration-300">
                        <div class="text-center">
                            <div class="text-4xl mb-2">@rankIcon</div>
                            <h3 class="text-xl font-bold">@performer.Teacher?.FullName</h3>
                            <p class="text-sm opacity-90 mb-4">@performer.Campus?.Name</p>
                            <div class="bg-white bg-opacity-20 rounded-xl p-4">
                                <div class="text-3xl font-bold">@performer.TotalScore.ToString("F2")</div>
                                <div class="text-sm opacity-90">out of 20.0</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Performance Details Table -->
        <div class="bg-white rounded-2xl shadow-sms-lg overflow-hidden">
            <div class="px-6 py-4 bg-neutral-50 border-b border-primary-100">
                <h2 class="text-xl font-semibold text-primary-800">All Teacher Performances</h2>
                <p class="text-sm text-neutral-600 mt-1">Detailed breakdown of performance scores</p>
            </div>

            @if (Model != null && Model.Any())
            {
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-primary-100">
                        <thead class="bg-neutral-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Teacher</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Campus</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Attendance (3.5)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Punctuality (2.5)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Tests (5.5)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Survey (6)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Return (1.5)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Quality (1)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-primary-100">
                            @{
                                int rank = 1;
                            }
                            @foreach (var performance in Model.OrderByDescending(p => p.TotalScore))
                            {
                                <tr class="hover:bg-neutral-50 transition-colors duration-200">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full @(rank <= 3 ? "bg-warning-light text-yellow-800" : "bg-neutral-100 text-primary-800") font-semibold text-sm">
                                            @rank
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-primary-800">@performance.Teacher?.FullName</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">
                                        @performance.Campus?.Name
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.AttendanceScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.AttendedDays/@performance.TotalWorkingDays days</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.PunctualityScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.OnTimeDays on-time</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.TestAverageScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.AverageTestMarks.ToString("F1")% avg</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.SurveyScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.PositiveSurveyResponses/@performance.TotalSurveyResponses positive</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.TestReturnScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.TestsReturnedOnTime/@performance.TotalTestsToReturn on-time</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-primary-800">@performance.CheckingQualityScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">@performance.BetterCheckingCount good+</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-lg font-bold text-primary-600">@performance.TotalScore.ToString("F2")</div>
                                        <div class="text-xs text-neutral-500">/ 20.0</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a asp-action="Details" asp-route-id="@performance.Id"
                                           class="text-info hover:text-indigo-900">View Details</a>
                                    </td>
                                </tr>
                                rank++;
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="p-12 text-center">
                    <div class="text-6xl mb-4">📊</div>
                    <h3 class="text-lg font-medium text-primary-800 mb-2">No Performance Data Available</h3>
                    <p class="text-neutral-600 mb-6">
                        Calculate teacher performances for @CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(currentMonth) @currentYear to see rankings.
                    </p>
                    <a asp-action="Calculate" asp-route-month="@currentMonth" asp-route-year="@currentYear"
                       class="bg-gradient-primary hover:bg-primary-700 text-white px-6 py-3 rounded-lg transition-all duration-300">
                        Calculate Now
                    </a>
                </div>
            }
        </div>

        <!-- Performance Criteria Info -->
        <div class="bg-primary-50 rounded-2xl p-6 mt-6">
            <h3 class="text-lg font-semibold text-primary-800 mb-4">📋 Performance Evaluation Criteria</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Monthly Attendance (3.5 marks)</div>
                    <p class="text-neutral-600 mt-1">Based on working days (excluding Sundays & holidays)</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Punctuality (2.5 marks)</div>
                    <p class="text-neutral-600 mt-1">On-time arrival within 15 min (late = absent)</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Test Average (5.5 marks)</div>
                    <p class="text-neutral-600 mt-1">Average test results (full marks if no tests)</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Survey Score (6 marks)</div>
                    <p class="text-neutral-600 mt-1">Student feedback questionnaire responses</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Test Return (1.5 marks)</div>
                    <p class="text-neutral-600 mt-1">Timely return of papers (full marks if no tests)</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="font-medium text-primary-800">Checking Quality (1 mark)</div>
                    <p class="text-neutral-600 mt-1">Quality assessment (full marks if no tests)</p>
                </div>
            </div>
        </div>
    </div>
</div>
